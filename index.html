<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Temukan rumah kontrakan" />
    <meta name="keywords" content="sewa kontrakan rumah, ruko, gedung, apartemen" />
    <meta name="author" content="kontrak yuk" />
    <title>Cari dan Sewa Kontrakan Secara Online di KontrakYuk</title>
    <link rel="icon" href="asset/logo.png" />
    <link rel="stylesheet" href="asset/leaflet.css" />

    <link rel="stylesheet" href="asset/MarkerCluster.css" />
    <link rel="stylesheet" href="asset/MarkerCluster.Default.css" />

    <!-- Add the tailwind.css if you want default styling -->
    <link rel="stylesheet" type="text/css" href="asset/tailwind.css" />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      .swal2-backdrop-show {
        z-index: 100000;
      }

      #text-info-kontrakan-swal > * {
        padding-bottom: 0.5rem;
      }

      #text-info-kontrakan-swal table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
        background: #f8f5f2;
        color: #3a3226;
        border-radius: 8px;
        overflow: hidden;
        font-family: "Noto Sans JP", sans-serif;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      #text-info-kontrakan-swal table thead {
        background: #e8e0d9;
      }

      #text-info-kontrakan-swal table th {
        padding: 12px 16px;
        text-align: left;
        font-weight: bold;
        border-bottom: 1px solid #d6ccc2;
      }

      #text-info-kontrakan-swal table td {
        padding: 12px 16px;
        border-bottom: 1px solid #e8e0d9;
      }

      #text-info-kontrakan-swal table tr:last-child td {
        border-bottom: none;
      }

      /* Alignment sesuai markdown */
      #text-info-kontrakan-swal table td[align="right"],
      #text-info-kontrakan-swal table th[align="right"] {
        text-align: right;
      }

      #text-info-kontrakan-swal table td[align="center"],
      #text-info-kontrakan-swal table th[align="center"] {
        text-align: center;
      }

      /* Style untuk link dalam tabel */
      #text-info-kontrakan-swal table a {
        color: #6b7b8e;
        text-decoration: underline;
        transition: color 0.2s;
      }

      #text-info-kontrakan-swal table a:hover {
        color: #3a3226;
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <!-- Open Menu Sidebar -->
    <div id="open-sidebar-menu" class="fixed left-0 top-0 z-[1200] flex h-fit w-20 flex-col items-center overflow-y-scroll py-4">
      <!-- Ikon Burger Menu -->
      <button id="open-sidebar-menu-button" class="relative z-10 cursor-pointer rounded-full border border-gray-300 bg-white p-2 shadow-md dark:border-gray-500 dark:bg-gray-800">
        <svg class="w-7 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 6H20M4 12H20M4 18H20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    </div>

    <!-- Menu Sidebar -->
    <div id="sidebar-menu" class="border-e-1 fixed left-0 top-0 z-[1200] flex hidden h-full w-20 flex-col items-center overflow-y-scroll border-gray-200 bg-white py-4 md:flex dark:border-gray-700 dark:bg-gray-800">
      <!-- Tombol sembunyikan sidebar -->
      <button id="hide-sidebar-button" class="flex cursor-pointer flex-col items-center p-2 pb-6 text-center text-gray-600">
        <svg class="w-7 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 6H20M4 12H20M4 18H20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>

      <!-- Garis pemisah -->
      <div class="border-t-1 w-full border-dashed border-gray-300 dark:border-gray-400"></div>

      <!-- kumpulan fitur -->
      <div class="flex w-full flex-col gap-6 overflow-y-scroll py-4">
        <!-- Ikon Brand -->
        <button id="sidebar-menu-button-open-about-us" class="relative flex cursor-pointer flex-col items-center gap-1 text-center text-gray-500">
          <div class="relative">
            <svg class="w-5 stroke-gray-500 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.36407 12.9579C1.98463 10.3208 1.79491 9.00229 2.33537 7.87495C2.87583 6.7476 4.02619 6.06234 6.32691 4.69181L7.71175 3.86687C9.80104 2.62229 10.8457 2 12 2C13.1543 2 14.199 2.62229 16.2882 3.86687L17.6731 4.69181C19.9738 6.06234 21.1242 6.7476 21.6646 7.87495C22.2051 9.00229 22.0154 10.3208 21.6359 12.9579L21.3572 14.8952C20.8697 18.2827 20.626 19.9764 19.451 20.9882C18.2759 22 16.5526 22 13.1061 22H10.8939C7.44737 22 5.72409 22 4.54903 20.9882C3.37396 19.9764 3.13025 18.2827 2.64284 14.8952L2.36407 12.9579Z" stroke-width="2.2" />
              <path d="M9 16C9.85038 16.6303 10.8846 17 12 17C13.1154 17 14.1496 16.6303 15 16" stroke-width="2.2" stroke-linecap="round" />
            </svg>
          </div>
          <span class="mt-1 text-xs font-semibold dark:text-gray-200">
            Tentang
            <br />
            Kami
          </span>
        </button>

        <!-- Ikon Hasil Pindai -->
        <button id="sidebar-menu-button-open-hasil-pindai" class="relative flex cursor-pointer flex-col items-center gap-1 text-center text-gray-500">
          <div class="relative">
            <svg class="w-5 fill-gray-500 dark:fill-gray-200" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <g>
                <path fill="none" d="M0 0h24v24H0z" />
                <path d="M2 5l7-3 6 3 6.303-2.701a.5.5 0 0 1 .697.46V19l-7 3-6-3-6.303 2.701a.5.5 0 0 1-.697-.46V5zm14 14.395l4-1.714V5.033l-4 1.714v12.648zm-2-.131V6.736l-4-2v12.528l4 2zm-6-2.011V4.605L4 6.319v12.648l4-1.714z" />
              </g>
            </svg>
            <div id="sidebar-menu-button-open-hasil-pindai-badge-status" class="absolute -right-5 -top-7 flex hidden h-8 w-8 items-center justify-center text-3xl font-bold text-red-600 dark:text-red-400">.</div>
          </div>
          <span class="mt-1 text-xs font-semibold dark:text-gray-200">
            Hasil
            <br />
            Telusuri
            <br />
            Area
          </span>
        </button>

        <!-- Ikon Hasil AI -->
        <button id="sidebar-menu-button-open-hasil-AI" class="relative flex cursor-pointer flex-col items-center gap-1 text-center text-gray-500">
          <div class="relative">
            <div id="icon-sidebar-menu-button-open-hasil-AI">
              <svg class="w-5 fill-gray-500 dark:fill-gray-200" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <g>
                  <path fill="none" d="M0 0h24v24H0z" />
                  <path d="M5.455 15L1 18.5V3a1 1 0 0 1 1-1h15a1 1 0 0 1 1 1v12H5.455zm-.692-2H16V4H3v10.385L4.763 13zM8 17h10.237L20 18.385V8h1a1 1 0 0 1 1 1v13.5L17.545 19H9a1 1 0 0 1-1-1v-1z" />
                </g>
              </svg>
            </div>
            <div id="sidebar-menu-button-open-hasil-AI-badge-status" class="absolute -right-5 -top-7 flex hidden h-8 w-8 items-center justify-center text-3xl font-bold text-red-600 dark:text-red-400">.</div>
          </div>
          <span class="mt-1 text-xs font-semibold dark:text-gray-200">
            Hasil
            <br />
            Pencarian
            <br />
            AI
          </span>
        </button>

        <!-- Ikon Hapus Pilihan AI -->
        <button id="hapusPilihanAI-button" class="flex hidden cursor-pointer flex-col items-center rounded-lg text-center text-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-red-400" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
          <span class="mt-1 text-xs font-semibold dark:text-gray-200">
            Hapus
            <br />
            Pencarian
            <br />
            AI
          </span>
        </button>
      </div>

      <!-- Garis pemisah -->
      <div class="border-t-1 mt-auto w-full border-dashed border-gray-300 dark:border-gray-400"></div>

      <!-- Ikon Fitur Mode Terang -->
      <button id="theme-toggle" class="flex cursor-pointer flex-col items-center pt-6 text-center text-gray-500">
        <svg id="theme-toggle-light-icon" class="h-6 w-6 text-gray-500 dark:text-gray-200" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path>
        </svg>
        <svg id="theme-toggle-dark-icon" class="h-6 w-6 text-gray-500 dark:text-gray-200" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
        <span id="theme-toggle-text" class="mt-1 text-xs font-semibold dark:text-gray-200">
          Mode
          <br />
          Terang
        </span>
      </button>

      <!-- Tombol Fullscreen -->
      <button id="fullscreen-button" class="flex cursor-pointer flex-col items-center pt-6 text-center text-gray-600">
        <svg class="w-6 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9.00002 3.99998H4.00004L4 9M20 8.99999V4L15 3.99997M15 20H20L20 15M4 15L4 20L9.00002 20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span class="mt-1 text-xs font-semibold dark:text-gray-200">Fullscreen</span>
      </button>
    </div>

    <!-- Konten 1 Sidebar (mirip panel hasil Google Maps) -->
    <div id="sidebar-content-about-us" class="md:w-lg fixed bottom-0 left-20 z-[1100] flex hidden h-[60vh] w-[calc(100%-5rem)] flex-1 flex-col overflow-hidden bg-gradient-to-b from-blue-500 via-blue-400 to-blue-300 md:h-full md:border-t-0 dark:from-blue-900 dark:via-blue-800 dark:to-blue-600">
      <!-- Header Hasil -->
      <div class="flex items-center justify-between p-4">
        <div class="flex w-full flex-row justify-start gap-2">
          <svg class="w-8 stroke-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.36407 12.9579C1.98463 10.3208 1.79491 9.00229 2.33537 7.87495C2.87583 6.7476 4.02619 6.06234 6.32691 4.69181L7.71175 3.86687C9.80104 2.62229 10.8457 2 12 2C13.1543 2 14.199 2.62229 16.2882 3.86687L17.6731 4.69181C19.9738 6.06234 21.1242 6.7476 21.6646 7.87495C22.2051 9.00229 22.0154 10.3208 21.6359 12.9579L21.3572 14.8952C20.8697 18.2827 20.626 19.9764 19.451 20.9882C18.2759 22 16.5526 22 13.1061 22H10.8939C7.44737 22 5.72409 22 4.54903 20.9882C3.37396 19.9764 3.13025 18.2827 2.64284 14.8952L2.36407 12.9579Z" stroke-width="1.5" />
            <path d="M9 16C9.85038 16.6303 10.8846 17 12 17C13.1154 17 14.1496 16.6303 15 16" stroke-width="1.5" stroke-linecap="round" />
          </svg>
          <h1 class="text-2xl font-bold text-white">KontrakYuk</h1>
        </div>
        <button id="close-button-sidebar-content-about-us" class="flex cursor-pointer items-center text-sm font-medium text-white">Tutup</button>
      </div>

      <!-- Daftar Hasil Pencarian (area yang bisa di-scroll) -->
      <div class="sidebar-scroll flex-1 overflow-y-auto">
        <!-- Hero Section -->
        <section class="px-4 pt-16 text-white sm:px-6 lg:px-8">
          <div class="mx-auto max-w-7xl text-center">
            <h1 class="mb-6 text-4xl font-bold md:text-6xl">Cari Kontrakan?</h1>
            <p class="mx-auto max-w-3xl text-xl opacity-90 md:text-2xl">
              Solusi mudah cari rumah kontrakan. Dari pada capek dan habis bensin di jalan, mending cari di
              <span class="font-semibold">KontrakYuk</span>
              aja.
            </p>
          </div>
        </section>
        <!-- Hero Section -->
        <section class="px-4 pb-32 pt-16 text-white sm:px-6 lg:px-8">
          <div class="mx-auto max-w-7xl text-center">
            <p class="mb-0 text-lg font-bold md:mb-2">Hubungi Kami</p>
            <p class="text-md">
              Whatsapp:
              <a class="text-md font-medium" href="https://wa.me/6282231320160?text=permisi,%20saya%20butuh%20bantuan%20tim%20kontrakyuk" target="_blank">+62 822-3132-0160</a>
            </p>
            <p class="text-md">
              Whatsapp Channel:
              <a class="text-md font-medium" href="https://whatsapp.com/channel/0029Vb28FW0JZg42nu3DfR23" target="_blank">KontrakYuk</a>
            </p>
            <p class="text-md">
              Telegram:
              <a class="text-md font-medium" href="https://t.me/kontrakyuk?text=permisi,%20saya%20butuh%20bantuan%20tim%20kontrakyuk" target="_blank">kontrakyuk</a>
            </p>
          </div>
        </section>
      </div>
    </div>

    <!-- Konten 2 Sidebar (mirip panel hasil Google Maps) -->
    <div id="sidebar-content-hasil-pindai" class="md:w-lg border-e-1 border-t-1 fixed bottom-0 left-20 z-[1100] flex hidden h-[60vh] w-[calc(100%-5rem)] flex-1 flex-col overflow-hidden border-gray-200 bg-white md:h-full md:border-t-0 dark:border-gray-700 dark:bg-gray-800">
      <!-- Header Hasil -->
      <div class="flex items-center justify-between border-b border-gray-200 px-4 py-2 dark:border-gray-700">
        <div class="flex flex-col items-start">
          <h2 class="mr-2 text-xl font-medium text-gray-800 dark:text-gray-200">Daftar Kontrakan</h2>
          <h2 id="sidebar-content-hasil-pindai-info-bar" class="mr-2 text-sm text-gray-600 dark:text-gray-200">0 kontrakan ditampilkan</h2>
        </div>
        <button id="close-button-sidebar-content-hasil-pindai" class="flex cursor-pointer items-center text-sm font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 dark:text-blue-200">Tutup</button>
      </div>

      <!-- Daftar Hasil Pencarian (area yang bisa di-scroll) -->
      <div id="sidebar-content-hasil-pindai-property-list" class="sidebar-scroll flex-1 overflow-y-auto"></div>
    </div>

    <!-- Konten 3 Sidebar (mirip panel hasil Google Maps) -->
    <div id="sidebar-content-hasil-AI" class="md:w-lg border-e-1 border-t-1 fixed bottom-0 left-20 z-[1100] flex hidden h-[60vh] w-[calc(100%-5rem)] flex-1 flex-col overflow-hidden border-gray-200 bg-white md:h-full md:border-t-0 dark:border-gray-700 dark:bg-gray-800">
      <!-- Header Hasil -->
      <div class="flex items-center justify-between border-b border-gray-200 px-4 py-2 dark:border-gray-700">
        <div class="flex flex-col items-start">
          <div class="flex flex-row gap-2">
            <svg class="w-5 fill-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
              <path d="M16 8.016A8.522 8.522 0 008.016 16h-.032A8.521 8.521 0 000 8.016v-.032A8.521 8.521 0 007.984 0h.032A8.522 8.522 0 0016 7.984v.032z" />
            </svg>
            <h2 class="mr-2 text-xl font-medium text-gray-800 dark:text-gray-200">Pilihan AI</h2>
          </div>
          <h2 id="sidebar-content-hasil-AI-info-bar" class="mr-2 text-sm text-gray-600 dark:text-gray-200">0 kontrakan ditampilkan</h2>
        </div>
        <button id="close-button-sidebar-content-hasil-AI" class="flex cursor-pointer items-center text-sm font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 dark:text-blue-200">Tutup</button>
      </div>

      <!-- Daftar Hasil Pencarian (area yang bisa di-scroll) -->
      <div id="sidebar-content-hasil-AI-property-list" class="sidebar-scroll flex-1 overflow-y-auto"></div>
    </div>

    <!-- Menu telusuri area di peta -->
    <div id="container-floating-button" class="fixed left-20 top-4 z-[1100] mx-2 flex w-[calc(100%-5.5rem)] flex-row gap-2 overflow-x-auto pb-2 pr-2 [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
      <div id="button-telusuri-area-map" class="min-w-42 border-1 flex cursor-pointer flex-row items-center justify-center gap-2 rounded-full border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-md dark:border-gray-500 dark:bg-gray-800 dark:text-gray-200 dark:shadow-gray-700/50">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 fill-gray-600 dark:fill-gray-200" viewBox="0 0 512 512">
          <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
          <path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z" />
        </svg>
        Telusuri area ini
      </div>

      <!-- Ikon Filter Kriteria -->
      <button id="pencarian-button" class="border-1 flex min-w-44 cursor-pointer flex-row items-center justify-center gap-2 rounded-full border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-md dark:border-gray-500 dark:bg-gray-800 dark:text-gray-200 dark:shadow-gray-700/50">
        <svg class="w-4 fill-gray-500 dark:fill-gray-200" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <g>
            <path fill="none" d="M0 0h24v24H0z" />
            <path d="M2 18h7v2H2v-2zm0-7h9v2H2v-2zm0-7h20v2H2V4zm18.674 9.025l1.156-.391 1 1.732-.916.805a4.017 4.017 0 0 1 0 1.658l.916.805-1 1.732-1.156-.391c-.41.37-.898.655-1.435.83L19 21h-2l-.24-1.196a3.996 3.996 0 0 1-1.434-.83l-1.156.392-1-1.732.916-.805a4.017 4.017 0 0 1 0-1.658l-.916-.805 1-1.732 1.156.391c.41-.37.898-.655 1.435-.83L17 11h2l.24 1.196c.536.174 1.024.46 1.434.83zM18 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />
          </g>
        </svg>
        <span>Sortir Kontrakan</span>
      </button>

      <!-- Ikon Rekomendasi AI -->
      <button id="rekomendasiAI-button" class="border-1 flex min-w-36 cursor-pointer flex-row items-center justify-center gap-2 rounded-full border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-md dark:border-gray-500 dark:bg-gray-800 dark:text-gray-200 dark:shadow-gray-700/50">
        <svg class="w-4 stroke-gray-500 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3L14.0357 8.16153C14.2236 8.63799 14.3175 8.87622 14.4614 9.0771C14.5889 9.25516 14.7448 9.41106 14.9229 9.53859C15.1238 9.68245 15.362 9.77641 15.8385 9.96432L21 12L15.8385 14.0357C15.362 14.2236 15.1238 14.3175 14.9229 14.4614C14.7448 14.5889 14.5889 14.7448 14.4614 14.9229C14.3175 15.1238 14.2236 15.362 14.0357 15.8385L12 21L9.96432 15.8385C9.77641 15.362 9.68245 15.1238 9.53859 14.9229C9.41106 14.7448 9.25516 14.5889 9.0771 14.4614C8.87622 14.3175 8.63799 14.2236 8.16153 14.0357L3 12L8.16153 9.96432C8.63799 9.77641 8.87622 9.68245 9.0771 9.53859C9.25516 9.41106 9.41106 9.25516 9.53859 9.0771C9.68245 8.87622 9.77641 8.63799 9.96432 8.16153L12 3Z" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span>Pencarian AI</span>
      </button>
    </div>

    <div id="map" class="h-screen w-screen"></div>
  </body>

  <script src="asset/sweetalert.js"></script>

  <script src="asset/leaflet.js"></script>

  <script src="asset/leaflet.markercluster.js"></script>

  <script src="asset/jquery-3.7.1.min.js"></script>

  <script src="asset/marked.min.js"></script>

  <script>
    // $(document).ready(function () {
    //   const allowedDomain = "kontrakyuk.github.io";
    //   const currentDomain = window.location.hostname;

    //   if (currentDomain != allowedDomain) {
    //     window.location.href = "about:blank";
    //   }
    // });

    const map = L.map("map", {
      attributionControl: false, // Matikan attribution bawaan Leaflet
      zoomControl: false,
    }).setView([-7.9519144, 112.6136692], 15);
    const markers = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      spiderfyDistanceMultiplier: 6,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
    });

    let popupOpen = false;

    // Daftar tile layer dengan urutan prioritas
    var tileLayers = [
      {
        name: "cartocdn dark API",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.cartocdn.com/">cartocdn</a>, &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: true,
      },
      {
        name: "Thunderforest",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.thunderforest.com/">Thunderforest1</a>, &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=6e5478c8a4f54c779f85573c0e399391", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: false,
      },
      {
        name: "Thunderforest",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.thunderforest.com/">Thunderforest2</a>, &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=bef62649ec0a47d7bc71106f7d10e991", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: false,
      },
      {
        name: "OpenStreetMap Standard",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: false,
      },
    ];

    const themeToggleBtn = document.getElementById("theme-toggle");
    const themeToggleText = document.getElementById("theme-toggle-text");
    const themeToggleLightIcon = document.getElementById("theme-toggle-light-icon");
    const themeToggleDarkIcon = document.getElementById("theme-toggle-dark-icon");

    // Check for saved user preference or use system preference
    if (localStorage.getItem("color-theme") === "dark") {
      document.documentElement.classList.add("dark");
      themeToggleLightIcon.classList.add("hidden");
      themeToggleDarkIcon.classList.remove("hidden");
      themeToggleText.innerHTML = "Mode<br />Gelap";
    } else {
      document.documentElement.classList.remove("dark");
      themeToggleLightIcon.classList.remove("hidden");
      themeToggleDarkIcon.classList.add("hidden");
      themeToggleText.innerHTML = "Mode<br />Terang";
    }

    // Toggle between light and dark mode
    themeToggleBtn.addEventListener("click", function () {
      // Toggle icons
      themeToggleLightIcon.classList.toggle("hidden");
      themeToggleDarkIcon.classList.toggle("hidden");

      // Toggle theme
      if (document.documentElement.classList.contains("dark")) {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("color-theme", "light");
        themeToggleText.innerHTML = "Mode<br />Terang";
      } else {
        document.documentElement.classList.add("dark");
        localStorage.setItem("color-theme", "dark");
        themeToggleText.innerHTML = "Mode<br />Gelap";
      }
    });

    // Buat custom attribution control
    var attributionControl = L.control
      .attribution({
        position: "bottomright",
        prefix: false,
      })
      .addTo(map);

    // Fungsi untuk memilih layer berdasarkan preferensi warna
    function selectInitialLayer() {
      // Cek dark mode dari class 'dark' pada html element (umumnya digunakan oleh framework seperti Tailwind)
      const htmlElement = document.documentElement;
      const classDarkMode = htmlElement.classList.contains("dark");

      // Jika salah satu kondisi dark mode terpenuhi
      if (classDarkMode) {
        // Gunakan layer dark (indeks 0)
        return tileLayers[0];
      } else {
        // Gunakan layer pertama yang bukan dark (lewatkan indeks 0)
        for (let i = 1; i < tileLayers.length; i++) {
          if (!tileLayers[i].isDark) {
            return tileLayers[i];
          }
        }
        // Fallback ke layer terakhir jika tidak ada yang cocok
        return tileLayers[tileLayers.length - 1];
      }
    }

    // Fungsi untuk memantau perubahan class 'dark' pada html element
    function observeDarkClassChange() {
      const htmlElement = document.documentElement;

      // Buat observer untuk memantau perubahan class
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.attributeName === "class") {
            switchLayerBasedOnColorScheme();
          }
        });
      });

      // Mulai mengamati perubahan atribut class
      observer.observe(htmlElement, {
        attributes: true,
        attributeFilter: ["class"],
      });
    }

    // Panggil fungsi observer saat inisialisasi
    observeDarkClassChange();

    // Fungsi untuk mengganti layer berdasarkan preferensi warna
    function switchLayerBasedOnColorScheme() {
      // Dapatkan layer aktif saat ini
      var currentLayer = tileLayers.find((layer) => map.hasLayer(layer.layer));

      // Cek kedua kondisi dark mode
      const classDarkMode = document.documentElement.classList.contains("dark");
      const isDarkMode = classDarkMode;

      // Pilih layer baru berdasarkan preferensi warna
      var newLayer;
      if (isDarkMode) {
        // Cari layer dark pertama yang tersedia
        newLayer = tileLayers.find((layer) => layer.isDark);
      } else {
        // Cari layer non-dark pertama yang tersedia (lewatkan indeks 0)
        for (let i = 1; i < tileLayers.length; i++) {
          if (!tileLayers[i].isDark) {
            newLayer = tileLayers[i];
            break;
          }
        }
      }

      // Jika tidak ada layer yang sesuai, gunakan layer terakhir
      if (!newLayer) {
        newLayer = tileLayers[tileLayers.length - 1];
      }

      // Jika layer baru berbeda dengan layer saat ini
      if (!currentLayer || newLayer.name !== currentLayer.name) {
        // Hapus semua layer dari peta
        tileLayers.forEach((layer) => {
          if (map.hasLayer(layer.layer)) {
            map.removeLayer(layer.layer);
          }
        });

        // Tambahkan layer baru
        newLayer.layer.addTo(map);
        updateAttribution(newLayer.attribution);

        // Reset status fallback untuk semua layer
        tileLayers.forEach((layer) => {
          layer.fallback = false;
        });
      }
    }

    // Pilih dan tambahkan layer awal
    var initialLayer = selectInitialLayer();
    initialLayer.layer.addTo(map);
    attributionControl.addAttribution(initialLayer.attribution);

    // Fungsi untuk update attribution
    function updateAttribution(attributionText) {
      attributionControl._container.innerHTML = attributionText;
    }

    // Fungsi untuk memeriksa apakah tile gagal dimuat
    function checkTileError(e) {
      var coords = e.coords;

      // Cari layer aktif yang belum dicoba fallback
      var currentActiveIndex = tileLayers.findIndex((layer) => map.hasLayer(layer.layer) && layer.fallback === false);

      if (currentActiveIndex >= 0 && currentActiveIndex < tileLayers.length - 1) {
        // Tandai layer saat ini sudah dicoba
        tileLayers[currentActiveIndex].fallback = true;

        // Hapus layer yang gagal
        map.removeLayer(tileLayers[currentActiveIndex].layer);

        // Cari layer berikutnya yang sesuai dengan preferensi warna
        var nextLayer;
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          // Cari layer dark berikutnya
          for (let i = currentActiveIndex + 1; i < tileLayers.length; i++) {
            if (tileLayers[i].isDark) {
              nextLayer = tileLayers[i];
              break;
            }
          }
        } else {
          // Cari layer non-dark berikutnya
          for (let i = currentActiveIndex + 1; i < tileLayers.length; i++) {
            if (!tileLayers[i].isDark) {
              nextLayer = tileLayers[i];
              break;
            }
          }
        }

        // Jika tidak ada layer yang sesuai, gunakan layer terakhir
        if (!nextLayer) {
          nextLayer = tileLayers[tileLayers.length - 1];
        }

        // Tambahkan layer fallback berikutnya
        nextLayer.layer.addTo(map);

        // Update attribution
        updateAttribution(nextLayer.attribution);
      }
    }

    // Tambahkan event listener untuk error tile ke semua layer
    tileLayers.forEach((layer) => {
      layer.layer.on("tileerror", checkTileError);
    });

    // Fungsi untuk menentukan gaya marker lokasi penting
    function styleMarkerLokasiPenting(nama_singkatan_tempat, nama_lengkap_tempat, logo) {
      return L.divIcon({
        className: "leaflet-marker-hover-lokasi-penting",
        html: `
            <div class="w-[150px] flex flex-col items-center bg-white rounded-xl shadow-md border border-solid border-gray-200 p-2 overflow-hidden">
              <img src="${logo}" alt="STAN" class="h-16 mb-3" />
              <h2 class="text-lg font-semibold text-gray-800">${nama_singkatan_tempat}</h2>
              <p class="text-sm text-center text-gray-500">${nama_lengkap_tempat}</p>
            </div>`,
        iconAnchor: [80, 0],
      });
    }

    map.on("movestart", function () {
      document.getElementById("container-floating-button").classList.add("hidden");
    });

    map.on("moveend", function () {
      setTimeout(function () {
        document.getElementById("container-floating-button").classList.remove("hidden");
      }, 1000);
    });

    // Data lokasi penting
    const lokasiPenting = [
      { lat: -7.9519144, lng: 112.6136692, nama_singkatan_tempat: "UB", nama_lengkap_tempat: "Universitas Brawijaya", logo: "asset/logo/UB logo.png" },
      { lat: -7.946148, lng: 112.6156133, nama_singkatan_tempat: "POLINEMA", nama_lengkap_tempat: "Politeknik Negeri Malang", logo: "asset/logo/Polinema logo.png" },
      { lat: -7.9605584, lng: 112.6176092, nama_singkatan_tempat: "UM", nama_lengkap_tempat: "Universitas Negeri Malang", logo: "asset/logo/UM logo.png" },
      { lat: -7.9214432, lng: 112.5971074, nama_singkatan_tempat: "UMM III", nama_lengkap_tempat: "Universitas Muhammadiyah Malang Kampus 3", logo: "asset/logo/UMM Logo.png" },
      { lat: -7.9570105, lng: 112.6138383, nama_singkatan_tempat: "UMM II", nama_lengkap_tempat: "Universitas Muhammadiyah Malang Kampus 2", logo: "asset/logo/UMM Logo.png" },
      { lat: -7.9380183, lng: 112.626546, nama_singkatan_tempat: "ASIA", nama_lengkap_tempat: "INSTITUT ASIA", logo: "asset/logo/Asia_Logo.png" },
      { lat: -7.9368015587979865, lng: 112.60687730931299, nama_singkatan_tempat: "Unisma", nama_lengkap_tempat: "Kampus Unisma", logo: "asset/logo/UNISMA logo.png" },
      { lat: -7.939586660220883, lng: 112.63606569679442, nama_singkatan_tempat: "Widyagama", nama_lengkap_tempat: "Universitas Widyagama Malang", logo: "asset/logo/Widyagama logo.png" },
      { lat: -7.9510327, lng: 112.6066041, nama_singkatan_tempat: "UIN", nama_lengkap_tempat: "Universitas Islam Negeri Maulana Malik Ibrahim", logo: "asset/logo/UIN logo.png" },
      { lat: -7.9726439, lng: 112.6088409, nama_singkatan_tempat: "UNMER", nama_lengkap_tempat: "Universitas Merdeka Malang", logo: "asset/logo/Unmer logo.png" },
      { lat: -7.916631751857723, lng: 112.63427327121579, nama_singkatan_tempat: "ITN 2", nama_lengkap_tempat: "Institut Teknologi Nasional - Kampus 2", logo: "asset/logo/ITN 2 Logo.png" },
    ];

    // Menambahkan marker ke peta untuk setiap lokasi
    lokasiPenting.forEach(({ lat, lng, nama_singkatan_tempat, nama_lengkap_tempat, logo }) => {
      L.marker([lat, lng], { icon: styleMarkerLokasiPenting(nama_singkatan_tempat, nama_lengkap_tempat, logo) }).addTo(map);
    });

    document.getElementById("hapusPilihanAI-button").addEventListener("click", () => {
      const infoBarElement = document.getElementById("sidebar-content-hasil-AI-info-bar");
      const propertyListContainer = document.getElementById("sidebar-content-hasil-AI-property-list");

      document.getElementById("hapusPilihanAI-button").classList.add("hidden");
      propertyListContainer.innerHTML = "";
      infoBarElement.innerText = `0 kontrakan ditampilkan`;

      markers.eachLayer((layer) => {
        layer.unbindTooltip();
      });
    });

    // Fungsi untuk menentukan gaya marker lokasi properti
    function styleMarker(ketersediaan, harga, deskripsi_spesifikasi_kontrakan, jumlah_peminat) {
      // ambil jumlah kamar tidur
      const regexKamarTidur = /(\d+)\s*kamar\s*tid[au]r/i;
      const hasilKamarTidur = deskripsi_spesifikasi_kontrakan.match(regexKamarTidur);

      if (ketersediaan == "Tersedia") {
        return L.divIcon({
          className: "leaflet-marker-hover-lokasi-properti",
          html: `
              <div class="relative">
                <div class="${jumlah_peminat > 0 ? "w-[180px]" : "w-[130px]"} h-auto items-center flex flex-row gap-4 bg-blue-500 text-white text-center p-1 px-2 rounded-full dark:bg-blue-700">
                  ${
                    jumlah_peminat > 0
                      ? ` <div class="flex flex-row ml-2">
                            <div class="left-0 flex items-center justify-center bg-blue-500 dark:bg-blue-800 text-white text-xs font-bold rounded-full w-8 h-8 border-2 border-white dark:border-blue-200">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 " viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                              </svg>
                            </div>

                            <div class="absolute left-10 top-1/2 -translate-y-1/2 flex items-center justify-center bg-blue-500 dark:bg-blue-800 text-white text-[0.9rem] font-bold rounded-full w-8 h-8 border-2 border-white dark:border-blue-200">
                              <span>${jumlah_peminat}</span>
                            </div>
                          </div>
                        `
                      : ""
                  }
                  <div class="flex flex-col w-full">
                    <span class="font-semibold text-[1rem] tracking-wide">
                      ${harga}
                    </span>
                    <span class="text-white text-[0.8rem] text-center tracking-wide">
                      ${hasilKamarTidur ? hasilKamarTidur[1] + " Kamar Tidur" : jumlah_peminat + " peminat"}
                    </span>
                  </div>
                </div>
              </div>
            `,
          iconAnchor: [48, 35],
        });
      }

      if (ketersediaan != "Tersedia") {
        return L.divIcon({
          className: "leaflet-marker-hover-lokasi-properti",
          html: `
              <div class="w-[130px] h-auto items-center flex flex-col gap-0 bg-red-500 text-white text-center p-1 px-2 rounded-full dark:bg-red-700">
                <span class="font-semibold   text-[1rem] tracking-wide">
                    ${harga}
                </span>
                <span class="flex gap-1  text-[0.8rem] text-left tracking-wide">
                    ${hasilKamarTidur ? hasilKamarTidur[1] + " Kamar Tidur" : jumlah_peminat + " peminat"}
                </span>
              </div>
            `,
          iconAnchor: [48, 35],
        });
      }
    }

    var markersProperti;
    fetch("asset/loading.svg")
      .then((response) => response.text())
      .then((base64Data) => {
        try {
          // Mendekode data Base64 dengan dukungan UTF-8 untuk emoji
          const decodedData = decodeURIComponent(escape(atob(base64Data)));

          // Jika data asli Anda adalah JSON yang dienkripsi sebelum di-Base64,
          // maka Anda perlu mendekripsinya terlebih dahulu.
          // const decryptedData = CryptoJS.AES.decrypt(decodedData, "passwordFilterDataTextboxAreaInnerInput").toString(CryptoJS.enc.Utf8);
          // markersProperti = JSON.parse(decryptedData);

          // Jika data asli Anda adalah JSON langsung setelah di-Base64,
          // maka Anda bisa langsung mem-parsing-nya.
          markersProperti = JSON.parse(decodedData);

          updateMarkers();

          // Ambil parameter dari URL
          const params = new URLSearchParams(window.location.search);
          const koderumah = params.get("koderumah"); // Ambil nilai dari koderumah

          if (koderumah) {
            markersProperti["data_kontrakan"].forEach((markerData) => {
              if (markerData.nomer == koderumah) {
                // Pusatkan peta ke koordinat yang sesuai
                map.setView([markerData.latitude, markerData.longitude], 19);
              }
            });
          }
        } catch (e) {
          console.error("Error:", e);
        }
      })
      .catch((error) => {
        console.error("Terjadi kesalahan saat membaca file:", error);
      });

    function formatDate(dateString) {
      const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
      const date = new Date(dateString);
      return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function updateMarkers(jumlahKamarTidurMinimal, jumlahKamarTidurMaksimal, jumlahKamarMandiMinimal, jumlahKamarMandiMaksimal, adaFasilitasAC, adaFasilitasWaterHeater, adaFasilitasKasur, adaFasilitasLemari, adaFasilitasKompor, adaFasilitasGarasiMobil, adaFasilitasGarasiSepedaMotor, adaFasilitasLingkunganPerumahan, fasilitasDekatMasjid, fasilitasPeruntukanUntukBerjualan, minPrice, maxPrice, statusKetersediaan, filterJumlahPeminat, cariKata) {
      markers.clearLayers();
      markersProperti["data_kontrakan"].forEach((markerData) => {
        // cek jumlah kamar tidur
        if (jumlahKamarTidurMinimal && jumlahKamarTidurMaksimal) {
          const matchKamarTidur = markerData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*tidur/i);
          const jumlahKamarTidur = matchKamarTidur ? parseInt(matchKamarTidur[1], 10) : null;
          const apakahJumlahKamarTidurSesuai = jumlahKamarTidur >= jumlahKamarTidurMinimal && jumlahKamarTidur <= jumlahKamarTidurMaksimal;
          if (!apakahJumlahKamarTidurSesuai || !matchKamarTidur) {
            return;
          }
        } else if (jumlahKamarTidurMinimal) {
          const matchKamarTidur = markerData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*tidur/i);
          const jumlahKamarTidur = matchKamarTidur ? parseInt(matchKamarTidur[1], 10) : null;
          const apakahJumlahKamarTidurSesuai = jumlahKamarTidur >= jumlahKamarTidurMinimal;
          if (!apakahJumlahKamarTidurSesuai || !matchKamarTidur) {
            return;
          }
        } else if (jumlahKamarTidurMaksimal) {
          const matchKamarTidur = markerData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*tidur/i);
          const jumlahKamarTidur = matchKamarTidur ? parseInt(matchKamarTidur[1], 10) : null;
          const apakahJumlahKamarTidurSesuai = jumlahKamarTidur <= jumlahKamarTidurMaksimal;
          if (!apakahJumlahKamarTidurSesuai || !matchKamarTidur) {
            return;
          }
        }

        // cek jumlah kamar mandi
        if (jumlahKamarMandiMinimal && jumlahKamarMandiMaksimal) {
          const matchKamarMandi = markerData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*mandi/i);
          const jumlahKamarMandi = matchKamarMandi ? parseInt(matchKamarMandi[1], 10) : null;
          const apakahJumlahKamarMandiSesuai = jumlahKamarMandi >= jumlahKamarMandiMinimal && jumlahKamarMandi <= jumlahKamarMandiMaksimal;
          if (!apakahJumlahKamarMandiSesuai || !matchKamarMandi) {
            return;
          }
        } else if (jumlahKamarMandiMinimal) {
          const matchKamarMandi = markerData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*mandi/i);
          const jumlahKamarMandi = matchKamarMandi ? parseInt(matchKamarMandi[1], 10) : null;
          const apakahJumlahKamarMandiSesuai = jumlahKamarMandi >= jumlahKamarMandiMinimal;
          if (!apakahJumlahKamarMandiSesuai || !matchKamarMandi) {
            return;
          }
        } else if (jumlahKamarMandiMaksimal) {
          const matchKamarMandi = markerData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*mandi/i);
          const jumlahKamarMandi = matchKamarMandi ? parseInt(matchKamarMandi[1], 10) : null;
          const apakahJumlahKamarMandiSesuai = jumlahKamarMandi <= jumlahKamarMandiMaksimal;
          if (!apakahJumlahKamarMandiSesuai || !matchKamarMandi) {
            return;
          }
        }

        if (adaFasilitasAC && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("ac")) {
          return;
        }

        if (adaFasilitasWaterHeater && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("water heater")) {
          return;
        }

        if (adaFasilitasKasur && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("kasur")) {
          return;
        }

        if (adaFasilitasLemari && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("lemari")) {
          return;
        }

        if (adaFasilitasKompor && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("kompor")) {
          return;
        }

        if (adaFasilitasGarasiMobil && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("garasi") && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("carport")) {
          return;
        }

        if (adaFasilitasGarasiSepedaMotor && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("sepeda motor")) {
          return;
        }

        if (adaFasilitasLingkunganPerumahan && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("perumahan")) {
          return;
        }

        if (fasilitasDekatMasjid && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("masjid")) {
          return;
        }

        if (fasilitasPeruntukanUntukBerjualan && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("usaha") && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("toko") && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("jualan") && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes("ruko")) {
          return;
        }

        if (minPrice && markerData.harga_sewa < minPrice) {
          return;
        }

        if (maxPrice && markerData.harga_sewa > maxPrice) {
          return;
        }

        if (statusKetersediaan == "available" && markerData.ketersediaan != "Tersedia") {
          return;
        }

        if (statusKetersediaan == "unavailable" && markerData.ketersediaan == "Tersedia") {
          return;
        }

        if (filterJumlahPeminat > markerData.jumlah_peminat) {
          return;
        }

        if (cariKata && !markerData.deskripsi_spesifikasi_kontrakan.toLowerCase().includes(cariKata.toLowerCase())) {
          return;
        }

        const marker = L.marker([markerData.latitude, markerData.longitude], { kode_properti: markerData.nomer, icon: styleMarker(markerData.ketersediaan, markerData.label_harga_sewa, markerData.deskripsi_spesifikasi_kontrakan, markerData.jumlah_peminat) });

        marker.on("click", function () {
          Swal.fire({
            title: "Detail Kontrakan",
            html: `
              <div class="bg-white overflow-x-scroll min-w-[400px] w-full text-left dark:bg-gray-800">
                <div class="w-full overflow-hidden rounded-l-lg py-2 md:h-auto">
                  <img id="foto_rumah" alt="Foto tidak bisa ditampilkan" class="w-full h-auto min-h-48 rounded-md bg-gray-100 dark:bg-gray-700 dark:text-gray-200 text-xs object-cover text-center" />
                </div>
                <div class="text-md flex w-full flex-col justify-between">
                  <div>
                    <div class="grid grid-cols-2 gap-4 my-4">
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Harga</p>
                          <p class="font-bold text-blue-800 dark:text-blue-400">${formatRupiahText(markerData.harga_sewa)}</p>
                      </div>
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Ketersediaan</p>
                          <p class="font-semibold ${markerData.ketersediaan === "Tersedia" ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400"}">${markerData.ketersediaan === "Tersedia" ? "Tersedia" : "Disewa"}</p>
                      </div>
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Jumlah Peminat</p>
                          <p class="font-semibold text-gray-600 dark:text-gray-200">${markerData.jumlah_peminat} peminat</p>
                      </div>
                      <div id="info_nomer_data" class="bg-gray-100 p-3 rounded-lg cursor-pointer dark:bg-gray-700">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Nomer Data</p>
                          <p class="font-semibold text-gray-600 dark:text-gray-200">No. ${markerData.nomer}</p>
                      </div>
                    </div>

                    <div class="mt-4">
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                        <div id="text-info-kontrakan-swal" class="text-gray-600 text-md max-h-64 overflow-x-clip overflow-y-scroll [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden dark:text-gray-200">
                          ${marked.parse(
                            markerData.deskripsi_spesifikasi_kontrakan
                              .replace(/((https?:\/\/|www\.)?[^\s]+\.[a-z]{2,6}[^\s]*)/gi, (match) => {
                                let url = match;
                                // Add https://www. if the URL doesn't have http:// or https://
                                if (!/^https?:\/\//i.test(url)) {
                                  if (url.startsWith("www.")) {
                                    url = "https://" + url;
                                  } else {
                                    url = "https://www." + url.replace(/^www\./, "");
                                  }
                                }

                                if (url.startsWith("https://www.wa.me") || url.startsWith("https://www.t.me")) {
                                  return `<a href="${url}%20-%20[${markerData.nomer}]" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}%20-%20[${markerData.nomer}]</a>`;
                                }
                                return `<a href="${url}" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}</a>`;
                              })
                              .replace(/^(?!\|)([^\n]+)\n(?!(\||-))/gm, "$1  \n"),
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex flex-col gap-4 items-center py-4">
                  <button id='cariRumahSepertiIni' class="w-full cursor-pointer flex items-center justify-center gap-2 py-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring focus:ring-blue-300">
                    <svg class="w-5 fill-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                      <path d="M16 8.016A8.522 8.522 0 008.016 16h-.032A8.521 8.521 0 000 8.016v-.032A8.521 8.521 0 007.984 0h.032A8.522 8.522 0 0016 7.984v.032z" />
                    </svg>
                    <div> Cari rumah seperti ini </div>
                  </button>
                    <button id='copyKodeRumah' class="w-full cursor-pointer flex items-center justify-center gap-2 py-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring focus:ring-blue-300">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.03-.47-.09-.7l7.06-4.11A2.99 2.99 0 0 0 18 7.92c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L7.96 9.81A2.99 2.99 0 0 0 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.66 0 1.27-.22 1.77-.59l7.12 4.14c-.06.24-.09.47-.09.72 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path>
                      </svg>
                      <div id="copyKodeRumahTeks"> Bagikan </div>
                    </button>
                </div>
              </div>
                        `,
            width: "50em",
            background: document.documentElement.classList.contains("dark") ? "#1f2937" : "", // bg-gray-800
            color: document.documentElement.classList.contains("dark") ? "#f3f4f6" : "", // text-gray-200
            showCloseButton: true,
            showConfirmButton: false,
            customClass: {
              closeButton: "focus:shadow-none",
            },
            buttonsStyling: false,
            didOpen: () => {
              // Set gambar setelah swal terbuka
              const fotoRumah = document.getElementById("foto_rumah");
              const infoNomerData = document.getElementById("info_nomer_data");
              const cariRumahSepertiIniButton = document.getElementById("cariRumahSepertiIni");
              const shareButton = document.getElementById("copyKodeRumah");
              const shareButtonTeks = document.getElementById("copyKodeRumahTeks");

              fotoRumah.src = `asset/photos/${markerData.foto_kontrakan}`;

              function convertImageToBase64(imageId) {
                return new Promise((resolve, reject) => {
                  const imageElement = document.getElementById(imageId);

                  if (!imageElement) {
                    reject(new Error("Elemen gambar tidak ditemukan"));
                    return;
                  }

                  // Fungsi untuk mendapatkan format dari src
                  const getFormatFromSrc = (src) => {
                    const extension = src.split(".").pop().toLowerCase();
                    return extension === "png" ? "image/png" : "image/jpeg";
                  };

                  const handleConversion = () => {
                    const format = getFormatFromSrc(imageElement.src);
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = imageElement.naturalWidth;
                    canvas.height = imageElement.naturalHeight;

                    ctx.drawImage(imageElement, 0, 0);

                    try {
                      const quality = format === "image/jpeg" ? 0.92 : 1.0;
                      const base64 = canvas.toDataURL(format, quality);
                      resolve({ base64, format });
                    } catch (error) {
                      reject(error);
                    }
                  };

                  if (imageElement.complete && imageElement.naturalWidth !== 0) {
                    handleConversion();
                  } else {
                    imageElement.onload = handleConversion;
                    imageElement.onerror = () => reject(new Error("Gagal memuat gambar"));
                  }
                });
              }

              // Contoh penggunaan:
              async function processImage() {
                try {
                  const result = await convertImageToBase64("foto_rumah");

                  // Mengembalikan hasil Base64 untuk digunakan di tempat lain
                  return result.base64;
                } catch (error) {
                  console.error("Error:", error.message);
                  throw error; // Re-throw error jika ingin ditangkap oleh caller
                }
              }

              infoNomerData.addEventListener("click", () => {
                // Ganti URL ini dengan URL Google Spreadsheet Anda yang sebenarnya
                const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/10T-cbh9g9Al3G-1fNc0h6cro4ZwhTY6QqLQeXltHF2I/edit?gid=0#gid=0&range=${markerData.nomer}:${markerData.nomer}`;

                // Membuka URL di tab baru
                window.open(spreadsheetUrl, "_blank");
              });

              cariRumahSepertiIniButton.addEventListener("click", () => {
                // Panggil fungsi utama
                processImage()
                  .then((base64) => {
                    // Gunakan hasil base64 di sini
                    // Contoh: document.getElementById('result').textContent = base64;
                    localStorage.setItem("preview-image", base64);
                  })
                  .catch((error) => {
                    console.error("Gagal memproses gambar:", error);
                  });

                localStorage.setItem(
                  "promptInput",
                  `cari rumah yang mirip dengan rumah No. ${markerData.nomer}, atau yang lebih baik, sesuai deksripsi dibawah ini:
                  ${markerData.deskripsi_spesifikasi_kontrakan}
                  `,
                );

                document.getElementById("rekomendasiAI-button").click();
              });

              shareButton.addEventListener("click", () => {
                const url = new URL(window.location.href);
                url.searchParams.set("koderumah", markerData.nomer); // Bisa diganti sesuai data rumah

                // Buat elemen textarea untuk menyalin teks
                const textarea = document.createElement("textarea");
                textarea.value = url.toString();
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                document.body.removeChild(textarea);

                // Beri umpan balik ke pengguna
                shareButtonTeks.innerHTML = "Berhasil disalin!";

                // Kembalikan teks tombol setelah 2 detik
                setTimeout(() => {
                  shareButtonTeks.innerHTML = "Bagikan";
                }, 2000);
              });

              history.pushState({ popup: true }, "");
              popupOpen = true;
            },
            willClose: () => {
              popupOpen = false;
              // Kembalikan ke state sebelumnya agar tidak stuck di riwayat
              if (history.state && history.state.popup) {
                history.back();
              }
            },
          });
        });

        // Event hover untuk menaikkan marker di atas yang lain
        marker.on("mouseover", function () {
          this.setZIndexOffset(1000); // Meningkatkan posisi marker
        });

        // Event mouseout untuk mengembalikan posisi semula
        marker.on("mouseout", function () {
          this.setZIndexOffset(0); // Kembali ke posisi default
        });

        // Event click untuk memastikan marker tetap di atas jika diklik
        marker.on("click", function () {
          this.setZIndexOffset(2000); // Paling atas saat diklik
        });
        marker._propertyData = markerData; // simpan data properti ke marker
        markers.addLayer(marker);
      });
      map.addLayer(markers);
    }

    document.getElementById("pencarian-button").addEventListener("click", () => {
      Swal.fire({
        title: "Sortir Kontrakan",
        html: `
                  <div class="py-6 flex flex-col gap-6 text-left dark:bg-gray-800">
                    <!-- Fasilitas Section -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Kamar Tidur</label>

                      <!-- Kamar Tidur -->
                      <div class="bg-gray-100 p-4 rounded-lg dark:bg-gray-700">

                        <div class="grid grid-cols-1 gap-4">
                          <div class="space-y-1">
                            <label for="filter_jumlah_kamar_tidur_minimal" class="text-sm text-gray-500 dark:text-gray-200">Min.</label>
                            <div class="relative">
                              <input type="number" id="filter_jumlah_kamar_tidur_minimal" name="filter_jumlah_kamar_tidur_minimal" 
                                    class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                    placeholder="1" min="0" />
                            </div>
                          </div>

                          <div class="space-y-1">
                            <label for="filter_jumlah_kamar_tidur_maksimal" class="text-sm text-gray-500 dark:text-gray-200">Max.</label>
                            <div class="relative">
                              <input type="number" id="filter_jumlah_kamar_tidur_maksimal" name="filter_jumlah_kamar_tidur_maksimal" 
                                    class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                    placeholder="10" min="0" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Kamar Mandi</label>

                      <!-- Kamar Mandi -->
                      <div class="bg-gray-100 p-4 rounded-lg dark:bg-gray-700">

                        <div class="grid grid-cols-1 gap-4">
                          <div class="space-y-1">
                            <label for="filter_jumlah_kamar_mandi_minimal" class="text-sm text-gray-500 dark:text-gray-200">Min.</label>
                            <div class="relative">
                              <input type="number" id="filter_jumlah_kamar_mandi_minimal" name="filter_jumlah_kamar_mandi_minimal" 
                                    class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                    placeholder="1" min="0" />
                            </div>
                          </div>

                          <div class="space-y-1">
                            <label for="filter_jumlah_kamar_mandi_maksimal" class="text-sm text-gray-500 dark:text-gray-200">Max.</label>
                            <div class="relative">
                              <input type="number" id="filter_jumlah_kamar_mandi_maksimal" name="filter_jumlah_kamar_mandi_maksimal" 
                                    class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                    placeholder="2" min="0" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Kelengkapan Section -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Kelengkapan</label>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_AC" name="fasilitas_AC" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">AC</span>
                        </label>

                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_water_heater" name="fasilitas_water_heater" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Water Heater</span>
                        </label>

                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_kasur" name="fasilitas_kasur" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Kasur</span>
                        </label>

                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_lemari" name="fasilitas_lemari" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Lemari</span>
                        </label>

                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_kompor" name="fasilitas_kompor" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Kompor</span>
                        </label>

                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_garasi_mobil" name="fasilitas_garasi_mobil" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Carport / Garasi</span>
                        </label>

                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_garasi_sepeda_motor" name="fasilitas_garasi_sepeda_motor" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Parkir Motor</span>
                        </label>
                      </div>
                    </div>

                    <!-- Lingkungan Section -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Lingkungan</label>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_lingkungan_perumahan" name="fasilitas_lingkungan_perumahan" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Perumahan</span>
                        </label>

                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_dekat_masjid" name="fasilitas_dekat_masjid" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Dekat dengan Masjid</span>
                        </label>
                      </div>
                    </div>

                    <!-- Peruntukan Section -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Peruntukan</label>

                      <div class="grid gap-3">
                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                          <input type="checkbox" id="fasilitas_peruntukan_untuk_berjualan" name="fasilitas_peruntukan_untuk_berjualan" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                          <span class="text-gray-700 dark:text-gray-200">Usaha (rumah, warung, ruko, dan sebagainya)</span>
                        </label>
                      </div>
                    </div>

                    <!-- Harga Section -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Harga</label>

                      <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="grid grid-cols-1 gap-4">
                          <div class="space-y-1">
                            <label for="filter_harga_min_properti" class="text-sm text-gray-500 dark:text-gray-200">Min.</label>
                            <div class="relative">
                              <input type="text" id="filter_harga_min_properti" name="filter_harga_min_properti" 
                                    class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                    placeholder="Kosongkan jika tidak diperlukan" />
                            </div>
                          </div>

                          <div class="space-y-1">
                            <label for="filter_harga_max_properti" class="text-sm text-gray-500 dark:text-gray-200">Max.</label>
                            <div class="relative">
                              <input type="text" id="filter_harga_max_properti" name="filter_harga_max_properti" 
                                    class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                    placeholder="Kosongkan jika tidak diperlukan" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Ketersediaan Section -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Ketersediaan</label>
                      <select id="status-ketersediaan" name="status-ketersediaan" 
                              class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors cursor-pointer">
                        <option value="all">Semua</option>
                        <option value="available">Tersedia</option>
                        <option value="unavailable">Tidak Tersedia</option>
                      </select>
                    </div>

                    <!-- Cari jumlah peminat -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Jumlah Peminat Minimal</label>
                      <input type="number" id="cari_jumlah_peminat" name="cari_jumlah_peminat" 
                              class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                              placeholder="1" min="0" />
                    </div>

                    <!-- Cari Kata Section -->
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Cari Kata</label>
                      <input type="text" id="cari_kata" name="cari_kata" 
                              class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                              placeholder="Cari kata (AC / Water Heater)" />
                    </div>

                    <!-- Action Buttons -->
                    <div class="w-full flex gap-4">
                      <button id="resetFilter" 
                              class="w-full px-4 py-2.5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors">
                        Reset
                      </button>
                      <button id="cariDataRumah" 
                              class="w-full px-4 py-2.5 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition-colors">
                        Cari
                      </button>
                    </div>
                  </div>
                  `,
        didOpen: () => {
          document.getElementById("cariDataRumah").addEventListener("click", () => {
            const jumlahKamarTidurMinimal = document.getElementById("filter_jumlah_kamar_tidur_minimal").value;
            const jumlahKamarTidurMaksimal = document.getElementById("filter_jumlah_kamar_tidur_maksimal").value;
            const jumlahKamarMandiMinimal = document.getElementById("filter_jumlah_kamar_mandi_minimal").value;
            const jumlahKamarMandiMaksimal = document.getElementById("filter_jumlah_kamar_mandi_maksimal").value;
            const adaFasilitasAC = document.getElementById("fasilitas_AC").checked;
            const adaFasilitasWaterHeater = document.getElementById("fasilitas_water_heater").checked;
            const adaFasilitasKasur = document.getElementById("fasilitas_kasur").checked;
            const adaFasilitasLemari = document.getElementById("fasilitas_lemari").checked;
            const adaFasilitasKompor = document.getElementById("fasilitas_kompor").checked;
            const adaFasilitasGarasiMobil = document.getElementById("fasilitas_garasi_mobil").checked;
            const adaFasilitasGarasiSepedaMotor = document.getElementById("fasilitas_garasi_sepeda_motor").checked;
            const adaFasilitasLingkunganPerumahan = document.getElementById("fasilitas_lingkungan_perumahan").checked;
            const fasilitasDekatMasjid = document.getElementById("fasilitas_dekat_masjid").checked;
            const fasilitasPeruntukanUntukBerjualan = document.getElementById("fasilitas_peruntukan_untuk_berjualan").checked;
            const minPrice = parseRupiah(document.getElementById("filter_harga_min_properti").value);
            const maxPrice = parseRupiah(document.getElementById("filter_harga_max_properti").value);
            const statusKetersediaan = document.getElementById("status-ketersediaan").value;
            const filterJumlahPeminat = document.getElementById("cari_jumlah_peminat").value;
            const cariKata = document.getElementById("cari_kata").value;
            updateMarkers(jumlahKamarTidurMinimal, jumlahKamarTidurMaksimal, jumlahKamarMandiMinimal, jumlahKamarMandiMaksimal, adaFasilitasAC, adaFasilitasWaterHeater, adaFasilitasKasur, adaFasilitasLemari, adaFasilitasKompor, adaFasilitasGarasiMobil, adaFasilitasGarasiSepedaMotor, adaFasilitasLingkunganPerumahan, fasilitasDekatMasjid, fasilitasPeruntukanUntukBerjualan, minPrice ? parseInt(minPrice) : null, maxPrice ? parseInt(maxPrice) : null, statusKetersediaan, filterJumlahPeminat, cariKata);

            // Tutup SweetAlert setelah klik cari
            Swal.close();
          });

          document.getElementById("resetFilter").addEventListener("click", () => {
            localStorage.clear();
            updateMarkers();

            // Tutup SweetAlert setelah reset
            Swal.close();
          });
          document.getElementById("filter_harga_min_properti").addEventListener("input", function () {
            formatRupiah(this);
          });

          document.getElementById("filter_harga_max_properti").addEventListener("input", function () {
            formatRupiah(this);
          });

          // Daftar ID elemen input yang ingin disimpan
          const inputIds = ["filter_jumlah_kamar_tidur_minimal", "filter_jumlah_kamar_tidur_maksimal", "filter_jumlah_kamar_mandi_minimal", "filter_jumlah_kamar_mandi_maksimal", "filter_harga_min_properti", "filter_harga_max_properti", "filterJumlahPeminat", "cari_kata"];

          // Simpan input teks ke localStorage saat berubah
          inputIds.forEach((id) => {
            const input = document.getElementById(id);
            if (input) {
              // Ambil dari localStorage saat halaman dimuat
              input.value = localStorage.getItem(id) || "";

              // Simpan ke localStorage saat ada perubahan
              input.addEventListener("input", () => {
                localStorage.setItem(id, input.value);
              });
            }
          });

          // Proses untuk Checkbox
          const checkboxes = document.querySelectorAll('input[type="checkbox"]');

          checkboxes.forEach((checkbox) => {
            // Ambil status dari localStorage
            const savedState = localStorage.getItem(checkbox.nextSibling.textContent.trim());
            if (savedState === "checked") {
              checkbox.checked = true;
            }

            // Simpan status checkbox saat berubah
            checkbox.addEventListener("change", () => {
              if (checkbox.checked) {
                localStorage.setItem(checkbox.nextSibling.textContent.trim(), "checked");
              } else {
                localStorage.removeItem(checkbox.nextSibling.textContent.trim());
              }
            });
          });

          history.pushState({ popup: true }, "");
          popupOpen = true;
        },
        willClose: () => {
          popupOpen = false;
          // Kembalikan ke state sebelumnya agar tidak stuck di riwayat
          if (history.state && history.state.popup) {
            history.back();
          }
        },
        width: "50em",
        background: document.documentElement.classList.contains("dark") ? "#1f2937" : "", // bg-gray-800
        color: document.documentElement.classList.contains("dark") ? "#f3f4f6" : "", // text-gray-200
        showCloseButton: true,
        showConfirmButton: false,
        buttonsStyling: false,
      });
    });

    document.getElementById("rekomendasiAI-button").addEventListener("click", () => {
      Swal.fire({
        title: "Pencarian AI",
        html: `
                  <div class="py-6 flex flex-col gap-6 text-left dark:bg-gray-800">
                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Sumber Data</label>

                      <div class="relative">
                        <select
                          id="data-selection-permintaan-AI"
                          class="block w-full px-4 py-2.5 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg appearance-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors cursor-pointer"
                        >
                          <option value="visible">Hanya Kontrakan yang Terlihat</option>
                          <option value="all">Semua Kontrakan pada Peta</option>
                        </select>

                        <!-- Custom dropdown arrow -->
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                          </svg>
                        </div>
                      </div>

                      <div class="flex gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-700">
                        <div class="flex-shrink-0">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                          </svg>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-200">
                          <p class="font-medium">Pemilihan Sumber Data</p>
                          <p class="mt-1">Tentukan cakupan data yang akan digunakan oleh AI untuk memberikan rekomendasi:</p>
                          <ul class="mt-2 space-y-1 text-blue-500 dark:text-blue-400">
                            <li class="flex items-start">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                              </svg>
                              <span><span class="font-medium">Terlihat:</span> Hanya properti dalam area tampilan peta saat ini</span>
                            </li>
                            <li class="flex items-start">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                              </svg>
                              <span><span class="font-medium">Semua:</span> Seluruh properti dalam database sistem</span>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Optimasi Pencarian AI (Opsional)</label>

                      <div class="flex flex-col gap-2">
                        <!-- Photo Upload Box -->
                        <div id="upload-container" class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 text-center dark:bg-gray-700 hover:border-blue-400 transition-colors cursor-pointer">
                          <input type="file" id="kontrakan-photo" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                          <div class="flex flex-col items-center justify-center space-y-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-200">Upload Foto Kontrakan</p>
                            <p class="text-xs text-gray-500 dark:text-gray-200">Format JPG, PNG (max 5MB)</p>
                          </div>
                        </div>

                        <!-- Preview Container (hidden by default) -->
                        <div id="preview-container" class="hidden relative w-full h-48 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden">
                          <img id="preview-image" src="#" alt="Preview Foto Kontrakan" class="w-full h-full object-cover">
                          <button
                            id="remove-photo"
                            type="button"
                            class="absolute top-2 right-2 bg-white text-red-500 rounded-full p-1 hover:bg-red-50 transition-colors shadow-sm"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                          </button>
                        </div>
                      </div>

                      <div class="flex gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200">
                        <div class="flex-shrink-0">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-200">
                          <p class="font-medium">AI akan menganalisis foto untuk hasil lebih akurat</p>
                          <p class="mt-1">Upload foto eksterior kontrakan Anda untuk memungkinkan sistem menemukan properti dengan karakteristik arsitektur yang serupa.</p>
                          <p class="mt-2 flex items-center text-blue-500 dark:text-blue-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Sistem akan mencocokkan dengan kontrakan yang memiliki arsitektur serupa
                          </p>
                          <p class="mt-2 flex items-center text-blue-500 dark:text-blue-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Hanya dapat upload 1 foto saja
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="w-full flex flex-col gap-3">
                      <label class="block text-blue-500 font-bold border-l-4 border-blue-500 pl-1">Permintaan Anda</label>

                      <div class="relative">
                        <textarea
                          id="promptInput"
                          rows="3"
                          placeholder="Contoh: Saya cari kontrakan dengan harga di bawah 20jt..."
                          class="block w-full px-4 py-2.5 text-gray-700 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-200 dark:text-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"
                        ></textarea>
                        <div class="absolute bottom-2 right-2 flex items-center gap-1">
                          <span id="char-count-promptInput" class="text-xs text-gray-400 dark:text-gray-200">0</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                          </svg>
                        </div>
                      </div>

                      <div class="flex gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-700 dark:border-gray-200">
                        <div class="flex-shrink-0">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                          </svg>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-200">
                          <p class="font-medium">Tips Permintaan AI</p>
                          <p class="mt-1">Berikan deskripsi selengkap mungkin untuk hasil terbaik:</p>
                          <ul class="mt-2 space-y-1 text-blue-500 dark:text-blue-400">
                            <li class="flex items-start">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                              </svg>
                              <span>Sebutkan <span class="font-medium">kisaran harga</span> yang diinginkan</span>
                            </li>
                            <li class="flex items-start">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                              </svg>
                              <span>Tambahkan <span class="font-medium">lokasi preferensi</span> atau fasilitas sekitar</span>
                            </li>
                            <li class="flex items-start">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                              </svg>
                              <span>Deskripsikan <span class="font-medium">tipe properti</span> yang dicari (ukuran, kamar, dll)</span>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="w-full flex flex-col gap-3">
                          <!-- Submit Button -->
                          <button
                              id="submitPermintaanAI"
                              class="w-full cursor-pointer px-4 py-2.5 bg-blue-500 text-white font-medium rounded-lg transition-all flex items-center justify-center">
                              <i class="fas fa-paper-plane mr-2"></i>
                              Cari data
                          </button>
                      </div>
                    </div>
                  </div>
                `,
        didOpen: () => {
          const jumlahKontrakan = hitungJumlahKontrakan();
          const photoInput = document.getElementById("kontrakan-photo");
          const uploadContainer = document.getElementById("upload-container");
          const previewContainer = document.getElementById("preview-container");
          const previewImage = document.getElementById("preview-image");
          const removeButton = document.getElementById("remove-photo");

          document.getElementById("data-selection-permintaan-AI").options[0].textContent = "Hanya Kontrakan yang Terlihat (" + jumlahKontrakan["visibleMarkers"] + ")";
          document.getElementById("data-selection-permintaan-AI").options[1].textContent = "Semua Kontrakan pada Peta (" + jumlahKontrakan["allMarkers"] + ")";

          // Daftar ID elemen input yang ingin disimpan
          const inputPhotoIds = ["preview-image"];

          // Simpan input teks ke localStorage saat berubah
          inputPhotoIds.forEach((id) => {
            const input = document.getElementById(id);
            if (input) {
              // Ambil dari localStorage saat halaman dimuat
              input.src = localStorage.getItem(id) || "";
            }

            if (localStorage.getItem(id) != null && localStorage.getItem(id) != "") {
              uploadContainer.classList.add("hidden");
              previewContainer.classList.remove("hidden");
            }
          });

          // Daftar ID elemen input yang ingin disimpan
          const inputIds = ["promptInput"];

          // Simpan input teks ke localStorage saat berubah
          inputIds.forEach((id) => {
            const input = document.getElementById(id);
            if (input) {
              // Ambil dari localStorage saat halaman dimuat
              input.value = localStorage.getItem(id) || "";
              autoExpandTextarea(input);

              // Simpan ke localStorage saat ada perubahan
              input.addEventListener("input", () => {
                autoExpandTextarea(input);
                localStorage.setItem(id, input.value);
              });
            }
          });

          // Simple preview functionality
          photoInput.addEventListener("change", function (e) {
            if (this.files && this.files[0]) {
              // Validate file type and size
              const file = this.files[0];
              const validTypes = ["image/jpeg", "image/png"];
              const maxSize = 5 * 1024 * 1024; // 5MB

              if (!validTypes.includes(file.type)) {
                alert("Hanya format JPG dan PNG yang diperbolehkan");
                return;
              }

              if (file.size > maxSize) {
                alert("Ukuran file maksimal 5MB");
                return;
              }

              // Display preview
              const reader = new FileReader();
              reader.onload = function (e) {
                previewImage.src = e.target.result;
                localStorage.setItem("preview-image", previewImage.src);

                uploadContainer.classList.add("hidden");
                previewContainer.classList.remove("hidden");
              };
              reader.readAsDataURL(file);
            }
          });

          removeButton.addEventListener("click", function (e) {
            e.preventDefault();
            photoInput.value = ""; // Clear the file input
            previewImage.src = "#";
            localStorage.setItem("preview-image", "");
            previewContainer.classList.add("hidden");
            uploadContainer.classList.remove("hidden");
          });

          document.getElementById("submitPermintaanAI").addEventListener("click", () => {
            const sumberData = document.getElementById("data-selection-permintaan-AI").value;
            const fotoRumahData = localStorage.getItem("preview-image");
            const permintaanAI = document.getElementById("promptInput").value;
            const containerFloatingButton = document.getElementById("container-floating-button");

            if (window.matchMedia("(min-width: 768px)").matches) {
              containerFloatingButton.classList.remove("w-[calc(100%-5.5rem)]", "left-20");
              containerFloatingButton.classList.add("w-[calc(100%-37.5rem)]", "left-[37rem]");
            }

            getPropertyRecommendationsFromAI(sumberData, fotoRumahData, permintaanAI);

            document.getElementById("hapusPilihanAI-button").classList.remove("hidden");

            // Tutup SweetAlert setelah klik cari
            Swal.close();
          });

          history.pushState({ popup: true }, "");
          popupOpen = true;
        },
        willClose: () => {
          popupOpen = false;
          // Kembalikan ke state sebelumnya agar tidak stuck di riwayat
          if (history.state && history.state.popup) {
            history.back();
          }
        },
        width: "50em",
        background: document.documentElement.classList.contains("dark") ? "#1f2937" : "", // bg-gray-800
        color: document.documentElement.classList.contains("dark") ? "#f3f4f6" : "", // text-gray-200
        showCloseButton: true,
        showConfirmButton: false,
        buttonsStyling: false,
      });
    });

    function hitungJumlahKontrakan() {
      const visibleMarkers = [];
      const allMarkers = [];
      const mapBounds = map.getBounds(); // mendapatkan batas viewport saat ini

      markers.eachLayer((layer) => {
        // Periksa apakah layer adalah marker dan memiliki data properti
        if (layer instanceof L.Marker && layer._propertyData) {
          // Tambahkan ke array semua marker
          allMarkers.push(layer._propertyData);

          // Periksa apakah marker terlihat di layar
          if (mapBounds.contains(layer.getLatLng())) {
            visibleMarkers.push(layer._propertyData);
          }
        }
      });

      // Return kedua hasil dalam bentuk object
      return {
        visibleMarkers: visibleMarkers.length,
        allMarkers: allMarkers.length,
      };
    }

    function autoExpandTextarea(textarea) {
      const charCountPromptInput = document.getElementById("char-count-promptInput");
      charCountPromptInput.textContent = textarea.value.length;

      // Atur ulang tinggi ke 'auto' untuk menghitung scrollHeight dengan benar
      textarea.style.height = "auto";
      // Atur tinggi ke scrollHeight, pastikan minimal 48px (h-12) dan maksimal 300px
      const minHeight = 36; // Tinggi awal h-12 (48px)
      const maxHeight = 300; // Tinggi maksimum yang diizinkan (diperbesar)
      textarea.style.height = Math.min(Math.max(textarea.scrollHeight, minHeight), maxHeight) + "px";
    }

    function formatRupiah(input) {
      let value = input.value.replace(/[^0-9]/g, "");
      if (value) {
        input.value = "Rp" + parseInt(value, 10).toLocaleString("id-ID");
      } else {
        input.value = "";
      }
    }

    function formatRupiahText(input) {
      let value = String(input).replace(/[^0-9]/g, "");
      if (value) {
        return "Rp" + parseInt(value, 10).toLocaleString("id-ID");
      } else {
        return "";
      }
    }

    function parseRupiah(value) {
      return parseInt(value.replace(/[^0-9]/g, ""), 10) || 0;
    }

    // Tangani tombol back
    window.addEventListener("popstate", function (event) {
      if (popupOpen) {
        Swal.close();
      }
    });

    function renderSidebar(propertiesToShow) {
      const sidebarHasilPindai = document.getElementById("sidebar-content-hasil-pindai");
      const infobarHasilPindai = document.getElementById("sidebar-content-hasil-pindai-info-bar");
      const containerHasilPindai = document.getElementById("sidebar-content-hasil-pindai-property-list");

      sidebarHasilPindai.classList.remove("hidden");
      map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran

      infobarHasilPindai.innerText = `${propertiesToShow.length} kontrakan ditampilkan`;
      containerHasilPindai.innerHTML = ""; // Kosongkan sidebar
      const fragment = document.createDocumentFragment();

      propertiesToShow.forEach((prop) => {
        const el = document.createElement("div");
        el.className = "property";
        const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;

        el.innerHTML = `
          <div class="cursor-pointer border-b border-gray-200 dark:border-gray-700 py-4">
            <div class="w-full overflow-hidden rounded-l-lg px-4 md:h-auto">
              <img data-src="asset/photos/${prop.foto_kontrakan}" id="${imageId}" alt="Foto tidak bisa ditampilkan" class="w-full h-auto min-h-48 rounded-md bg-gray-100 dark:bg-gray-700 dark:text-gray-200 text-xs object-cover text-center" />
            </div>
            <div class="text-md flex w-full flex-col justify-between px-4">
              <div>
                <div class="grid grid-cols-2 gap-4 my-4">
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Harga</p>
                      <p class="font-bold text-blue-800 dark:text-blue-400">${formatRupiahText(prop.harga_sewa)}</p>
                  </div>
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Ketersediaan</p>
                      <p class="font-semibold ${prop.ketersediaan === "Tersedia" ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400"}">${prop.ketersediaan === "Tersedia" ? "Tersedia" : "Disewa"}</p>
                  </div>
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Jumlah Peminat</p>
                      <p class="font-semibold text-gray-600 dark:text-gray-200">${prop.jumlah_peminat} peminat</p>
                  </div>
                  <div id="info_nomer_data" class="bg-gray-100 p-3 rounded-lg cursor-pointer dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Nomer Data</p>
                      <p class="font-semibold text-gray-600 dark:text-gray-200">No. ${prop.nomer}</p>
                  </div>
                </div>

                <div class="mt-4">
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                    <div id="text-info-kontrakan-swal" class="text-gray-600 text-md max-h-64 overflow-x-clip overflow-y-scroll [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden dark:text-gray-200">
                      ${marked.parse(
                        prop.deskripsi_spesifikasi_kontrakan
                          .replace(/((https?:\/\/|www\.)?[^\s]+\.[a-z]{2,6}[^\s]*)/gi, (match) => {
                            let url = match;
                            // Add https://www. if the URL doesn't have http:// or https://
                            if (!/^https?:\/\//i.test(url)) {
                              if (url.startsWith("www.")) {
                                url = "https://" + url;
                              } else {
                                url = "https://www." + url.replace(/^www\./, "");
                              }
                            }

                            if (url.startsWith("https://www.wa.me") || url.startsWith("https://www.t.me")) {
                              return `<a href="${url}%20-%20[${prop.nomer}]" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}%20-%20[${prop.nomer}]</a>`;
                            }
                            return `<a href="${url}" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}</a>`;
                          })
                          .replace(/^(?!\|)([^\n]+)\n(?!(\||-))/gm, "$1  \n"),
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        el.addEventListener("click", (e) => {
          const openInfo = e.target.closest("#info_nomer_data");
          if (openInfo) {
            e.stopPropagation();
            //  Ganti URL ini dengan URL Google Spreadsheet Anda yang sebenarnya
            const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/10T-cbh9g9Al3G-1fNc0h6cro4ZwhTY6QqLQeXltHF2I/edit?gid=0#gid=0&range=${prop.nomer}:${prop.nomer}`;

            // Membuka URL di tab baru
            window.open(spreadsheetUrl, "_blank");
            return;
          }

          if (prop) {
            map.setView([prop.latitude, prop.longitude], 20);
          }
        });
        fragment.appendChild(el);
      });

      containerHasilPindai.appendChild(fragment);

      // Lazy Load Observer
      const images = containerHasilPindai.querySelectorAll("img[data-src]");
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.removeAttribute("data-src");
            obs.unobserve(img);
          }
        });
      });

      images.forEach((img) => observer.observe(img));
    }

    // Saat peta digerakkan, perbarui daftar properti yang tampak di layar
    function updateVisibleProperties() {
      const bounds = map.getBounds();
      const visible = [];

      markers.eachLayer((layer) => {
        if (layer.getLatLng && bounds.contains(layer.getLatLng())) {
          if (layer._propertyData) {
            visible.push(layer._propertyData);
          }
        }
      });

      renderSidebar(visible);
    }

    // Fungsi untuk toggle sidebar (semua konten bisa toggle)
    function toggleSidebar(activeContentId) {
      const contents = ["sidebar-content-about-us", "sidebar-content-hasil-pindai", "sidebar-content-hasil-AI"];
      const containerFloatingButton = document.getElementById("container-floating-button");
      const isDesktop = window.matchMedia("(min-width: 768px)").matches;
      const activeContent = document.getElementById(activeContentId);

      // Toggle konten yang aktif
      activeContent.classList.toggle("hidden");

      // Sembunyikan semua konten lainnya
      contents.forEach((id) => {
        if (id !== activeContentId) {
          document.getElementById(id).classList.add("hidden");
        }
      });

      // Atur posisi container
      if (isDesktop) {
        if (activeContent.classList.contains("hidden")) {
          containerFloatingButton.classList.add("w-[calc(100%-5.5rem)]", "left-20");
          containerFloatingButton.classList.remove("w-[calc(100%-37.5rem)]", "left-[37rem]");
        } else {
          containerFloatingButton.classList.remove("w-[calc(100%-5.5rem)]", "left-20");
          containerFloatingButton.classList.add("w-[calc(100%-37.5rem)]", "left-[37rem]");
        }
      }
    }

    // Event listeners

    document.getElementById("open-sidebar-menu-button").addEventListener("click", () => {
      document.getElementById("sidebar-menu").classList.remove("hidden");
      document.getElementById("sidebar-menu").classList.add("flex");
      document.getElementById("sidebar-menu").classList.add("md:flex");
    });

    document.getElementById("hide-sidebar-button").addEventListener("click", () => {
      document.getElementById("sidebar-menu").classList.add("hidden");
      document.getElementById("sidebar-menu").classList.remove("flex");
      document.getElementById("sidebar-menu").classList.remove("md:flex");
    });

    document.getElementById("sidebar-menu-button-open-about-us").addEventListener("click", () => {
      toggleSidebar("sidebar-content-about-us");
    });

    document.getElementById("sidebar-menu-button-open-hasil-pindai").addEventListener("click", () => {
      toggleSidebar("sidebar-content-hasil-pindai");
      document.getElementById("sidebar-menu-button-open-hasil-pindai-badge-status").classList.add("hidden");
    });

    document.getElementById("sidebar-menu-button-open-hasil-AI").addEventListener("click", () => {
      toggleSidebar("sidebar-content-hasil-AI");
      document.getElementById("sidebar-menu-button-open-hasil-AI-badge-status").classList.add("hidden");
    });

    document.getElementById("close-button-sidebar-content-about-us").addEventListener("click", function () {
      const leftSidebarContentAboutUs = document.getElementById("sidebar-content-about-us");
      const containerFloatingButton = document.getElementById("container-floating-button");

      leftSidebarContentAboutUs.classList.add("hidden");

      containerFloatingButton.classList.remove("w-[calc(100%-37.5rem)]", "left-[37rem]");
      containerFloatingButton.classList.add("w-[calc(100%-5.5rem)]", "left-20");
    });

    document.getElementById("close-button-sidebar-content-hasil-pindai").addEventListener("click", function () {
      const leftSidebarContentHasilPindai = document.getElementById("sidebar-content-hasil-pindai");
      const containerFloatingButton = document.getElementById("container-floating-button");

      leftSidebarContentHasilPindai.classList.add("hidden");

      containerFloatingButton.classList.remove("w-[calc(100%-37.5rem)]", "left-[37rem]");
      containerFloatingButton.classList.add("w-[calc(100%-5.5rem)]", "left-20");
    });

    document.getElementById("close-button-sidebar-content-hasil-AI").addEventListener("click", function () {
      const leftSidebarContentHasilAI = document.getElementById("sidebar-content-hasil-AI");
      const containerFloatingButton = document.getElementById("container-floating-button");

      leftSidebarContentHasilAI.classList.add("hidden");

      containerFloatingButton.classList.remove("w-[calc(100%-37.5rem)]", "left-[37rem]");
      containerFloatingButton.classList.add("w-[calc(100%-5.5rem)]", "left-20");
    });

    document.getElementById("fullscreen-button").addEventListener("click", function () {
      toggleFullscreen();
    });

    document.getElementById("button-telusuri-area-map").addEventListener("click", function () {
      const containerFloatingButton = document.getElementById("container-floating-button");
      const leftSidebarContentHasilAI = document.getElementById("sidebar-content-hasil-AI");

      leftSidebarContentHasilAI.classList.add("hidden");
      document.getElementById("sidebar-menu-button-open-hasil-pindai-badge-status").classList.remove("hidden");

      if (window.matchMedia("(min-width: 768px)").matches) {
        containerFloatingButton.classList.remove("w-[calc(100%-5.5rem)]", "left-20");
        containerFloatingButton.classList.add("w-[calc(100%-37.5rem)]", "left-[37rem]");
      }

      updateVisibleProperties();
    });

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        // Masuk ke mode fullscreen
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen();
        } else if (document.documentElement.webkitRequestFullscreen) {
          /* Safari */
          document.documentElement.webkitRequestFullscreen();
        } else if (document.documentElement.msRequestFullscreen) {
          /* IE11 */
          document.documentElement.msRequestFullscreen();
        }
      } else {
        // Keluar dari mode fullscreen
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          /* Safari */
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          /* IE11 */
          document.msExitFullscreen();
        }
      }
    }

    function convertToCSV(dataArray) {
      if (!dataArray || dataArray.length === 0) {
        return ""; // Mengembalikan string kosong jika tidak ada data
      }

      // Mengambil header dari objek pertama dalam array
      const headers = Object.keys(dataArray[0]).join(",");

      // Mengonversi setiap objek menjadi baris CSV
      const csvRows = dataArray.map((data) => {
        const values = Object.values(data)
          .map((value) => {
            // Menangani nilai yang mungkin mengandung koma atau kutipan
            if (typeof value === "string" && (value.includes(",") || value.includes('"') || value.includes("\n"))) {
              return `"${value.replace(/"/g, '""')}"`; // Escaping kutipan ganda
            }
            return value;
          })
          .join(",");
        return values;
      });

      // Menggabungkan header dan semua baris data
      return `${headers}\n${csvRows.join("\n")}`;
    }

    function encodeToBase64(textString) {
      try {
        return btoa(
          encodeURIComponent(textString).replace(/%([0-9A-F]{2})/g, function toSolidBytes(match, p1) {
            return String.fromCharCode("0x" + p1);
          }),
        );
      } catch (e) {
        console.error("Error encoding to Base64:", e);
        return "Error during Base64 encoding.";
      }
    }

    /**
     * Ekstrak format dan data base64 murni dari string base64 dengan header
     * @param {string} base64WithHeader - String base64 dengan header (contoh: "data:image/jpeg;base64,/9j/4AA...")
     * @returns {object} - Objek berisi format dan data base64 tanpa header
     */
    function extractBase64ImageData(base64WithHeader) {
      // Validasi input
      if (typeof base64WithHeader !== "string" || !base64WithHeader.startsWith("data:image")) {
        throw new Error("Format base64 tidak valid");
      }

      // Pisahkan header dan data
      const [header, base64Data] = base64WithHeader.split(",");

      // Ekstrak format gambar
      const formatMatch = header.match(/data:image\/(\w+);/);
      if (!formatMatch) {
        throw new Error("Format gambar tidak dikenali");
      }

      const format = `image/${formatMatch[1]}`;

      return {
        format: format, // 'image/jpeg' atau 'image/png'
        base64: base64Data, // Data base64 tanpa header
      };
    }

    // Initial chat history for context
    let chatHistory = [];

    /**
     * Initializes the chat history with a greeting and property data.
     * @returns {void}
     */
    function initializeChatHistory(sumberData, fotoRumahData) {
      // Assuming extractPropertyDataFromMarkers, convertToCSV, and encodeToBase64 are defined elsewhere
      // and correctly extract and format the property data.
      const propertyData = extractPropertyDataFromMarkers(sumberData);
      const csvString = convertToCSV(propertyData);
      const base64EncodedCsv = encodeToBase64(csvString);

      chatHistory.push({
        role: "model",
        parts: [
          {
            text: "Halo! Saya Gemini AI. Bagaimana saya bisa membantu Anda hari ini?",
          },
        ],
      });

      if (fotoRumahData != null && fotoRumahData != "") {
        try {
          const fotoRumahDataExtract = extractBase64ImageData(fotoRumahData);

          chatHistory.push({
            role: "user",
            parts: [
              {
                inlineData: {
                  mimeType: fotoRumahDataExtract.format,
                  data: fotoRumahDataExtract.base64,
                },
              },
            ],
          });
        } catch (error) {
          console.error("Error:", error.message);
        }
      }

      chatHistory.push({
        role: "user",
        parts: [
          {
            inlineData: {
              mimeType: "text/csv",
              data: base64EncodedCsv,
            },
          },
        ],
      });
    }

    /**
     * Sends a prompt to the Gemini API and handles the response.
     * @param {string} userPrompt - The user's input prompt for property recommendations.
     * @returns {Promise<void>}
     */
    async function getPropertyRecommendationsFromAI(sumberData, fotoRumahData, permintaanAI) {
      chatHistory = []; // Clear history for a new request
      initializeChatHistory(sumberData, fotoRumahData); // Re-initialize with current property data

      chatHistory.push({
        role: "user",
        parts: [
          {
            text: `Berdasarkan file csv berisi data kontrakan yang saya berikan.
                   Bantu saya untuk mencari kontrakan yang sesuai dengan permintaan atau kebutuhan dibawah ini berdasarkan data "deskripsi_spesifikasi_kontrakan" dan data "deskripsi_visual_kontrakan".
                   Jika pada permintaan atau kebutuhan di bawah ini menyertakan kriteria atau permintaan yang bersifat visual. maka gunakan data "deskripsi_visual_kontrakan" pada data kontrakan untuk menilai kontrakan tersebut secara visual.
                   Jika saya melampirkan foto atau gambar, maka tambahkan penilaian kepada setiap data kontrakan yang anda rekomendasikan kepada saya. apakah kontrakan tersebut secara visual setara atau lebih baik dibanding foto yang saya berikan. gunakan data "deskripsi_visual_kontrakan" pada setiap kontrakan.
                   Jika sebuah data kontrakan tidak memiliki "deskripsi_visual_kontrakan", maka rekomendasikan berdasarkan data "deskripsi_spesifikasi_kontrakan" saja.
                   Jangan hiraukan data "ketersediaan", "foto_kontrakan", "jumlah_peminat", "latitude" dan "longitude" pada file csv.
                   "deskripsi_spesifikasi_kontrakan" merupakan deskripsi umum mengenai informasi suatu kontrakan pada file csv.
                   "deskripsi_visual_kontrakan" merupakan deskripsi mengenai visual suatu kontrakan pada file csv.
                   Sebutkan hanya "nomer" yaitu yang berisikan nomer data dan "alasan_rekomendasi" yang berisikan mengapa anda merekomendasikan data tersebut dan penilaian anda secara visual (jika ada).
                   Berikan response dalam bentuk json dan tanpa penjelasan tambahan apapun.

                   Format JSON yang diharapkan:
                   [{data 1},{data ke n}]

                   Permintaan atau kebutuhan:
                   ${permintaanAI}
                  `,
          },
        ],
      });

      try {
        displayAIProcessingIndicator();

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=AIzaSyBhWE5SegbNRwsMxqhepwBUZwYRF3mBj6g`;

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: chatHistory,
            generationConfig: {
              responseMimeType: "text/plain",
            },
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API error: ${response.status} - ${errorData.error.message || "Unknown error"}`);
        }

        const result = await response.json();
        const aiResponseText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (aiResponseText) {
          const recommendations = parseJsonResponse(aiResponseText);
          displayAIFinishIndicator();
          renderPropertyRecommendations(recommendations);
          chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
        } else {
          displayErrorMessageAI("AI Model: Could not generate a response or unexpected API response structure.\nUnexpected API response structure:", result);
        }
      } catch (error) {
        displayAIFinishIndicator();
        displayErrorMessageAI(`Error calling Gemini API: ${error.message}`);
      } finally {
      }
    }

    function displayAIProcessingIndicator() {
      const sidebarElement = document.getElementById("sidebar-content-hasil-AI");
      const iconMenuHasilAI = document.getElementById("icon-sidebar-menu-button-open-hasil-AI");
      const infoBarElement = document.getElementById("sidebar-content-hasil-AI-info-bar");
      const propertyListContainer = document.getElementById("sidebar-content-hasil-AI-property-list");

      sidebarElement.classList.remove("hidden");

      map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran

      infoBarElement.innerText = `0 kontrakan ditampilkan`;
      propertyListContainer.innerHTML = ""; // Clear existing content

      const fragment = document.createDocumentFragment();
      const propertyElement = document.createElement("div");
      propertyElement.className = "ai-processing-indicator-spinner";

      iconMenuHasilAI.innerHTML = `
                <svg class="h-8 w-8 animate-spin text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>`;

      propertyElement.innerHTML = `
                <div class="h-full">
                  <div class="flex h-auto flex-col items-center justify-center py-6 text-center">
                    <svg class="h-8 w-8 animate-spin text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-base font-medium text-gray-800 dark:text-gray-200">AI sedang memproses permintaan Anda...</p>
                    <p class="text-sm text-gray-600 dark:text-gray-200">Mohon tunggu sebentar.</p>
                  </div>
                </div>
        `;
      fragment.appendChild(propertyElement);
      propertyListContainer.appendChild(fragment);
    }

    function displayAIFinishIndicator() {
      const iconMenuHasilAI = document.getElementById("icon-sidebar-menu-button-open-hasil-AI");
      document.getElementById("sidebar-menu-button-open-hasil-AI-badge-status").classList.remove("hidden");

      iconMenuHasilAI.innerHTML = `
                <svg class="w-5 fill-gray-500 dark:fill-gray-200" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <g>
                <path fill="none" d="M0 0h24v24H0z" />
                <path d="M5.455 15L1 18.5V3a1 1 0 0 1 1-1h15a1 1 0 0 1 1 1v12H5.455zm-.692-2H16V4H3v10.385L4.763 13zM8 17h10.237L20 18.385V8h1a1 1 0 0 1 1 1v13.5L17.545 19H9a1 1 0 0 1-1-1v-1z" />
              </g>
            </svg>`;
    }

    function displayErrorMessageAI(errorMassage) {
      const sidebarElement = document.getElementById("sidebar-content-hasil-AI");
      const infoBarElement = document.getElementById("sidebar-content-hasil-AI-info-bar");
      const propertyListContainer = document.getElementById("sidebar-content-hasil-AI-property-list");

      sidebarElement.classList.remove("hidden");

      map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran

      infoBarElement.innerText = `0 kontrakan ditampilkan`;
      propertyListContainer.innerHTML = ""; // Clear existing content

      const fragment = document.createDocumentFragment();
      const propertyElement = document.createElement("div");
      propertyElement.className = "error-log";

      propertyElement.innerHTML = `${errorMassage}`;
      fragment.appendChild(propertyElement);
      propertyListContainer.appendChild(fragment);
    }

    /**
     * Extracts and parses a JSON object from a given text string.
     * It looks for a JSON block enclosed in ```json\n...\n```.
     * @param {string} text - The input text potentially containing a JSON block.
     * @returns {Array<Object>|null} The parsed JSON object, or null if no valid JSON block is found or parsing fails.
     */
    function parseJsonResponse(text) {
      const jsonBlockRegex = /```json\n((?:.|\n)*?)\n```/;
      const match = text.match(jsonBlockRegex);

      if (match && match[1]) {
        try {
          return JSON.parse(match[1]);
        } catch (error) {
          displayErrorMessageAI("Error parsing JSON from AI response:", error);
          return null;
        }
      } else {
        displayErrorMessageAI("No valid JSON block found in the AI response text.");
        return null;
      }
    }

    /**
     * Matches AI recommendations with actual property data from markers.
     * @param {Array<Object>} aiRecommendations - An array of property recommendations from the AI.
     * @returns {Array<Object>} An array of objects, each containing marker data and recommendation details.
     */
    function matchPropertiesWithRecommendations(aiRecommendations) {
      const matchedProperties = [];

      // Create a Map for efficient lookup of recommendations by 'nomer'
      const recommendationsMap = new Map(aiRecommendations.filter((rec) => rec.nomer !== undefined).map((rec) => [rec.nomer, rec]));

      // Assuming 'markers' is a global or accessible Leaflet LayerGroup
      if (typeof markers !== "undefined" && markers.eachLayer) {
        markers.eachLayer((layer) => {
          if (layer._propertyData && layer._propertyData.nomer !== undefined) {
            const markerNomer = layer._propertyData.nomer;
            if (recommendationsMap.has(markerNomer)) {
              // tampilkan tooltip untuk marker pilihan AI
              const tooltipContent = `
                <div class=" font-bold px-2 py-1 tracking-wide">
                    Kontrakan Pilihan AI
                </div>
              `;

              layer.bindTooltip(tooltipContent, {
                direction: "top",
                permanent: true, // Tooltip hanya muncul saat hover
                className: "custom-tooltip", // Optional: untuk styling khusus
                offset: [20, -30], // Adjust posisi tooltip
              });

              // simpan data untuk nilai return
              matchedProperties.push({
                markerData: layer._propertyData,
                recommendationDetails: recommendationsMap.get(markerNomer),
              });
            }
          }
        });
      } else {
        console.warn("Leaflet 'markers' LayerGroup not found or not accessible.");
      }

      return matchedProperties;
    }

    /**
     * Renders the recommended properties in the sidebar.
     * @param {Array<Object>} aiRecommendations - The array of parsed AI recommendations.
     * @returns {void}
     */
    function renderPropertyRecommendations(aiRecommendations) {
      const sidebarHasilAI = document.getElementById("sidebar-content-hasil-AI");
      const infobarHasilAI = document.getElementById("sidebar-content-hasil-AI-info-bar");
      const containerHasilAI = document.getElementById("sidebar-content-hasil-AI-property-list");

      sidebarHasilAI.classList.remove("hidden");

      const recommendedProperties = matchPropertiesWithRecommendations(aiRecommendations);

      map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran

      infobarHasilAI.innerText = `${recommendedProperties.length} kontrakan ditampilkan`;
      containerHasilAI.innerHTML = ""; // Clear existing content

      const fragment = document.createDocumentFragment();

      recommendedProperties.forEach((prop) => {
        const propertyElement = document.createElement("div");
        propertyElement.className = "property";
        const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;

        propertyElement.innerHTML = `
          <div class="cursor-pointer border-b border-gray-200 dark:border-gray-700 py-4">
            <div class="w-full overflow-hidden rounded-l-lg px-4 md:h-auto">
              <img data-src="asset/photos/${prop.markerData.foto_kontrakan}" id="${imageId}" alt="Foto tidak bisa ditampilkan" class="w-full h-auto min-h-48 rounded-md bg-gray-100 dark:bg-gray-700 dark:text-gray-200 text-xs object-cover text-center" />
            </div>

            <div class="m-4">
              <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-700">
                <div class="mb-2 flex items-center gap-1 text-gray-700 dark:text-gray-200">
                  <svg class="w-5 fill-blue-500 dark:fill-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12ZM12 17.75C12.4142 17.75 12.75 17.4142 12.75 17V11C12.75 10.5858 12.4142 10.25 12 10.25C11.5858 10.25 11.25 10.5858 11.25 11V17C11.25 17.4142 11.5858 17.75 12 17.75ZM12 7C12.5523 7 13 7.44772 13 8C13 8.55228 12.5523 9 12 9C11.4477 9 11 8.55228 11 8C11 7.44772 11.4477 7 12 7Z"></path>
                  </svg>
                  <div>
                    <span class="font-semibold">Catatan:</span>
                    Informasi ini dihasilkan oleh model AI.
                  </div>
                </div>
                <div id="result-display" class="text-justify leading-relaxed text-blue-800 dark:text-blue-200">${marked.parse(prop.recommendationDetails.alasan_rekomendasi)}</div>
              </div>
            </div>

            <div class="text-md flex w-full flex-col justify-between px-4">
              <div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Harga</p>
                      <p class="font-bold text-blue-800 dark:text-blue-400">${formatRupiahText(prop.markerData.harga_sewa)}</p>
                  </div>
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Ketersediaan</p>
                      <p class="font-semibold ${prop.markerData.ketersediaan === "Tersedia" ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400"}">${prop.markerData.ketersediaan === "Tersedia" ? "Tersedia" : "Disewa"}</p>
                  </div>
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Jumlah Peminat</p>
                      <p class="font-semibold text-gray-600 dark:text-gray-200">${prop.markerData.jumlah_peminat} peminat</p>
                  </div>
                  <div id="info_nomer_data" class="bg-gray-100 p-3 rounded-lg cursor-pointer dark:bg-gray-700">
                      <p class="text-gray-500 text-sm dark:text-gray-200">Nomer Data</p>
                      <p class="font-semibold text-gray-600 dark:text-gray-200">No. ${prop.markerData.nomer}</p>
                  </div>
                </div>

                <div class="mt-4">
                  <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-700">
                    <div id="text-info-kontrakan-swal" class="text-gray-600 text-md max-h-64 overflow-x-clip overflow-y-scroll [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden dark:text-gray-200">
                      ${marked.parse(
                        prop.markerData.deskripsi_spesifikasi_kontrakan
                          .replace(/((https?:\/\/|www\.)?[^\s]+\.[a-z]{2,6}[^\s]*)/gi, (match) => {
                            let url = match;
                            // Add https://www. if the URL doesn't have http:// or https://
                            if (!/^https?:\/\//i.test(url)) {
                              if (url.startsWith("www.")) {
                                url = "https://" + url;
                              } else {
                                url = "https://www." + url.replace(/^www\./, "");
                              }
                            }

                            if (url.startsWith("https://www.wa.me") || url.startsWith("https://www.t.me")) {
                              return `<a href="${url}%20-%20[${prop.nomer}]" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}%20-%20[${prop.nomer}]</a>`;
                            }
                            return `<a href="${url}" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}</a>`;
                          })
                          .replace(/^(?!\|)([^\n]+)\n(?!(\||-))/gm, "$1  \n"),
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        propertyElement.addEventListener("click", (e) => {
          const openInfo = e.target.closest("#info_nomer_data");
          if (openInfo) {
            //  Ganti URL ini dengan URL Google Spreadsheet Anda yang sebenarnya
            const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/10T-cbh9g9Al3G-1fNc0h6cro4ZwhTY6QqLQeXltHF2I/edit?gid=0#gid=0&range=${prop.markerData.nomer}:${prop.markerData.nomer}`;

            // Membuka URL di tab baru
            window.open(spreadsheetUrl, "_blank");
            return;
          }

          if (prop) {
            map.setView([prop.markerData.latitude, prop.markerData.longitude], 20);
          }
        });
        fragment.appendChild(propertyElement);
      });

      containerHasilAI.appendChild(fragment);

      // Lazy Load Observer
      const images = containerHasilAI.querySelectorAll("img[data-src]");
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.removeAttribute("data-src");
            obs.unobserve(img);
          }
        });
      });

      images.forEach((img) => observer.observe(img));
    }

    // --- Helper Functions (assuming they exist elsewhere or need to be defined) ---

    /**
     * Placeholder for a function that extracts property data from map markers.
     * @returns {Array<Object>} An array of property data objects.
     */
    function extractPropertyDataFromMarkers(sumberData) {
      const allPropertyData = []; // Mengganti 'combine' dengan 'allPropertyData'
      const mapBounds = map.getBounds(); // mendapatkan batas viewport saat ini

      if (sumberData == "all") {
        // Asumsi 'markers' adalah objek/koleksi layer peta (misalnya dari Leaflet.js)
        // dan memiliki metode 'eachLayer'
        markers.eachLayer((layer) => {
          // Memeriksa apakah layer memiliki properti '_propertyData' yang berisi data properti
          if (layer._propertyData) {
            allPropertyData.push(layer._propertyData);
          }
        });

        return allPropertyData;
      }

      if (sumberData == "visible") {
        // Asumsi 'markers' adalah objek/koleksi layer peta (misalnya dari Leaflet.js)
        // dan memiliki metode 'eachLayer'
        markers.eachLayer((layer) => {
          // Periksa apakah layer adalah marker dan berada dalam viewport
          if (layer instanceof L.Marker && mapBounds.contains(layer.getLatLng())) {
            // Memeriksa apakah layer memiliki properti '_propertyData' yang berisi data properti
            if (layer._propertyData) {
              allPropertyData.push(layer._propertyData);
            }
          }
        });

        return allPropertyData;
      }
    }

    /**
     * Converts an array of objects into a CSV string.
     * @param {Array<Object>} data - The array of data to convert.
     * @returns {string} The CSV formatted string.
     */
    function convertToCSV(data) {
      if (!data || data.length === 0) {
        return "";
      }

      const headers = Object.keys(data[0]);
      const csvRows = [
        headers.join(","), // CSV Header
        ...data.map((row) =>
          headers
            .map((fieldName) => {
              const value = row[fieldName];
              // Handle values that might contain commas or newlines by enclosing them in double quotes
              if (value === null || value === undefined) {
                return "";
              }
              const stringValue = String(value);
              if (stringValue.includes(",") || stringValue.includes("\n") || stringValue.includes('"')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
              }
              return stringValue;
            })
            .join(","),
        ),
      ];

      return csvRows.join("\n");
    }

    /**
     * Encodes a string to Base64.
     * @param {string} str - The string to encode.
     * @returns {string} The Base64 encoded string.
     */
    function encodeToBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }
  </script>
</html>
