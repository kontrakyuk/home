<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Temukan rumah kontrakan" />
    <meta name="keywords" content="sewa kontrakan rumah, ruko, gedung, apartemen" />
    <meta name="author" content="kontrak yuk" />
    <title>Cari dan Sewa Kontrakan Secara Online di KontrakYuk</title>
    <link rel="icon" href="asset/logo.png" />
    <link rel="stylesheet" href="asset/leaflet.css" />

    <link rel="stylesheet" href="asset/MarkerCluster.css" />
    <link rel="stylesheet" href="asset/MarkerCluster.Default.css" />

    <link rel="stylesheet" href="asset/Control.Geocoder.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <!-- Add the tailwind.css if you want default styling -->
    <link rel="stylesheet" type="text/css" href="asset/tailwind.css" />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      .swal2-backdrop-show {
        z-index: 100000;
      }

      #text-info-kontrakan-swal > * {
        padding-bottom: 0.5rem;
      }

      #text-info-kontrakan-swal table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
        background: #f8f5f2;
        color: #3a3226;
        border-radius: 8px;
        overflow: hidden;
        font-family: "Noto Sans JP", sans-serif;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      #text-info-kontrakan-swal table thead {
        background: #e8e0d9;
      }

      #text-info-kontrakan-swal table th {
        padding: 12px 16px;
        text-align: left;
        font-weight: bold;
        border-bottom: 1px solid #d6ccc2;
      }

      #text-info-kontrakan-swal table td {
        padding: 12px 16px;
        border-bottom: 1px solid #e8e0d9;
      }

      #text-info-kontrakan-swal table tr:last-child td {
        border-bottom: none;
      }

      /* Alignment sesuai markdown */
      #text-info-kontrakan-swal table td[align="right"],
      #text-info-kontrakan-swal table th[align="right"] {
        text-align: right;
      }

      #text-info-kontrakan-swal table td[align="center"],
      #text-info-kontrakan-swal table th[align="center"] {
        text-align: center;
      }

      /* Style untuk link dalam tabel */
      #text-info-kontrakan-swal table a {
        color: #6b7b8e;
        text-decoration: underline;
        transition: color 0.2s;
      }

      #text-info-kontrakan-swal table a:hover {
        color: #3a3226;
        text-decoration: none;
      }

      /* Animasi khusus untuk dots alternatif */
      .typing-dots .dot-1 {
        animation: typingAnimation 1.2s infinite ease-in-out;
      }
      .typing-dots .dot-2 {
        animation: typingAnimation 1.2s infinite ease-in-out;
        animation-delay: 0.2s;
      }
      .typing-dots .dot-3 {
        animation: typingAnimation 1.2s infinite ease-in-out;
        animation-delay: 0.4s;
      }

      @keyframes typingAnimation {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 1;
        }
        30% {
          transform: translateY(-5px);
          opacity: 0.8;
        }
      }

      /* CSS untuk Efek Gelombang Analisa */
      .analysis-wave {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: rgba(0, 150, 255, 0.4);
        pointer-events: none;
        z-index: 998;
        transform: translate(-50%, -50%) scale(0);
        animation: wave-scan 0.8s ease-out forwards;
      }

      @keyframes wave-scan {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(0);
          filter: brightness(1.5);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(50);
          filter: brightness(1);
        }
      }

      .analysis-wave-reverse {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: rgba(0, 150, 255, 0.4);
        pointer-events: none;
        z-index: 998;
        /* Mulai dari posisi akhir animasi asli */
        transform: translate(-50%, -50%) scale(50);
        /* Gunakan animasi baru */
        animation: reverse-wave-scan 0.8s ease-out forwards;
      }

      /* Keyframes untuk animasi kebalikan (Kontraksi dan Muncul) */
      @keyframes reverse-wave-scan {
        0% {
          /* Nilai Awal (kebalikan dari 100% animasi asli) */
          opacity: 0;
          transform: translate(-50%, -50%) scale(50);
          filter: brightness(1);
        }
        100% {
          /* Nilai Akhir (kebalikan dari 0% animasi asli) */
          opacity: 1;
          transform: translate(-50%, -50%) scale(0);
          filter: brightness(1.5);
        }
      }

      /* Efek Zoom Peta */
      #map.map-zoom-effect {
        animation: map-scale-in-out 0.4s ease-out forwards;
        transform-origin: center center;
      }

      @keyframes map-scale-in-out {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Tambahkan kursor crosshair saat menggambar */
      .drawing-active {
        cursor: crosshair !important;
      }

      /* ======================================================= */
      /* --- CSS BARU UNTUK GRID OVERLAY --- */
      /* ======================================================= */
      /* GRID LIGHT MODE */
      #map.drawing-active-grid::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 500;
        /* Gabungan 4 gradien:
     * 1 & 2: Garis Mayor (50px, sedikit lebih tebal/gelap)
     * 3 & 4: Garis Minor (10px, sangat tipis/samar)
     */
        background-image:
        /* Garis Mayor (50px) - Mode Terang */
          linear-gradient(to right, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
          /* Garis Minor (10px) - Mode Terang */ linear-gradient(to right, rgba(0, 0, 0, 0.06) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(0, 0, 0, 0.06) 1px, transparent 1px);

        /* Ukuran pengulangan: Pasangan (Mayor, Mayor, Minor, Minor) */
        background-size:
          50px 50px,
          50px 50px,
          10px 10px,
          10px 10px;
        background-position:
          -1px -1px,
          -1px -1px,
          -1px -1px,
          -1px -1px; /* Mengatasi potensi masalah ketidaksempurnaan 1px */
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
      }

      /* * GRID DARK MODE:
 * Mengubah gradien ke warna putih/terang dengan opasitas rendah.
 */
      .dark #map.drawing-active-grid::after {
        background-image:
        /* Garis Mayor (50px) - Mode Gelap */
          linear-gradient(to right, rgba(255, 255, 255, 0.15) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 1px, transparent 1px),
          /* Garis Minor (10px) - Mode Gelap */ linear-gradient(to right, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
      }

      #map:not(.drawing-active-grid)::after {
        opacity: 0;
      }
      .leaflet-tile-container {
        pointer-events: none;
      }

      /* ======================================================= */
      /* --- CSS BARU UNTUK SWEETALERT DARK MODE --- */
      /* ======================================================= */
      /* Kelas kustom yang akan kita tambahkan ke SweetAlert saat Dark Mode aktif */
      .dark-mode-swal {
        background: #333333 !important; /* Latar belakang gelap */
        color: #f0f0f0 !important; /* Teks terang */
      }

      /* Menyesuaikan tombol konfirmasi di Dark Mode */
      .dark-mode-swal .swal2-confirm {
        background-color: #10b981 !important; /* Warna hijau emerald yang lebih cerah/sesuai tema */
        color: white !important;
      }

      /* Menyesuaikan Progress Bar untuk mode gelap */
      .dark-mode-swal .swal2-timer-progress-bar {
        background: #f0f0f0 !important;
      }

      /* Menyesuaikan ikon loading agar terlihat */
      .dark-mode-swal .swal2-loading {
        border-color: #f0f0f0 transparent #f0f0f0 transparent !important;
      }

      .markdown-preview ul,
      .markdown-preview ol {
        margin-left: 1.5rem;
        padding-left: 0;
      }
      .markdown-preview ul li {
        list-style-type: disc;
      }
      .markdown-preview ol li {
        list-style-type: decimal;
      }

      /* Override default Leaflet popup style untuk memastikan tampilan Tailwind */
      .leaflet-popup-content-wrapper {
        padding: 0; /* Hapus padding default Leaflet */
        border-radius: 8px; /* Sudut membulat */
      }
      .leaflet-popup-content {
        margin: 0; /* Hapus margin default Leaflet */
        padding: 0 !important; /* Pastikan padding Tailwind yang dipakai */
      }
      .leaflet-popup-tip {
        /* Tentukan warna pointer/segitiga popup agar sesuai dengan background (opsional) */
        background: #ffffff;
      }

      /* -------------------------------------- */
      /* --- STYLING KONTROL TOMBOL UTAMA --- */
      /* -------------------------------------- */

      /* Menggunakan L.DomUtil.create('div', 'leaflet-bar') di JS */

      /* Style Tombol Dasar (Disesuaikan seperti tombol Leaflet standar) */
      .leaflet-control-btn {
        background-color: white;
        cursor: pointer;
        width: 34px;
        height: 34px;
        display: flex;
        justify-content: center;
        align-items: center;

        /* Hapus semua styling kustom sebelumnya */
        margin: 0;
        box-shadow: none;
        border: none;

        /* Tetapkan gaya yang mirip dengan tombol zoom Leaflet */
        border-bottom: 1px solid #ccc; /* Pemisah antara tombol */
      }

      /* Hapus border pada tombol terakhir (Tombol Stop) */
      .leaflet-control-locate-group .leaflet-control-btn:last-child {
        border-bottom: none;
      }

      .leaflet-control-btn:hover {
        background-color: #f4f4f4;
      }

      .leaflet-control-btn i {
        color: #333;
        font-size: 1.2em;
      }

      /* Dalam file CSS Anda atau tag <style> */
      /* Pastikan ini dimuat setelah Tailwind CSS */

      .custom-popup-wilayah-seleksi .leaflet-popup-content-wrapper {
        /* Set background to transparent or apply standard light theme */
        background: transparent !important;
      }

      /* LOGIKA DARK MODE:
   Ketika elemen <html> memiliki kelas .dark, kita targetkan elemen popup
   yang berada di bawahnya (biasanya di body/global) 
*/
      html.dark .custom-popup-wilayah-seleksi .leaflet-popup-content-wrapper,
      html.dark .custom-popup-wilayah-seleksi .leaflet-popup-tip {
        /* Secara default, ini adalah elemen yang disuntikkan Leaflet 
      yang perlu dibuat gelap jika menggunakan background CSS bawaan Leaflet.
      Namun, karena kita menggunakan styling Tailwind di dalam popupContent,
      kita hanya perlu menargetkan panah (tip) dan wrapper.
    */
        background: #1f2937 !important; /* Contoh: gray-800 */
        color: #f3f4f6 !important; /* Contoh: gray-100 */
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.5) !important;
      }

      /* Perbaikan untuk panah popup Leaflet (tip) */
      html.dark .custom-popup-wilayah-seleksi .leaflet-popup-tip {
        background: #1f2937 !important; /* Harus sama dengan background wrapper */
      }

      /* Pastikan konten di dalam popup tidak terpengaruh oleh styling global Leaflet */
      html.dark .custom-popup-wilayah-seleksi .leaflet-popup-content {
        color: inherit; /* Mencegah Leaflet memaksa warna teks */
      }

      /* Styling Dark Mode untuk SweetAlert2 Toast Penghapusan Polygon (swal2-remove-polygon-done-dark-mode-popup) */

      /*
        Hanya targetkan elemen Swal yang memiliki custom class 
        DAN ketika elemen <html> memiliki kelas 'dark'.
      */
      html.dark .swal2-remove-polygon-done-dark-mode-popup {
        /* Background Toast: Cocok dengan dark:bg-gray-800 (#1f2937) */
        background-color: #1f2937 !important;

        /* Warna teks utama */
        color: #f3f4f6 !important; /* gray-100 */

        /* Shadow yang lebih gelap */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.7) !important;
      }

      /* Teks dan Icon Status di dalam Toast */
      html.dark .swal2-remove-polygon-done-dark-mode-popup .swal2-title,
      html.dark .swal2-remove-polygon-done-dark-mode-popup .swal2-content {
        color: #f3f4f6 !important; /* Teks putih/terang */
      }

      /* Progres Bar Timer (Gaya Dark Mode) */
      html.dark .swal2-remove-polygon-done-dark-mode-popup .swal2-timer-progress-bar {
        /* Warna progres bar saat dark mode */
        background: rgba(255, 255, 255, 0.2) !important;
      }

      /* Pastikan ikon (misalnya, ikon success) tetap terlihat jelas */
      /* Ikon standar SweetAlert2 biasanya menyesuaikan secara otomatis, tapi ini untuk kehati-hatian */
      html.dark .swal2-remove-polygon-done-dark-mode-popup .swal2-success-line-tip,
      html.dark .swal2-remove-polygon-done-dark-mode-popup .swal2-success-line-long {
        background-color: #4ade80 !important; /* Contoh warna hijau terang (green-400) */
      }

      /* Styling Tombol Stop (Ikon Times/Silang) */
      #stop-btn {
        color: #d9534f;
      }

      /* Aktifkan mode Mengikuti Peta */
      .active-tracking {
        background-color: #e6f3ff;
      }

      .active-tracking i {
        color: #1a73e8; /* Biru Google Maps */
      }

      /* -------------------------------------- */
      /* --- MARKER ANIMASI KUSTOM --- */
      /* -------------------------------------- */

      .location-marker-container {
        width: 64px;
        height: 64px;
        position: absolute;
        top: -32px;
        left: -32px;
      }

      .location-marker-pulse {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: rgba(26, 115, 232, 0.4);
        opacity: 0;
        animation: pulse-animation 2s infinite ease-out;
        transform: scale(0.1);
      }

      @keyframes pulse-animation {
        0% {
          transform: scale(0.1);
          opacity: 0;
        }
        50% {
          transform: scale(0.6);
          opacity: 0.5;
        }
        100% {
          transform: scale(1);
          opacity: 0;
        }
      }

      /* ELEMEN BARU: Titik Inti Biru Solid (menggantikan L.circleMarker) */
      .location-marker-core {
        width: 24px; /* Diameter: 2 * radius 12 */
        height: 24px;
        border-radius: 50%;
        background-color: #1a73e8; /* Biru inti */
        border: 2px solid white; /* Border putih */
        position: absolute;
        /* KUNCI: Menempatkan di tengah wadah 64x64px */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10; /* Pastikan core di atas pulse */
      }
    </style>
  </head>

  <body>
    <!-- Open Menu Sidebar -->
    <div id="open-sidebar-menu" class="pointer-events-none fixed bottom-2 left-0 right-0 z-[1200] flex justify-center px-4">
      <div class="pointer-events-auto flex h-[64px] items-center justify-between rounded-full border border-white/20 bg-gray-200 p-2 shadow-2xl backdrop-blur-xl transition-all duration-300 dark:border-gray-700/50 dark:bg-gray-900/80">
        <button id="open-sidebar-menu-button" class="pointer-events-auto flex h-12 w-12 cursor-pointer items-center justify-center rounded-full bg-gray-100 transition-colors hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700">
          <svg class="w-7 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 6H20M4 12H20M4 18H20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Menu Sidebar -->
    <div class="pointer-events-none fixed bottom-2 left-0 right-0 z-[1200] flex justify-center px-4">
      <div id="sidebar-menu" class="pointer-events-auto flex h-[64px] min-w-[180px] items-center justify-between rounded-full border border-gray-200 bg-white/10 p-2 shadow-2xl backdrop-blur-xl transition-all duration-300 dark:border-gray-700/50 dark:bg-gray-900/80">
        <button id="hide-sidebar-button" class="flex h-12 w-12 cursor-pointer items-center justify-center rounded-full bg-gray-100 transition-colors hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700">
          <svg class="w-7 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 6H20M4 12H20M4 18H20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>

        <!-- Garis pemisah -->
        <div class="border-s-1 mx-2 h-10 border-solid border-gray-300 dark:border-gray-400"></div>

        <div id="container-side-menu" class="[&amp;::-webkit-scrollbar]:hidden mx-auto flex flex-1 overflow-x-scroll pr-0 [-ms-overflow-style:none] [scrollbar-width:none] md:pr-2">
          <!-- kumpulan fitur -->
          <div class="[&amp;::-webkit-scrollbar]:hidden flex h-fit w-full flex-row items-center justify-between gap-5 overflow-x-auto [-ms-overflow-style:none] [scrollbar-width:none]">
            <!-- Ikon Brand -->
            <button id="sidebar-menu-button-open-about-us" class="relative flex min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <svg class="w-5 stroke-red-600 dark:stroke-red-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.36407 12.9579C1.98463 10.3208 1.79491 9.00229 2.33537 7.87495C2.87583 6.7476 4.02619 6.06234 6.32691 4.69181L7.71175 3.86687C9.80104 2.62229 10.8457 2 12 2C13.1543 2 14.199 2.62229 16.2882 3.86687L17.6731 4.69181C19.9738 6.06234 21.1242 6.7476 21.6646 7.87495C22.2051 9.00229 22.0154 10.3208 21.6359 12.9579L21.3572 14.8952C20.8697 18.2827 20.626 19.9764 19.451 20.9882C18.2759 22 16.5526 22 13.1061 22H10.8939C7.44737 22 5.72409 22 4.54903 20.9882C3.37396 19.9764 3.13025 18.2827 2.64284 14.8952L2.36407 12.9579Z" stroke-width="2.2" />
                <path d="M9 16C9.85038 16.6303 10.8846 17 12 17C13.1154 17 14.1496 16.6303 15 16" stroke-width="2.2" stroke-linecap="round" />
              </svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Tentang Kami</span>
            </button>

            <!-- Ikon tampilkan map-->
            <button id="sidebar-menu-button-tampilkan-map" class="relative flex min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <svg class="w-5 fill-green-600 dark:fill-green-300" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12.0036 14.0035C14.4889 14.0035 16.5036 11.9887 16.5036 9.50347C16.5036 7.01819 14.4889 5.00347 12.0036 5.00347C9.51831 5.00347 7.50359 7.01819 7.50359 9.50347C7.50359 11.9887 9.51831 14.0035 12.0036 14.0035ZM12.0036 12.0071C10.6209 12.0071 9.5 10.8862 9.5 9.50347C9.5 8.12077 10.6209 6.99988 12.0036 6.99988C13.3863 6.99988 14.5072 8.12077 14.5072 9.50347C14.5072 10.8862 13.3863 12.0071 12.0036 12.0071Z" />
                <path fill-rule="evenodd" clip-rule="evenodd" d="M21.272 11.5818C22.5649 5.78816 18.0052 0.00354004 12 0.00354004C5.99649 0.00354004 1.43639 5.7961 2.72816 11.5825C3.72523 16.2821 7.7572 20.8465 10.1636 23.2269C11.1942 24.2463 12.8058 24.2463 13.8364 23.2269C16.2429 20.8464 20.2752 16.2816 21.272 11.5818ZM12 2.00354C16.7124 2.00354 20.3368 6.58981 19.32 11.1462C18.8316 13.3355 17.7359 15.3015 16.4501 17.119C15.1064 19.0184 13.5829 20.6644 12.4299 21.805C12.1786 22.0536 11.8214 22.0536 11.5701 21.805C10.4171 20.6645 8.89379 19.0186 7.55009 17.1193C6.26419 15.3017 5.16886 13.3361 4.68011 11.1467C3.66438 6.59682 7.29012 2.00354 12 2.00354Z" />
              </svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Tampilan Peta</span>
            </button>

            <!-- Ikon tampilkan list data-->
            <button id="sidebar-menu-button-tampilkan-list-data" class="relative flex hidden min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <svg class="w-5 text-green-600 dark:text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Tampilan List</span>
            </button>

            <!-- Ikon filter data -->
            <button id="sidebar-menu-button-filter-data" class="relative flex min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <span id="sidebar-menu-button-filter-indicator" class="absolute right-3 top-0 hidden h-1.5 w-1.5 rounded-full bg-red-400"></span>

              <svg class="w-5 stroke-green-600 dark:stroke-green-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3H5C3.58579 3 2.87868 3 2.43934 3.4122C2 3.8244 2 4.48782 2 5.81466V6.50448C2 7.54232 2 8.06124 2.2596 8.49142C2.5192 8.9216 2.99347 9.18858 3.94202 9.72255L6.85504 11.3624C7.49146 11.7206 7.80967 11.8998 8.03751 12.0976C8.51199 12.5095 8.80408 12.9935 8.93644 13.5872C9 13.8722 9 14.2058 9 14.8729L9 17.5424C9 18.452 9 18.9067 9.25192 19.2613C9.50385 19.6158 9.95128 19.7907 10.8462 20.1406C12.7248 20.875 13.6641 21.2422 14.3321 20.8244C15 20.4066 15 19.4519 15 17.5424V14.8729C15 14.2058 15 13.8722 15.0636 13.5872C15.1959 12.9935 15.488 12.5095 15.9625 12.0976C16.1903 11.8998 16.5085 11.7206 17.145 11.3624L20.058 9.72255C21.0065 9.18858 21.4808 8.9216 21.7404 8.49142C22 8.06124 22 7.54232 22 6.50448V5.81466C22 4.48782 22 3.8244 21.5607 3.4122C21.1213 3 20.4142 3 19 3Z" stroke-width="1.9" />
              </svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Filter Data</span>
            </button>

            <!-- Ikon Mode Pilih wilayah-->
            <button id="sidebar-menu-button-pilih-wilayah" class="relative flex hidden min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <svg class="w-5 fill-none stroke-green-600 dark:stroke-green-300" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.9984 2H2V4.9984H4.9984V2Z" stroke-width="1.4992" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M4.99854 3.50098H18.9987" stroke-width="1.50335" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M3.5 4.99854V19.0005" stroke-width="1.35589" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M20.4978 5V19.002" stroke-width="1.35589" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M4.99854 20.501H18.9987" stroke-width="1.50335" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M4.9984 19H2V21.9984H4.9984V19Z" stroke-width="1.4992" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M21.9974 2.00195H18.999V5.00035H21.9974V2.00195Z" stroke-width="1.4992" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M21.9974 19.002H18.999V22.0004H21.9974V19.002Z" stroke-width="1.4992" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.9966 15.002L7.99658 8.00195L14.9966 11.002L11.9986 12.0009L10.9966 15.002Z" stroke-width="1.5" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path fill-rule="evenodd" clip-rule="evenodd" d="M11.999 12.002L14.997 15.002L11.999 12.002Z" stroke-width="1.5" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Seleksi Wilayah</span>
            </button>

            <!-- Ikon Kembali Ke Mode Normal / Cursor-->
            <button id="sidebar-menu-button-mode-cursor" class="relative flex hidden min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <svg class="w-5 fill-none stroke-green-600 dark:stroke-green-300" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.5 14L9.81494 17.0207C9.27003 17.6337 8.25949 17.3662 8.0893 16.5638L5.56782 4.67685C5.37436 3.76482 6.42406 3.1076 7.15999 3.67999L16.8784 11.2388C17.5366 11.7507 17.316 12.796 16.507 12.9983L12.5 14ZM12.5 14L16.5 20" stroke-width="2" stroke-linecap="round" />
              </svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Mode Normal</span>
            </button>

            <!-- Ikon Hasil AI -->
            <button id="sidebar-menu-button-open-hasil-AI" class="relative flex min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <span id="sidebar-menu-button-open-hasil-AI-indicator" class="absolute right-3 top-0 hidden h-1.5 w-1.5 rounded-full bg-red-400"></span>

              <div id="icon-sidebar-menu-button-open-hasil-AI">
                <svg class="w-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    class="w-7 fill-blue-600 dark:fill-blue-300"
                    d="M13.0867 21.3877L13.7321 21.7697L13.0867 21.3877ZM13.6288 20.4718L12.9833 20.0898L13.6288 20.4718ZM10.3712 20.4718L9.72579 20.8539H9.72579L10.3712 20.4718ZM10.9133 21.3877L11.5587 21.0057L10.9133 21.3877ZM2.3806 15.9134L3.07351 15.6264V15.6264L2.3806 15.9134ZM7.78958 18.9915L7.77666 19.7413L7.78958 18.9915ZM5.08658 18.6194L4.79957 19.3123H4.79957L5.08658 18.6194ZM21.6194 15.9134L22.3123 16.2004V16.2004L21.6194 15.9134ZM16.2104 18.9915L16.1975 18.2416L16.2104 18.9915ZM18.9134 18.6194L19.2004 19.3123H19.2004L18.9134 18.6194ZM19.6125 2.7368L19.2206 3.37628L19.6125 2.7368ZM21.2632 4.38751L21.9027 3.99563V3.99563L21.2632 4.38751ZM4.38751 2.7368L3.99563 2.09732V2.09732L4.38751 2.7368ZM2.7368 4.38751L2.09732 3.99563H2.09732L2.7368 4.38751ZM9.40279 19.2098L9.77986 18.5615L9.77986 18.5615L9.40279 19.2098ZM13.7321 21.7697L14.2742 20.8539L12.9833 20.0898L12.4412 21.0057L13.7321 21.7697ZM9.72579 20.8539L10.2679 21.7697L11.5587 21.0057L11.0166 20.0898L9.72579 20.8539ZM12.4412 21.0057C12.2485 21.3313 11.7515 21.3313 11.5587 21.0057L10.2679 21.7697C11.0415 23.0767 12.9585 23.0767 13.7321 21.7697L12.4412 21.0057ZM10.5 2.75H13.5V1.25H10.5V2.75ZM21.25 10.5V11.5H22.75V10.5H21.25ZM2.75 11.5V10.5H1.25V11.5H2.75ZM1.25 11.5C1.25 12.6546 1.24959 13.5581 1.29931 14.2868C1.3495 15.0223 1.45323 15.6344 1.68769 16.2004L3.07351 15.6264C2.92737 15.2736 2.84081 14.8438 2.79584 14.1847C2.75041 13.5189 2.75 12.6751 2.75 11.5H1.25ZM7.8025 18.2416C6.54706 18.2199 5.88923 18.1401 5.37359 17.9265L4.79957 19.3123C5.60454 19.6457 6.52138 19.7197 7.77666 19.7413L7.8025 18.2416ZM1.68769 16.2004C2.27128 17.6093 3.39066 18.7287 4.79957 19.3123L5.3736 17.9265C4.33223 17.4951 3.50486 16.6678 3.07351 15.6264L1.68769 16.2004ZM21.25 11.5C21.25 12.6751 21.2496 13.5189 21.2042 14.1847C21.1592 14.8438 21.0726 15.2736 20.9265 15.6264L22.3123 16.2004C22.5468 15.6344 22.6505 15.0223 22.7007 14.2868C22.7504 13.5581 22.75 12.6546 22.75 11.5H21.25ZM16.2233 19.7413C17.4786 19.7197 18.3955 19.6457 19.2004 19.3123L18.6264 17.9265C18.1108 18.1401 17.4529 18.2199 16.1975 18.2416L16.2233 19.7413ZM20.9265 15.6264C20.4951 16.6678 19.6678 17.4951 18.6264 17.9265L19.2004 19.3123C20.6093 18.7287 21.7287 17.6093 22.3123 16.2004L20.9265 15.6264ZM13.5 2.75C15.1512 2.75 16.337 2.75079 17.2619 2.83873C18.1757 2.92561 18.7571 3.09223 19.2206 3.37628L20.0044 2.09732C19.2655 1.64457 18.4274 1.44279 17.4039 1.34547C16.3915 1.24921 15.1222 1.25 13.5 1.25V2.75ZM22.75 10.5C22.75 8.87781 22.7508 7.6085 22.6545 6.59611C22.5572 5.57256 22.3554 4.73445 21.9027 3.99563L20.6237 4.77938C20.9078 5.24291 21.0744 5.82434 21.1613 6.73809C21.2492 7.663 21.25 8.84876 21.25 10.5H22.75ZM19.2206 3.37628C19.7925 3.72672 20.2733 4.20752 20.6237 4.77938L21.9027 3.99563C21.4286 3.22194 20.7781 2.57144 20.0044 2.09732L19.2206 3.37628ZM10.5 1.25C8.87781 1.25 7.6085 1.24921 6.59611 1.34547C5.57256 1.44279 4.73445 1.64457 3.99563 2.09732L4.77938 3.37628C5.24291 3.09223 5.82434 2.92561 6.73809 2.83873C7.663 2.75079 8.84876 2.75 10.5 2.75V1.25ZM2.75 10.5C2.75 8.84876 2.75079 7.663 2.83873 6.73809C2.92561 5.82434 3.09223 5.24291 3.37628 4.77938L2.09732 3.99563C1.64457 4.73445 1.44279 5.57256 1.34547 6.59611C1.24921 7.6085 1.25 8.87781 1.25 10.5H2.75ZM3.99563 2.09732C3.22194 2.57144 2.57144 3.22194 2.09732 3.99563L3.37628 4.77938C3.72672 4.20752 4.20752 3.72672 4.77938 3.37628L3.99563 2.09732ZM11.0166 20.0898C10.8136 19.7468 10.6354 19.4441 10.4621 19.2063C10.2795 18.9559 10.0702 18.7304 9.77986 18.5615L9.02572 19.8582C9.07313 19.8857 9.13772 19.936 9.24985 20.0898C9.37122 20.2564 9.50835 20.4865 9.72579 20.8539L11.0166 20.0898ZM7.77666 19.7413C8.21575 19.7489 8.49387 19.7545 8.70588 19.7779C8.90399 19.7999 8.98078 19.832 9.02572 19.8582L9.77986 18.5615C9.4871 18.3912 9.18246 18.3215 8.87097 18.287C8.57339 18.2541 8.21375 18.2487 7.8025 18.2416L7.77666 19.7413ZM14.2742 20.8539C14.4916 20.4865 14.6287 20.2564 14.7501 20.0898C14.8622 19.936 14.9268 19.8857 14.9742 19.8582L14.2201 18.5615C13.9298 18.7304 13.7204 18.9559 13.5379 19.2063C13.3646 19.4441 13.1864 19.7468 12.9833 20.0898L14.2742 20.8539ZM16.1975 18.2416C15.7862 18.2487 15.4266 18.2541 15.129 18.287C14.8175 18.3215 14.5129 18.3912 14.2201 18.5615L14.9742 19.8582C15.0192 19.832 15.096 19.7999 15.2941 19.7779C15.5061 19.7545 15.7842 19.7489 16.2233 19.7413L16.1975 18.2416Z"
                  />
                  <path class="w-7 stroke-blue-600 dark:stroke-blue-300" d="M8 9H16" stroke-width="1.5" stroke-linecap="round" />
                  <path class="w-7 stroke-blue-600 dark:stroke-blue-300" d="M8 12.5H13.5" stroke-width="1.5" stroke-linecap="round" />
                </svg>
              </div>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Asisten AI</span>
            </button>

            <!-- Ikon permintaan -->
            <button id="sidebar-menu-button-permintaan-kontrakan" class="relative flex min-w-max cursor-pointer flex-col items-center gap-1 text-center text-gray-600">
              <svg class="w-5 fill-orange-600 dark:fill-orange-300" viewBox="0 0 30.586 30.586" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(-546.269 -195.397)">
                  <path d="M572.138,221.245a15.738,15.738,0,0,0-21.065-.253l-1.322-1.5a17.738,17.738,0,0,1,23.741.28Z" />

                  <path d="M561.464,204.152a4.96,4.96,0,1,1-4.96,4.96,4.966,4.966,0,0,1,4.96-4.96m0-2a6.96,6.96,0,1,0,6.96,6.96,6.96,6.96,0,0,0-6.96-6.96Z" />

                  <path d="M561.562,197.4a13.293,13.293,0,1,1-13.293,13.293A13.308,13.308,0,0,1,561.562,197.4m0-2a15.293,15.293,0,1,0,15.293,15.293A15.293,15.293,0,0,0,561.562,195.4Z" />
                </g>
              </svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Data Permintaan</span>
            </button>

            <!-- Ikon Fitur Mode Terang -->
            <button id="theme-toggle" class="flex min-w-max cursor-pointer flex-col items-center text-center text-gray-600">
              <svg id="theme-toggle-light-icon" class="h-6 w-6 text-yellow-400 dark:text-gray-200" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path>
              </svg>
              <svg id="theme-toggle-dark-icon" class="h-6 w-6 text-gray-500 dark:text-gray-200" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
              </svg>
              <span id="theme-toggle-text" class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Mode Terang</span>
            </button>

            <!-- Tombol Fullscreen -->
            <button id="fullscreen-button" class="flex min-w-max cursor-pointer flex-col items-center text-center text-gray-600">
              <svg class="w-6 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9.00002 3.99998H4.00004L4 9M20 8.99999V4L15 3.99997M15 20H20L20 15M4 15L4 20L9.00002 20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <span class="whitespace-nowrap text-xs font-medium dark:text-gray-200">Fullscreen</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Konten 1 Sidebar (mirip panel hasil Google Maps) -->
    <div id="sidebar-content-about-us" class="md:w-lg fixed bottom-0 left-0 z-[1100] flex hidden h-[80vh] w-full flex-1 flex-col overflow-hidden bg-white shadow-2xl md:h-full md:border-t-0 dark:bg-gray-900">
      <div class="flex items-center justify-between border-b border-gray-200 px-4 py-2 dark:border-gray-700">
        <div class="flex w-full flex-row items-center gap-2">
          <svg class="w-5 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.36407 12.9579C1.98463 10.3208 1.79491 9.00229 2.33537 7.87495C2.87583 6.7476 4.02619 6.06234 6.32691 4.69181L7.71175 3.86687C9.80104 2.62229 10.8457 2 12 2C13.1543 2 14.199 2.62229 16.2882 3.86687L17.6731 4.69181C19.9738 6.06234 21.1242 6.7476 21.6646 7.87495C22.2051 9.00229 22.0154 10.3208 21.6359 12.9579L21.3572 14.8952C20.8697 18.2827 20.626 19.9764 19.451 20.9882C18.2759 22 16.5526 22 13.1061 22H10.8939C7.44737 22 5.72409 22 4.54903 20.9882C3.37396 19.9764 3.13025 18.2827 2.64284 14.8952L2.36407 12.9579Z" stroke-width="1.5" />
            <path d="M9 16C9.85038 16.6303 10.8846 17 12 17C13.1154 17 14.1496 16.6303 15 16" stroke-width="1.5" stroke-linecap="round" />
          </svg>
          <div class="flex flex-col">
            <h1 class="text-xl font-bold text-gray-600 dark:text-gray-200">KontrakYuk</h1>
          </div>
        </div>
        <button id="close-button-sidebar-content-about-us" class="flex cursor-pointer items-center text-sm font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 dark:text-blue-200">Tutup</button>
      </div>

      <div class="sidebar-scroll flex-1 overflow-y-auto px-4 pb-28 pt-6">
        <section class="mb-12 text-center">
          <h2 class="mb-4 text-4xl font-extrabold text-gray-900 md:text-5xl dark:text-gray-200">Cari Kontrakan?</h2>
          <p class="mx-auto max-w-3xl text-lg text-gray-600 md:text-xl dark:text-gray-300">
            Solusi mudah cari rumah kontrakan. Daripada capek dan habis bensin di jalan, mending cari dengan bantuan
            <span class="font-semibold text-blue-500">Gemini AI</span>
            di
            <span class="font-semibold text-blue-500">KontrakYuk</span>
            aja.
          </p>
        </section>

        <section class="mb-12 rounded-2xl bg-gray-200 p-6 text-center dark:bg-gray-800">
          <h3 class="mb-2 text-3xl font-bold text-gray-900 dark:text-white">Mengapa KontrakYuk?</h3>
          <p class="text-lg text-gray-600 dark:text-gray-300">
            Kami menggunakan teknologi
            <span class="font-bold text-blue-500">Gemini AI</span>
            untuk memberikan rekomendasi kontrakan yang paling sesuai dengan kebutuhan kamu.
          </p>
          <div class="mt-4 flex flex-col items-center justify-center gap-4">
            <div class="w-full rounded-2xl border border-gray-400 bg-white p-4 shadow-lg transition-all duration-300 hover:scale-[1.02] hover:border-blue-300 hover:shadow-xl dark:bg-gray-700">
              <p class="mb-1 flex items-center text-left text-xl font-extrabold text-gray-900 dark:text-white">
                <span class="mr-2 hidden text-blue-500 md:block">üîç</span>
                Pencarian Cerdas
              </p>
              <p class="text-md text-left text-gray-800 dark:text-gray-300">Temukan kontrakan dengan kriteria spesifik dengan dukungan AI.</p>
            </div>
            <div class="w-full rounded-2xl border border-gray-400 bg-white p-4 shadow-lg transition-all duration-300 hover:scale-[1.02] hover:border-blue-300 hover:shadow-xl dark:bg-gray-700">
              <p class="mb-1 flex items-center text-left text-xl font-extrabold text-gray-900 dark:text-white">
                <span class="mr-2 hidden text-blue-500 md:block">üéØ</span>
                Rekomendasi Akurat
              </p>
              <p class="text-md text-left text-gray-800 dark:text-gray-300">AI merekomendasikan pilihan terbaik yang dijamin cocok untuk kamu.</p>
            </div>
            <div class="w-full rounded-2xl border border-gray-400 bg-white p-4 shadow-lg transition-all duration-300 hover:scale-[1.02] hover:border-blue-300 hover:shadow-xl dark:bg-gray-700">
              <p class="mb-1 flex items-center text-left text-xl font-extrabold text-gray-900 dark:text-white">
                <span class="mr-2 hidden text-blue-500 md:block">‚è±Ô∏è</span>
                Efisiensi Waktu
              </p>
              <p class="text-md text-left text-gray-800 dark:text-gray-300">Hemat waktu berharga! Tidak perlu pergi keluar untuk keliling mencari kontrakan.</p>
            </div>
          </div>
        </section>

        <section class="text-center">
          <h3 class="mb-2 text-2xl font-bold text-gray-900 dark:text-white">Hubungi Kami</h3>
          <div class="mx-auto flex max-w-sm flex-col items-center justify-center gap-2">
            <a class="w-full rounded-md bg-blue-500 p-3 text-sm font-semibold text-white transition-colors hover:bg-blue-600" href="https://wa.me/6282231320160?text=permisi,%20saya%20butuh%20bantuan%20tim%20kontrakyuk" target="_blank">Hubungi Via WhatsApp</a>
            <a class="w-full rounded-md bg-gray-200 p-3 text-sm font-semibold text-gray-800 transition-colors hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" href="https://whatsapp.com/channel/0029Vb28FW0JZg42nu3DfR23" target="_blank">Ikuti WhatsApp Channel</a>
          </div>
          <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">
            Telegram:
            <a class="text-sm font-medium text-blue-500 hover:underline" href="https://t.me/kontrakyuk?text=permisi,%20saya%20butuh%20bantuan%20tim%20kontrakyuk" target="_blank">@kontrakyuk</a>
          </p>
        </section>
      </div>
    </div>

    <!-- Konten 2 Sidebar (mirip panel hasil Google Maps) -->
    <div id="sidebar-content-permintaan-kontrakan" class="md:w-lg border-e-1 border-t-1 fixed bottom-0 left-0 z-[1100] flex hidden h-[80vh] w-full flex-1 flex-col overflow-hidden border-gray-200 bg-white md:h-full md:border-t-0 dark:border-gray-700 dark:bg-gray-900">
      <div class="flex items-center justify-between border-b border-gray-200 px-4 py-2 dark:border-gray-700">
        <div class="flex w-full flex-row justify-between">
          <div class="flex flex-row gap-2">
            <svg class="w-5 fill-gray-600 dark:fill-gray-200" viewBox="0 0 30.586 30.586" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g transform="translate(-546.269 -195.397)">
                <path d="M572.138,221.245a15.738,15.738,0,0,0-21.065-.253l-1.322-1.5a17.738,17.738,0,0,1,23.741.28Z" />
                <path d="M561.464,204.152a4.96,4.96,0,1,1-4.96,4.96,4.966,4.966,0,0,1,4.96-4.96m0-2a6.96,6.96,0,1,0,6.96,6.96,6.96,6.96,0,0,0-6.96-6.96Z" />
                <path d="M561.562,197.4a13.293,13.293,0,1,1-13.293,13.293A13.308,13.308,0,0,1,561.562,197.4m0-2a15.293,15.293,0,1,0,15.293,15.293A15.293,15.293,0,0,0,561.562,195.4Z" />
              </g>
            </svg>
            <h2 class="mr-2 text-xl font-bold text-gray-600 dark:text-gray-200">Permintaan Kontrakan</h2>
          </div>
          <div class="flex flex-row gap-2">
            <button id="close-button-sidebar-content-permintaan-kontrakan" class="flex cursor-pointer items-center text-sm font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">Tutup</button>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto px-4 pb-28 pt-6">
        <div class="mb-4 flex items-center justify-between pb-1">
          <h2 class="text-2xl font-bold text-gray-500 dark:text-gray-200" id="list-title">
            <span id="total-data-count"></span>
            Permintaan
          </h2>
          <button id="refresh-data-permintaan-button" title="Muat Ulang Data" class="cursor-pointer rounded-full p-2 text-sm text-blue-500 transition hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-gray-700">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>

        <div class="mb-5 space-y-3">
          <div>
            <div class="relative">
              <input type="text" id="search-input" placeholder="Cari Kebutuhan / Dicari Cepat" class="Input w-full rounded-lg border border-gray-300 p-2 pl-10 text-sm focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 dark:placeholder-gray-400" />
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 transform text-sm text-gray-400 dark:text-gray-400"></i>
            </div>
          </div>

          <div>
            <select id="city-select" class="w-full rounded-lg border border-gray-300 bg-white p-2 text-sm text-gray-700 focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200">
              <option value="">Filter Kota: Semua Kota</option>
            </select>
          </div>

          <div>
            <select id="sort-select" class="w-full rounded-lg border border-gray-300 bg-white p-2 text-sm text-gray-700 focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200">
              <option value="tanggal-desc">Urutkan: Tanggal Terbaru</option>
              <option value="tanggal-asc">Urutkan: Tanggal Terlama</option>
              <option value="prioritas-desc">Urutkan: Prioritas Tinggi</option>
              <option value="prioritas-asc">Urutkan: Prioritas Rendah</option>
            </select>
          </div>
        </div>

        <div id="permintaan-list" class="space-y-4"></div>

        <div id="pagination-controls" class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4 dark:border-gray-700">
          <div class="flex items-center space-x-2">
            <span class="hidden text-sm text-gray-600 sm:inline dark:text-gray-400">Halaman:</span>
            <input type="number" id="page-input" min="1" class="w-12 rounded-lg border border-gray-300 p-1 text-center text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200" />
            <span class="whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
              dari
              <strong id="total-pages">1</strong>
            </span>
          </div>

          <div class="flex space-x-2">
            <button id="prev-page" class="rounded-full p-2 text-sm text-blue-500 transition hover:bg-blue-50 disabled:text-gray-400 disabled:hover:bg-white dark:text-blue-400 dark:hover:bg-gray-700 dark:disabled:text-gray-600 dark:disabled:hover:bg-gray-900">
              <i class="fas fa-arrow-left"></i>
            </button>
            <button id="next-page" class="rounded-full p-2 text-sm text-blue-500 transition hover:bg-blue-50 disabled:text-gray-400 disabled:hover:bg-white dark:text-blue-400 dark:hover:bg-gray-700 dark:disabled:text-gray-600 dark:disabled:hover:bg-gray-900">
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Konten 3 Sidebar (mirip panel hasil Google Maps) -->
    <div id="sidebar-content-filter-data" class="md:w-lg border-e-1 border-t-1 fixed bottom-0 left-0 z-[1100] flex hidden h-[80vh] w-full flex-1 flex-col overflow-hidden border-gray-200 bg-white md:h-full md:border-t-0 dark:border-gray-700 dark:bg-gray-900">
      <!-- Header Hasil -->
      <div class="flex items-center justify-between border-b border-gray-200 px-4 py-2 dark:border-gray-700">
        <div class="flex flex-row gap-2">
          <svg class="w-5 stroke-gray-600 dark:stroke-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 3H5C3.58579 3 2.87868 3 2.43934 3.4122C2 3.8244 2 4.48782 2 5.81466V6.50448C2 7.54232 2 8.06124 2.2596 8.49142C2.5192 8.9216 2.99347 9.18858 3.94202 9.72255L6.85504 11.3624C7.49146 11.7206 7.80967 11.8998 8.03751 12.0976C8.51199 12.5095 8.80408 12.9935 8.93644 13.5872C9 13.8722 9 14.2058 9 14.8729L9 17.5424C9 18.452 9 18.9067 9.25192 19.2613C9.50385 19.6158 9.95128 19.7907 10.8462 20.1406C12.7248 20.875 13.6641 21.2422 14.3321 20.8244C15 20.4066 15 19.4519 15 17.5424V14.8729C15 14.2058 15 13.8722 15.0636 13.5872C15.1959 12.9935 15.488 12.5095 15.9625 12.0976C16.1903 11.8998 16.5085 11.7206 17.145 11.3624L20.058 9.72255C21.0065 9.18858 21.4808 8.9216 21.7404 8.49142C22 8.06124 22 7.54232 22 6.50448V5.81466C22 4.48782 22 3.8244 21.5607 3.4122C21.1213 3 20.4142 3 19 3Z" stroke-width="1.5" />
          </svg>
          <h2 class="mr-2 text-xl font-bold text-gray-600 dark:text-gray-200">Filter Data</h2>
        </div>
        <button id="close-button-sidebar-content-filter-data" class="flex cursor-pointer items-center text-sm font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 dark:text-blue-200">Tutup</button>
      </div>

      <div class="mb-4 flex flex-col gap-6 overflow-y-scroll p-4 pb-20 text-left dark:bg-gray-900">
        <div class="flex w-full flex-col gap-3">
          <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Kota</label>
          <select id="filter-kota" name="filter-kota" class="w-full cursor-pointer rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 transition-colors focus:border-blue-500 focus:ring-1 focus:ring-blue-500 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200">
            <option value="">Semua</option>
          </select>
        </div>

        <div class="flex w-full flex-col gap-3">
          <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Jenis Kontrakan</label>
          <select id="jenis-properti" name="jenis-properti" class="w-full cursor-pointer rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 transition-colors focus:border-blue-500 focus:ring-1 focus:ring-blue-500 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200">
            <option value="">Semua</option>
          </select>
        </div>

        <div class="flex w-full flex-col gap-3">
          <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Permintaan Kontrakan</label>
          <textarea id="filter_permintaan_user" name="filter_permintaan_user" rows="3" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 transition-colors focus:border-blue-500 focus:ring-1 focus:ring-blue-500 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200" placeholder="contoh: 4 kamar tidur akses mobil ada perabot..."></textarea>
          <button data-target="reset-permintaan-user" class="reset-data-filter-button w-full rounded-lg bg-red-100 py-2 text-sm font-semibold text-red-600 dark:bg-red-800 dark:text-red-100">Reset Permintaan</button>
        </div>

        <hr class="border-gray-200 dark:border-gray-700" />

        <details class="group w-full">
          <summary class="flex cursor-pointer items-center justify-between rounded-lg bg-blue-50 p-3 font-bold text-blue-600 transition-colors dark:bg-gray-800 dark:text-blue-400">
            <span>Filter Detail Kontrakan</span>
            <span class="transition-transform group-open:rotate-180">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </span>
          </summary>

          <div class="mt-4 flex flex-col gap-6 pl-1">
            <div class="flex w-full flex-col gap-3">
              <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Kamar Tidur</label>
              <div class="rounded-lg bg-gray-100 p-4 dark:bg-gray-700">
                <div class="grid grid-cols-1 gap-4">
                  <div class="space-y-1">
                    <label class="text-sm text-gray-500 dark:text-gray-200">Min.</label>
                    <input type="number" id="filter_jumlah_kamar_tidur_minimal" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200" placeholder="1" />
                  </div>
                  <div class="space-y-1">
                    <label class="text-sm text-gray-500 dark:text-gray-200">Max.</label>
                    <input type="number" id="filter_jumlah_kamar_tidur_maksimal" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200" placeholder="10" />
                  </div>
                </div>
              </div>
              <button data-target="reset-kamar-tidur" class="reset-data-filter-button w-full rounded-lg bg-red-100 py-2 text-sm font-semibold text-red-600 dark:bg-red-800 dark:text-red-100">Reset Kamar Tidur</button>
            </div>

            <div class="flex w-full flex-col gap-3">
              <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Kamar Mandi</label>
              <div class="rounded-lg bg-gray-100 p-4 dark:bg-gray-700">
                <div class="grid grid-cols-1 gap-4">
                  <div class="space-y-1">
                    <label class="text-sm text-gray-500 dark:text-gray-200">Min.</label>
                    <input type="number" id="filter_jumlah_kamar_mandi_minimal" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200" placeholder="1" />
                  </div>
                  <div class="space-y-1">
                    <label class="text-sm text-gray-500 dark:text-gray-200">Max.</label>
                    <input type="number" id="filter_jumlah_kamar_mandi_maksimal" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200" placeholder="2" />
                  </div>
                </div>
              </div>
              <button data-target="reset-kamar-mandi" class="reset-data-filter-button w-full rounded-lg bg-red-100 py-2 text-sm font-semibold text-red-600 dark:bg-red-800 dark:text-red-100">Reset Kamar Mandi</button>
            </div>

            <div class="flex w-full flex-col gap-3">
              <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Harga</label>
              <div class="rounded-lg bg-gray-100 p-4 dark:bg-gray-700">
                <div class="grid grid-cols-1 gap-4">
                  <div class="space-y-1">
                    <label class="text-sm text-gray-500 dark:text-gray-200">Min.</label>
                    <input type="text" id="filter_harga_min_properti" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200" placeholder="Rp 0" />
                  </div>
                  <div class="space-y-1">
                    <label class="text-sm text-gray-500 dark:text-gray-200">Max.</label>
                    <input type="text" id="filter_harga_max_properti" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:border-gray-200 dark:bg-gray-700 dark:text-gray-200" placeholder="Rp Tanpa Batas" />
                  </div>
                </div>
              </div>
              <button data-target="reset-input-harga" class="reset-data-filter-button w-full rounded-lg bg-red-100 py-2 text-sm font-semibold text-red-600 dark:bg-red-800 dark:text-red-100">Reset Harga</button>
            </div>

            <div class="flex w-full flex-col gap-3">
              <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Ketersediaan</label>
              <select id="status-ketersediaan" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                <option value="all">Semua</option>
                <option value="available">Tersedia</option>
                <option value="unavailable">Tidak Tersedia</option>
              </select>
            </div>

            <div class="mb-4 flex w-full flex-col gap-3">
              <label class="block border-l-4 border-blue-500 pl-1 font-bold text-blue-500">Jumlah Peminat Minimal</label>
              <input type="number" id="cari_jumlah_peminat" class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-gray-700 dark:bg-gray-800 dark:text-gray-200" placeholder="1" min="0" />
            </div>
          </div>
        </details>

        <div class="sticky bottom-0 mt-4 flex gap-3 bg-white py-4 dark:bg-gray-900">
          <button id="resetFilterData" class="flex-1 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-600 transition-colors hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300">Reset Semua</button>
          <button id="applyFilterData" class="flex-[2] rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-bold text-white shadow-md transition-colors hover:bg-blue-700">Tampilkan Hasil</button>
        </div>
      </div>
    </div>

    <!-- Konten 4 Sidebar (mirip panel hasil Google Maps) -->
    <div id="sidebar-content-asisten-AI" class="md:w-lg border-e-1 border-t-1 fixed bottom-0 left-0 z-[1100] flex hidden h-[80vh] w-full flex-1 flex-col overflow-hidden border-gray-200 bg-white md:h-full md:border-t-0 dark:border-gray-700 dark:bg-gray-900">
      <!-- Header Hasil -->
      <div class="flex items-center justify-between border-b border-gray-200 px-4 py-2 dark:border-gray-700">
        <div class="flex w-full flex-row justify-between">
          <div class="flex flex-row gap-2">
            <svg class="w-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                class="w-7 fill-gray-600 dark:fill-gray-200"
                d="M13.0867 21.3877L13.7321 21.7697L13.0867 21.3877ZM13.6288 20.4718L12.9833 20.0898L13.6288 20.4718ZM10.3712 20.4718L9.72579 20.8539H9.72579L10.3712 20.4718ZM10.9133 21.3877L11.5587 21.0057L10.9133 21.3877ZM2.3806 15.9134L3.07351 15.6264V15.6264L2.3806 15.9134ZM7.78958 18.9915L7.77666 19.7413L7.78958 18.9915ZM5.08658 18.6194L4.79957 19.3123H4.79957L5.08658 18.6194ZM21.6194 15.9134L22.3123 16.2004V16.2004L21.6194 15.9134ZM16.2104 18.9915L16.1975 18.2416L16.2104 18.9915ZM18.9134 18.6194L19.2004 19.3123H19.2004L18.9134 18.6194ZM19.6125 2.7368L19.2206 3.37628L19.6125 2.7368ZM21.2632 4.38751L21.9027 3.99563V3.99563L21.2632 4.38751ZM4.38751 2.7368L3.99563 2.09732V2.09732L4.38751 2.7368ZM2.7368 4.38751L2.09732 3.99563H2.09732L2.7368 4.38751ZM9.40279 19.2098L9.77986 18.5615L9.77986 18.5615L9.40279 19.2098ZM13.7321 21.7697L14.2742 20.8539L12.9833 20.0898L12.4412 21.0057L13.7321 21.7697ZM9.72579 20.8539L10.2679 21.7697L11.5587 21.0057L11.0166 20.0898L9.72579 20.8539ZM12.4412 21.0057C12.2485 21.3313 11.7515 21.3313 11.5587 21.0057L10.2679 21.7697C11.0415 23.0767 12.9585 23.0767 13.7321 21.7697L12.4412 21.0057ZM10.5 2.75H13.5V1.25H10.5V2.75ZM21.25 10.5V11.5H22.75V10.5H21.25ZM2.75 11.5V10.5H1.25V11.5H2.75ZM1.25 11.5C1.25 12.6546 1.24959 13.5581 1.29931 14.2868C1.3495 15.0223 1.45323 15.6344 1.68769 16.2004L3.07351 15.6264C2.92737 15.2736 2.84081 14.8438 2.79584 14.1847C2.75041 13.5189 2.75 12.6751 2.75 11.5H1.25ZM7.8025 18.2416C6.54706 18.2199 5.88923 18.1401 5.37359 17.9265L4.79957 19.3123C5.60454 19.6457 6.52138 19.7197 7.77666 19.7413L7.8025 18.2416ZM1.68769 16.2004C2.27128 17.6093 3.39066 18.7287 4.79957 19.3123L5.3736 17.9265C4.33223 17.4951 3.50486 16.6678 3.07351 15.6264L1.68769 16.2004ZM21.25 11.5C21.25 12.6751 21.2496 13.5189 21.2042 14.1847C21.1592 14.8438 21.0726 15.2736 20.9265 15.6264L22.3123 16.2004C22.5468 15.6344 22.6505 15.0223 22.7007 14.2868C22.7504 13.5581 22.75 12.6546 22.75 11.5H21.25ZM16.2233 19.7413C17.4786 19.7197 18.3955 19.6457 19.2004 19.3123L18.6264 17.9265C18.1108 18.1401 17.4529 18.2199 16.1975 18.2416L16.2233 19.7413ZM20.9265 15.6264C20.4951 16.6678 19.6678 17.4951 18.6264 17.9265L19.2004 19.3123C20.6093 18.7287 21.7287 17.6093 22.3123 16.2004L20.9265 15.6264ZM13.5 2.75C15.1512 2.75 16.337 2.75079 17.2619 2.83873C18.1757 2.92561 18.7571 3.09223 19.2206 3.37628L20.0044 2.09732C19.2655 1.64457 18.4274 1.44279 17.4039 1.34547C16.3915 1.24921 15.1222 1.25 13.5 1.25V2.75ZM22.75 10.5C22.75 8.87781 22.7508 7.6085 22.6545 6.59611C22.5572 5.57256 22.3554 4.73445 21.9027 3.99563L20.6237 4.77938C20.9078 5.24291 21.0744 5.82434 21.1613 6.73809C21.2492 7.663 21.25 8.84876 21.25 10.5H22.75ZM19.2206 3.37628C19.7925 3.72672 20.2733 4.20752 20.6237 4.77938L21.9027 3.99563C21.4286 3.22194 20.7781 2.57144 20.0044 2.09732L19.2206 3.37628ZM10.5 1.25C8.87781 1.25 7.6085 1.24921 6.59611 1.34547C5.57256 1.44279 4.73445 1.64457 3.99563 2.09732L4.77938 3.37628C5.24291 3.09223 5.82434 2.92561 6.73809 2.83873C7.663 2.75079 8.84876 2.75 10.5 2.75V1.25ZM2.75 10.5C2.75 8.84876 2.75079 7.663 2.83873 6.73809C2.92561 5.82434 3.09223 5.24291 3.37628 4.77938L2.09732 3.99563C1.64457 4.73445 1.44279 5.57256 1.34547 6.59611C1.24921 7.6085 1.25 8.87781 1.25 10.5H2.75ZM3.99563 2.09732C3.22194 2.57144 2.57144 3.22194 2.09732 3.99563L3.37628 4.77938C3.72672 4.20752 4.20752 3.72672 4.77938 3.37628L3.99563 2.09732ZM11.0166 20.0898C10.8136 19.7468 10.6354 19.4441 10.4621 19.2063C10.2795 18.9559 10.0702 18.7304 9.77986 18.5615L9.02572 19.8582C9.07313 19.8857 9.13772 19.936 9.24985 20.0898C9.37122 20.2564 9.50835 20.4865 9.72579 20.8539L11.0166 20.0898ZM7.77666 19.7413C8.21575 19.7489 8.49387 19.7545 8.70588 19.7779C8.90399 19.7999 8.98078 19.832 9.02572 19.8582L9.77986 18.5615C9.4871 18.3912 9.18246 18.3215 8.87097 18.287C8.57339 18.2541 8.21375 18.2487 7.8025 18.2416L7.77666 19.7413ZM14.2742 20.8539C14.4916 20.4865 14.6287 20.2564 14.7501 20.0898C14.8622 19.936 14.9268 19.8857 14.9742 19.8582L14.2201 18.5615C13.9298 18.7304 13.7204 18.9559 13.5379 19.2063C13.3646 19.4441 13.1864 19.7468 12.9833 20.0898L14.2742 20.8539ZM16.1975 18.2416C15.7862 18.2487 15.4266 18.2541 15.129 18.287C14.8175 18.3215 14.5129 18.3912 14.2201 18.5615L14.9742 19.8582C15.0192 19.832 15.096 19.7999 15.2941 19.7779C15.5061 19.7545 15.7842 19.7489 16.2233 19.7413L16.1975 18.2416Z"
              />
              <path class="w-7 stroke-gray-600 dark:stroke-gray-200" d="M8 9H16" stroke-width="1.5" stroke-linecap="round" />
              <path class="w-7 stroke-gray-600 dark:stroke-gray-200" d="M8 12.5H13.5" stroke-width="1.5" stroke-linecap="round" />
            </svg>
            <h2 class="mr-2 text-xl font-bold text-gray-600 dark:text-gray-200">Asisten AI</h2>
          </div>
          <div class="flex flex-row gap-2">
            <button id="clear-Chat-Button" class="flex items-center space-x-1 rounded-lg bg-red-100 px-3 py-1 text-sm font-medium text-red-600 transition duration-150 ease-in-out hover:bg-red-200 dark:bg-red-800 dark:text-red-100 dark:hover:bg-red-700" title="Hapus Riwayat Obrolan">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
              <span>Hapus</span>
            </button>
            <button id="close-button-sidebar-content-asisten-AI" class="flex cursor-pointer items-center text-sm font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 dark:text-blue-200">Tutup</button>
          </div>
        </div>
      </div>

      <!-- Content Chat -->
      <div id="chat-messages" class="sidebar-scroll flex flex-1 flex-grow flex-col space-y-3 overflow-y-auto bg-gray-50 p-4 dark:bg-gray-900">
        <!-- Contoh pesan dari AI -->
        <div class="flex items-start">
          <div class="ai-icon">
            <svg class="w-5 fill-blue-500 pt-[2px] dark:fill-blue-300" fill-rule="evenodd" style="flex: none; line-height: 1" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
              <title>Gemini</title>
              <path d="M20.616 10.835a14.147 14.147 0 01-4.45-3.001 14.111 14.111 0 01-3.678-6.452.503.503 0 00-.975 0 14.134 14.134 0 01-3.679 6.452 14.155 14.155 0 01-4.45 3.001c-.65.28-1.318.505-2.002.678a.502.502 0 000 .975c.684.172 1.35.397 2.002.677a14.147 14.147 0 014.45 3.001 14.112 14.112 0 013.679 6.453.502.502 0 00.975 0c.172-.685.397-1.351.677-2.003a14.145 14.145 0 013.001-4.45 14.113 14.113 0 016.453-3.678.503.503 0 000-.975 13.245 13.245 0 01-2.003-.678z"></path>
            </svg>
          </div>

          <div class="ml-3">
            <div class="rounded-xl bg-white p-3 text-gray-800 shadow-sm dark:bg-gray-700 dark:text-gray-100">
              <div class="text-lg font-semibold">Halo! üëã</div>
              <div class="mt-1">Saya Maya siap membantu. Bisa ceritakan kontrakan seperti apa yang Anda butuhkan?</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Chat -->
      <div class="flex space-x-2 px-4 pb-24 pt-2">
        <textarea id="user-chat-textarea" rows="1" placeholder="Type your message..." class="h-12 w-full resize-none overflow-hidden rounded-lg border border-gray-300 px-4 py-3 pr-12 transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:bg-gray-800 dark:text-gray-200" style="max-height: 150px"></textarea>
        <button id="send-button" class="rounded-lg bg-blue-500 p-3 text-white shadow-md transition duration-200 ease-in-out hover:bg-blue-600">
          <!-- Icon kirim -->
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
        </button>
      </div>
    </div>

    <div class="relative overflow-hidden">
      <div id="map" class="min-w-screen hidden min-h-screen"></div>
    </div>

    <div id="list-data-container" class="h-screen w-screen overflow-y-scroll bg-gray-200 px-4 pb-24 pt-4 dark:bg-gray-800">
      <div id="info-ringkasan-ketersediaan" class="mb-6 hidden rounded-lg bg-white p-4 shadow-md dark:bg-gray-700">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">Ringkasan Ketersediaan</h3>
          <button id="refresh-data-kontrakan-button" title="Muat Ulang Data" class="cursor-pointer rounded-full p-2 text-sm text-blue-500 transition hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-gray-700">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>

        <div class="flex space-x-6 overflow-x-scroll">
          <div class="flex items-center space-x-3">
            <span id="list-data-jumlah-data" class="text-4xl font-extrabold text-gray-600 dark:text-gray-200">0</span>
            <div class="text-sm">
              <p class="font-semibold text-gray-700 dark:text-gray-200">Kontrakan</p>
              <p class="text-gray-600 dark:text-gray-200">Ditampilkan</p>
            </div>
          </div>
          <div class="border-l border-gray-300"></div>
          <div class="flex items-center space-x-3">
            <span id="text-jumlah-kontrakan-tersedia" class="text-4xl font-extrabold text-green-600 dark:text-green-400">0</span>
            <div class="text-sm">
              <p class="font-semibold text-gray-700 dark:text-gray-200">Kontrakan</p>
              <p class="text-green-600 dark:text-green-400">Tersedia</p>
            </div>
          </div>
          <div class="border-l border-gray-300"></div>
          <div class="flex items-center space-x-3">
            <span id="text-jumlah-kontrakan-tidak-tersedia" class="text-4xl font-extrabold text-red-600 dark:text-red-400">0</span>
            <div class="text-sm">
              <p class="font-semibold text-gray-700 dark:text-gray-200">Kontrakan</p>
              <p class="text-red-600 dark:text-red-400">Tidak Tersedia</p>
            </div>
          </div>
        </div>
      </div>

      <div id="select-urutan-data-ditampilkan" class="mb-8 flex hidden items-center justify-end">
        <div class="flex flex-col items-end justify-end gap-2 md:flex-row md:gap-4">
          <div class="flex w-fit flex-row items-center justify-center gap-2">
            <div class="font-semibold text-gray-500 dark:text-gray-200">Urutan</div>
            <select id="sort-data-by" class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-blue-500">
              <option value="" disabled>Urutkan Berdasarkan...</option>
              <option value="terbaru" selected>Terbaru</option>
              <option value="terlama">Terlama</option>
              <option value="harga_termurah">Harga Termurah</option>
              <option value="harga_termahal">Harga Termahal</option>
              <option value="banyak_dilihat">Banyak Dilihat</option>
            </select>
          </div>
        </div>
      </div>

      <div id="list-data-content-section" class="container-list-data grid grid-cols-1 gap-4 md:grid-cols-2"></div>

      <div id="data-loading-spinner" class="flex h-[50%] items-center justify-center bg-gray-200 dark:bg-gray-800">
        <div class="flex flex-col items-center space-y-4">
          <p id="loading-text" class="text-xl font-semibold text-gray-700 dark:text-gray-300">Data sedang dimuat...</p>
          <div class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="stopwatch" class="text-lg">00:00:00</span>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script src="asset/sweetalert.js"></script>

  <script src="asset/leaflet.js"></script>

  <script src="asset/leaflet.markercluster.js"></script>

  <script src="asset/jquery-3.7.1.min.js"></script>

  <script src="asset/marked.min.js"></script>

  <script src="asset/Control.Geocoder.js"></script>

  <script>
    // $(document).ready(function () {
    //   const allowedDomain = "kontrakyuk.github.io";
    //   const currentDomain = window.location.hostname;

    //   if (currentDomain != allowedDomain) {
    //     window.location.href = "about:blank";
    //   }
    // });

    // Variabel Status dan Data
    let isDrawing = false;
    let isDrawingModeToggle = false;
    let drawnLatLngs = [];
    let allDrawnPolygons = [];
    let currentDrawnLayer = null;

    let seconds = 0;
    let minutes = 0;
    let hours = 0;
    let t;

    // ----------------------------------------------------
    // 1. DATA DAN STATE MANAGEMENT
    // ----------------------------------------------------
    // Data Permintaan kini akan dimuat dari Apps Script, bukan dari dummy
    let dataPermintaan = [];

    const ITEMS_PER_PAGE = 3;
    let filteredAndSortedData = [];
    let currentPage = 1;
    let totalPages = 1;

    // ----------------------------------------------------
    // 2. LOGIKA PETA & UTILITAS
    // ----------------------------------------------------

    /**
     * FUNGSI REVISI: Menghasilkan HTML Badge berdasarkan prioritas.
     * Jika "SUDAH DAPAT", badge akan menjadi abu-abu.
     */
    function getPriorityBadgeHtml(prioritas) {
      let className = "";
      let text = "";
      let icon = "";

      const status = (prioritas || "").toUpperCase();

      switch (status) {
        case "DIBUTUHKAN CEPAT":
          // Badge Merah/Oranye untuk prioritas tinggi
          className = "bg-yellow-100 text-yellow-800 border-yellow-300";
          text = "DIBUTUHKAN CEPAT!";
          icon = "fas fa-exclamation-triangle";
          break;
        case "DICARI":
          // Badge Biru untuk prioritas normal/aktif
          className = "bg-blue-100 text-blue-800 border-blue-300";
          text = "DICARI";
          icon = "fas fa-search";
          break;
        case "SUDAH DAPAT":
          // PERUBAHAN: Badge Abu-abu untuk status selesai
          className = "bg-gray-100 text-gray-500 border-gray-300";
          text = "SUDAH DAPAT";
          icon = "fas fa-check-circle";
          break;
        default:
          className = "bg-gray-100 text-gray-800 border-gray-300";
          text = "TIDAK DIKETAHUI";
          icon = "fas fa-info-circle";
      }

      // Menggunakan styling badge yang lebih detail (rounded-full, border, tracking-wider)
      return `<span class="inline-flex items-center px-3 py-1 text-xs font-semibold uppercase tracking-wider rounded-full border ${className}">
                      <i class="${icon} mr-2"></i> ${text}
                  </span>`;
    }

    /**
     * BARU: Fungsi untuk memformat tanggal dari YYYY-MM-DD menjadi Hari, DD Bulan YYYY
     * Contoh: 2025-10-11 menjadi Sabtu, 11 Oktober 2025
     */
    function formatDateIndonesia(dateString) {
      const [year, month, day] = dateString.split("-").map(Number);
      // Menggunakan month - 1 karena bulan di Date object dimulai dari 0 (Januari)
      const date = new Date(year, month - 1, day);

      // Pilihan format lokal Indonesia
      const options = { weekday: "long", year: "numeric", month: "long", day: "numeric" };

      // Menggunakan 'id-ID' untuk format Indonesia
      return date.toLocaleDateString("id-ID", options);
    }

    /**
     * BARU: Mengisi elemen select filter kota dengan daftar kota unik dari data.
     */
    function populateCityFilter() {
      const citySelect = document.getElementById("city-select");
      // Hapus opsi lama
      citySelect.innerHTML = '<option value="">Filter Kota: Semua Kota</option>';

      if (dataPermintaan.length === 0) return;

      // Dapatkan daftar kota unik
      const uniqueCities = [...new Set(dataPermintaan.map((req) => req.kota).filter(Boolean))].sort();

      uniqueCities.forEach((city) => {
        const option = document.createElement("option");
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
    }

    // ----------------------------------------------------
    // 3. LOGIKA FILTER, SORTING & PAGINASI (DIMODIFIKASI)
    // ----------------------------------------------------

    function filterAndSort() {
      // Memecah input pencarian menjadi kata kunci dan mengubahnya menjadi huruf kecil
      // Menggunakan regex untuk memisahkan kata berdasarkan spasi, koma, dsb., lalu memfilter string kosong
      const query = document.getElementById("search-input").value.toLowerCase();
      const keywords = query.split(/[\s,;&|()]+/).filter((k) => k.length > 0);

      const sortKey = document.getElementById("sort-select").value;
      const cityFilter = document.getElementById("city-select").value;

      // 1. FILTERING
      let data = dataPermintaan.filter((req) => {
        // Data yang akan dicari: kebutuhan, prioritas, kota, no_data, dan tanggal
        const kebutuhanText = req.kebutuhan ? req.kebutuhan.toLowerCase() : "";
        const prioritasText = req.prioritas ? req.prioritas.toLowerCase() : "";
        const kotaText = req.kota ? req.kota.toLowerCase() : "";
        // **PERUBAHAN BARU**: Ambil dan ubah req.no_data dan req.tanggal ke huruf kecil
        const noDataText = req.no_data ? String(req.no_data).toLowerCase() : ""; // Gunakan String() untuk memastikan bisa di .toLowerCase()
        const tanggalText = req.tanggal ? req.tanggal.toLowerCase() : "";

        // Logika BARU untuk pencarian kata kunci yang fleksibel di SEMUA bidang
        // Ini memeriksa apakah *SEMUA* kata kunci (keywords) ada di dalam gabungan
        // teks dari kelima kolom (`kebutuhan`, `prioritas`, `kota`, `no_data`, `tanggal`).

        // Gabungkan semua teks pencarian menjadi satu string besar
        const allSearchableText = `${kebutuhanText} ${prioritasText} ${kotaText} ${noDataText} ${tanggalText}`;

        const matchesSearchQuery = keywords.every((keyword) => {
          // Cek apakah *SETIAP* kata kunci ada di dalam string gabungan
          return allSearchableText.includes(keyword);
        });

        // Filter berdasarkan kota yang dipilih (Logika ini tetap dipertahankan)
        const matchesCityFilter = !cityFilter || (req.kota && req.kota === cityFilter);

        // Kembalikan kecocokan dari pencarian DAN kecocokan dari filter kota
        return matchesSearchQuery && matchesCityFilter;
      });

      // 2. SORTING (Tidak berubah)
      data.sort((a, b) => {
        const [key, order] = sortKey.split("-");

        if (key === "tanggal") {
          const dateA = a.tanggal;
          const dateB = b.tanggal;
          if (order === "asc") {
            const dateComparison = dateA.localeCompare(dateB);
            // Jika tanggal sama (dateComparison === 0), lakukan sorting sekunder berdasarkan no_data
            if (dateComparison === 0) {
              return a.no_data.localeCompare(b.no_data);
            }
            return dateComparison;
          } else {
            const dateComparison = dateB.localeCompare(dateA);
            // Jika tanggal sama (dateComparison === 0), lakukan sorting sekunder berdasarkan no_data
            if (dateComparison === 0) {
              return b.no_data.localeCompare(a.no_data);
            }
            return dateComparison;
          }
        } else if (key === "prioritas") {
          const priorityMap = {
            "DIBUTUHKAN CEPAT": 1,
            DICARI: 0,
          };

          // 1. Primary Sorting: Berdasarkan Prioritas
          let priorityComparison;
          if (order === "asc") {
            // Gunakan nilai default 2 jika prioritas tidak ditemukan
            let valA = priorityMap[a.prioritas] ?? 2;
            let valB = priorityMap[b.prioritas] ?? 2;
            priorityComparison = valA - valB;
          }
          if (order !== "asc") {
            // Gunakan nilai default -1 jika prioritas tidak ditemukan
            let valA = priorityMap[a.prioritas] ?? -1;
            let valB = priorityMap[b.prioritas] ?? -1;

            priorityComparison = valB - valA;
          }

          // Jika prioritasnya berbeda, kembalikan hasil perbandingan prioritas
          if (priorityComparison !== 0) {
            return priorityComparison;
          }

          // 2. Secondary Sorting: Jika Prioritas Sama (priorityComparison === 0)
          // Lakukan sorting berdasarkan tanggal terbaru (descending)
          // Gunakan dateB.localeCompare(dateA) untuk descending (terbaru ke terlama)
          const dateA = a.tanggal;
          const dateB = b.tanggal;

          const dateComparison = dateB.localeCompare(dateA);

          // Jika tanggal juga sama, gunakan no_data sebagai tertiary sorting
          if (dateComparison === 0) {
            // Urutkan berdasarkan no_data secara ascending jika tanggal sama
            return a.no_data.localeCompare(b.no_data);
          }

          // Kembalikan hasil perbandingan tanggal (descending)
          return dateComparison;
        }
        return 0;
      });

      filteredAndSortedData = data;
      currentPage = 1;
      updateDashboard();
    }

    function paginateData(data) {
      const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
      return data.slice(startIndex, startIndex + ITEMS_PER_PAGE);
    }

    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      updateDashboard();
    }

    function jumpToPage(pageInput) {
      const page = parseInt(pageInput);
      if (isNaN(page) || page < 1) {
        goToPage(1);
      } else if (page > totalPages) {
        goToPage(totalPages);
      } else {
        goToPage(page);
      }
    }

    document.getElementById("page-input").addEventListener("change", function (e) {
      jumpToPage(e.target.value);
    });

    document.getElementById("prev-page").addEventListener("click", function () {
      goToPage(currentPage - 1);
    });

    document.getElementById("next-page").addEventListener("click", function () {
      goToPage(currentPage + 1);
    });

    // ----------------------------------------------------
    // 4. FUNGSI FETCH DATA DARI APPS SCRIPT
    // ----------------------------------------------------

    /**
     * Mengambil data Base64 dari URL Google Apps Script,
     * mendekode Base64 menjadi JSON string, dan menguraikannya menjadi objek JavaScript.
     */
    async function fetchAndProcessDataPermintaan() {
      const loadingMessage = document.createElement("p");
      loadingMessage.id = "loading-message";
      loadingMessage.className = "p-4 text-center text-blue-500 bg-blue-50 dark:bg-gray-700 dark:text-gray-300 rounded-lg text-sm font-semibold";
      loadingMessage.textContent = "Memuat data dari server... Mohon tunggu.";

      const listContainer = document.getElementById("permintaan-list");
      listContainer.innerHTML = ""; // Hapus konten lama (dummy)
      listContainer.appendChild(loadingMessage); // Tampilkan pesan loading

      try {
        // Ambil URL Web App saat ini (tanpa parameter query seperti ?mode=edit)
        const webAppUrl = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjJZYAwFRxRnn2WMKqJiMeGKrAcPabXaoVF507QLTEphE8SFoXW4HF0YbFNDoavFj3hbHL27CKGcgcA11HeOHwvAoEZI4kZQzMjErAeC2FKl477HIGcB7kuA5OgV10n11qVwOcwaEJoH3EvqzDZOGRLdgAwYzfXEx4U9IeMyzzA3brWg0XG-MYAZJQ1xtr-ohvAfbYc2fJh52US276Xo323RR-duc0--QofbpC_nRhWd8g4tAGbl31K8Aqk-cT-j2PzNbhklmdxJ1rJzYPacXTIL57ZRw&lib=MYFrCDbrnat-CbxJB8NREqjjdISHloJXw";

        // Fetch data Base64
        const response = await fetch(webAppUrl, {
          method: "GET",
          cache: "no-cache",
        });

        if (!response.ok) {
          throw new Error(`Gagal memuat data: Status HTTP ${response.status}`);
        }

        const base64Data = await response.text();

        // Base64 error check (jika Apps Script mengembalikan Base64 error message)
        if (base64Data.startsWith("ERROR:")) {
          throw new Error(base64Data);
        }

        // Dekode Base64 menjadi string CSV
        const decodedCsv = atob(base64Data);

        // Parse CSV ke JSON
        const parsedData = parseCSV(decodedCsv);

        // Update state global
        dataPermintaan = parsedData;

        // Hilangkan pesan loading
        listContainer.removeChild(loadingMessage);
      } catch (error) {
        Swal.fire({
          title: "Error!",
          text: `Kesalahan saat mengambil atau memproses data: ${error}`,
          icon: "error",
          confirmButtonText: "OK",
        });
        // Tampilkan pesan error yang ramah di UI
        loadingMessage.className = "p-4 text-center text-red-500 bg-red-50 rounded-lg text-sm font-semibold";
        loadingMessage.textContent = `Gagal memuat data: ${error.message}. Pastikan Web App telah dideploy dengan benar.`;
      }
    }

    /**
     * FUNGSI PERBAIKAN: Mengubah CSV menjadi array of objects,
     * dengan penanganan khusus untuk baris baru di dalam data (field yang dikutip).
     *
     * Harus sesuai dengan urutan kolom di Apps Script:
     * Kode,Prioritas,Kota,Lokasi Yang Diinginkan,Kebutuhan,Tanggal Publish
     */
    function parseCSV(csvString) {
      const internalKeys = ["no_data", "prioritas", "kota", "lokasi_geojson", "kebutuhan", "tanggal"];
      const data = [];
      const lines = csvString.trim().split("\n");

      if (lines.length < 2) return [];

      // Mengambil Baris Header untuk memverifikasi (opsional, untuk debugging)
      // const header = lines[0].split(',').map(h => h.trim());

      // Mulai dari baris 1 untuk melewati header
      let rowData = []; // Array untuk menampung field per baris data
      let inQuotes = false;
      let currentField = "";

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];

        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          const nextChar = line[j + 1];

          if (char === '"') {
            if (inQuotes && nextChar === '"') {
              // Penanganan Kutip Ganda Escaping ("" -> ")
              currentField += '"';
              j++; // Lewati kutip kedua
            } else {
              // Pembuka/Penutup Kutip
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            // Pemisah Koma (hanya jika tidak di dalam kutip)
            rowData.push(currentField.trim());
            currentField = "";
          } else {
            currentField += char;
          }
        }

        // **PERBAIKAN KRITIS UNTUK BARIS BARU:**
        // Jika loop for selesai (akhir dari baris), cek apakah kita masih di dalam kutip.
        // Jika masih, artinya baris ini adalah kelanjutan dari field sebelumnya (multi-baris).
        // Kita tambahkan karakter baris baru ke field saat ini.
        if (inQuotes) {
          currentField += "\n"; // Tambahkan baris baru ke field saat ini
        } else {
          // Jika tidak di dalam kutip, ini adalah akhir dari baris data
          rowData.push(currentField.trim()); // Tambahkan field terakhir
          currentField = ""; // Reset

          // Hanya proses jika jumlah kolom sesuai
          if (rowData.length === internalKeys.length) {
            let row = {};
            rowData.forEach((value, index) => {
              let finalValue = value;

              // Membersihkan value: hilangkan kutip luar
              if (finalValue.startsWith('"') && finalValue.endsWith('"')) {
                finalValue = finalValue.substring(1, finalValue.length - 1);
              }

              // Handling Tanggal Publish: hanya ambil YYYY-MM-DD
              if (internalKeys[index] === "tanggal") {
                finalValue = finalValue.split(" ")[0];
              }

              row[internalKeys[index]] = finalValue;
            });
            data.push(row);
          } else {
            // Ini akan menangkap kasus di mana jumlah kolom tidak 6
            Swal.fire({
              title: "Error!",
              text: `Gagal memproses baris CSV: ${lines[i]}. Kolom yang ditemukan: ${rowData.length}`,
              icon: "error",
              confirmButtonText: "OK",
            });
          }

          rowData = []; // Reset untuk baris data berikutnya
        }
      }

      // Penanganan jika file CSV berakhir saat masih ada field terbuka (kasus langka)
      if (inQuotes && currentField.trim()) {
        Swal.fire({
          title: "Error!",
          text: `CSV berakhir dengan field yang belum ditutup.`,
          icon: "error",
          confirmButtonText: "OK",
        });
      }

      return data;
    }

    // ----------------------------------------------------
    // 5. FUNGSI RENDER UTAMA (Sudah diubah pada bagian tanggal)
    // ----------------------------------------------------

    function updateDashboard() {
      // Update Pagination State
      totalPages = Math.ceil(filteredAndSortedData.length / ITEMS_PER_PAGE);
      const paginatedData = paginateData(filteredAndSortedData);

      // Render Controls
      document.getElementById("total-data-count").textContent = filteredAndSortedData.length;
      document.getElementById("total-pages").textContent = totalPages;
      document.getElementById("page-input").value = currentPage;
      document.getElementById("page-input").max = totalPages;

      document.getElementById("prev-page").disabled = currentPage === 1;
      document.getElementById("next-page").disabled = currentPage === totalPages || totalPages === 0;

      // Render List
      renderList(paginatedData);
    }

    function toMarkdownPreview(text) {
      const markdownText = text.replace(/\n/g, "<br>");

      return marked.parse(markdownText);
    }

    function ubahFormatDataToAngkaReal(dataString) {
      // 1. Cek apakah string dimulai dengan 'Data-'
      if (!dataString || typeof dataString !== "string" || !dataString.startsWith("Data-")) {
        Swal.fire({
          title: "Error!",
          text: `Input tidak valid atau tidak berformat 'Data-XXXX'.`,
          icon: "error",
          confirmButtonText: "OK",
        });
        return null;
      }

      // 2. Ambil hanya bagian angkanya (misalnya "0001")
      const angkaString = dataString.substring(5); // Ambil substring setelah 'Data-' (5 karakter)

      // 3. Konversi string angka tersebut menjadi bilangan bulat (number)
      //    Fungsi parseInt() secara otomatis mengabaikan nol di awal.
      const angkaBersih = parseInt(angkaString, 10); // Basis 10 (desimal)

      // 4. Cek apakah konversi berhasil
      if (isNaN(angkaBersih)) {
        Swal.fire({
          title: "Error!",
          text: `Gagal mengkonversi bagian angka.`,
          icon: "error",
          confirmButtonText: "OK",
        });
        return null;
      }

      return angkaBersih;
    }

    /**
     * Fungsi minimalis untuk konversi Markdown ke HTML
     * Mendukung: *bold* dan Baris Baru (\n ke <br>)
     */
    function markdownToHtml(markdown) {
      if (!markdown) return "";
      // 1. Konversi baris baru menjadi <br> (penting untuk data multi-baris)
      let html = markdown.replace(/\n/g, "<br>");
      return marked.parse(html);
    }

    function renderList(requests) {
      const listContainer = document.getElementById("permintaan-list");
      listContainer.innerHTML = "";

      if (requests.length === 0) {
        // PERUBAHAN DARK MODE: bg-gray-50 -> dark:bg-gray-800, text-gray-500 -> dark:text-gray-400
        listContainer.innerHTML = '<p class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg text-sm dark:bg-gray-800 dark:text-gray-400">Tidak ada data yang cocok dengan kriteria pencarian.</p>';
        return;
      }

      requests.forEach((req) => {
        // Status Check Baru
        const status = (req.prioritas || "").toUpperCase();
        const isClosed = status === "SUDAH DAPAT";

        // Asumsi nomor kontak statis
        const nomorKontak = "6282231320160";

        // Teks yang akan dikirim (menggunakan req.no_data)
        const encodedMessage = encodeURIComponent(`Permintaan No: *${req.no_data}*\n` + `Halo mas sofi.. Aku ada kontrakan yang cocok buat permintaan ini..`);

        // Gabungkan nomor WhatsApp dengan teks otomatis
        const waLink = `https://wa.me/${nomorKontak}?text=${encodedMessage}`;

        // MENGGUNAKAN FUNGSI BADGE BARU
        const priorityBadgeHtml = getPriorityBadgeHtml(req.prioritas); // Asumsi badge juga sudah support dark mode

        // PERUBAHAN UTAMA: Format tanggal ke format Hari, DD Bulan YYYY
        const formattedDate = formatDateIndonesia(req.tanggal);

        // **PERBAIKAN:** Konversi req.kebutuhan dari Markdown ke HTML
        const kebutuhanHtml = markdownToHtml(req.kebutuhan);

        // Tentukan kelas styling berdasarkan status
        let gutterColorClass;
        let itemClasses;
        let headerTextColor;
        let headerIconColor;
        let mapTextColor;
        let whatsappButtonHtml;
        let whatsappButtonColor;
        let whatsappButtonColorHover;
        let polygonColor;
        let polygonFillColor;
        let dividerClass; // Kelas untuk garis pemisah

        if (isClosed) {
          // --- Styling Abu-abu untuk Status SUDAH DAPAT ---
          gutterColorClass = "bg-gray-400";
          // PERUBAHAN DARK MODE: bg-gray-50 -> dark:bg-gray-800, border-gray-300 -> dark:border-gray-700, opacity-70
          itemClasses = `permintaan-item relative p-4 bg-gray-50 border border-gray-300 rounded-xl shadow-sm opacity-70 cursor-default dark:bg-gray-800 dark:border-gray-700`;
          // PERUBAHAN DARK MODE: text-gray-500 -> dark:text-gray-400
          headerTextColor = "text-gray-500 dark:text-gray-400"; // toExcel-btn
          headerIconColor = "text-gray-500 dark:text-gray-400"; // toExcel-btn
          mapTextColor = "text-gray-500 dark:text-gray-400"; // "Klik untuk melihat area yang diinginkan"
          dividerClass = "border-gray-400"; // Garis pemisah

          // Tombol WhatsApp diganti div statis non-interaktif
          whatsappButtonHtml = `
                  <div class="w-full mt-4 flex items-center justify-center gap-2 space-x-2 bg-gray-400 text-white p-2 rounded-lg text-sm font-bold cursor-not-allowed">
                      <i class="fab fa-whatsapp"></i> Status Selesai (Tidak Dapat Diajukan)
                  </div>
              `;
        } else {
          // --- Styling Normal (Aktif) ---
          if (status === "DIBUTUHKAN CEPAT") {
            gutterColorClass = "bg-yellow-500";
            // PERUBAHAN DARK MODE: text-yellow-800 -> dark:text-yellow-400
            headerTextColor = "text-yellow-800 dark:text-yellow-400";
            // PERUBAHAN DARK MODE: text-yellow-500 -> dark:text-yellow-400 (untuk icon)
            headerIconColor = "text-yellow-500 dark:text-yellow-400";
            whatsappButtonColor = "bg-yellow-600";
            whatsappButtonColorHover = "bg-yellow-700";
            polygonColor = "#ca8a04";
            polygonFillColor = "#facc15";
          } else if (status === "DICARI") {
            gutterColorClass = "bg-blue-500";
            // PERUBAHAN DARK MODE: text-blue-800 -> dark:text-blue-400
            headerTextColor = "text-blue-800 dark:text-blue-400";
            // PERUBAHAN DARK MODE: text-blue-500 -> dark:text-blue-400 (untuk icon)
            headerIconColor = "text-blue-500 dark:text-blue-400";
            whatsappButtonColor = "bg-blue-500";
            whatsappButtonColorHover = "bg-blue-600";
            polygonColor = "#1d4ed8";
            polygonFillColor = "#3b82f6";
          } else {
            gutterColorClass = "bg-gray-300";
            // PERUBAHAN DARK MODE: text-gray-800/700/500
            headerTextColor = "text-gray-800 dark:text-gray-300";
            headerIconColor = "text-gray-500 dark:text-gray-400";
            whatsappButtonColor = "bg-gray-500";
            whatsappButtonColorHover = "bg-gray-600";
            polygonColor = "#9ca3af";
            polygonFillColor = "#d1d5db";
          }

          // PERUBAHAN DARK MODE: bg-white -> dark:bg-gray-700, border-gray-200 -> dark:border-gray-600, hover:bg-gray-50 -> dark:hover:bg-gray-600
          itemClasses = `permintaan-item relative p-4 bg-white border border-gray-200 rounded-xl shadow-md cursor-pointer transition duration-300 hover:shadow-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 hover:dark:bg-gray-800`;

          // PERUBAHAN DARK MODE: text-gray-500 -> dark:text-gray-400
          mapTextColor = "text-gray-500 dark:text-gray-400";
          dividerClass = "border-gray-400";

          // Tombol WhatsApp interaktif
          whatsappButtonHtml = `
                  <a href="${waLink}" target="_blank" class="contact-btn w-full mt-4 flex items-center justify-center gap-2 space-x-2 ${whatsappButtonColor} text-white p-2 rounded-lg text-sm font-bold hover:${whatsappButtonColorHover} transition duration-150">
                      <i class="fab fa-whatsapp"></i> Ajukan Penawaran
                  </a>
              `;
        }

        const listItem = document.createElement("div");

        // Gunakan kelas yang sudah ditentukan
        listItem.className = itemClasses;

        listItem.innerHTML = `
              <div class="absolute inset-y-0 left-0 w-2 ${gutterColorClass} rounded-l-xl transition-colors"></div>

              <div class="pl-3 space-y-3">
                  <div class="flex justify-between items-start pb-2 border-b border-dashed ${dividerClass}">
                      <h4 class="toExcel-btn text-lg font-bold ${headerTextColor}">#${req.no_data}</h4>
                      <div class="text-xl ${headerIconColor}" title="Permintaan ${isClosed ? "Selesai" : "Aktif"}"><i class="fas fa-check-circle"></i></div> 
                  </div>

                  <div class="flex">
                      <div class="text-sm font-medium">
                          ${priorityBadgeHtml}
                      </div>
                  </div>

                  <div class="flex items-center space-x-3">
                      <i class="fas fa-calendar-alt ${isClosed ? "text-gray-500 dark:text-gray-400" : "text-gray-500 dark:text-gray-400"} w-5 text-center"></i>
                      <div class="text-sm">
                          <strong class="block text-gray-500 uppercase text-xs dark:text-gray-400">Tanggal Publikasi</strong>
                          <span class="font-semibold ${isClosed ? "text-gray-700 dark:text-gray-400" : "text-gray-800 dark:text-gray-300"}">${formattedDate}</span>
                      </div>
                  </div>

                  <div class="flex items-center space-x-3">
                      <i class="fas fa-city ${isClosed ? "text-gray-500 dark:text-gray-400" : "text-gray-500 dark:text-gray-400"} w-5 text-center"></i>
                      <div class="text-sm">
                          <strong class="block text-gray-500 uppercase text-xs dark:text-gray-400">Kota</strong>
                          <span class="font-semibold ${isClosed ? "text-gray-700 dark:text-gray-400" : "text-gray-800 dark:text-gray-300"}">${req.kota}</span>
                      </div>
                  </div>

                  <div class="flex items-start space-x-3 pb-4 mb-4 border-b border-dashed ${dividerClass}">
                      <i class="fas fa-bullhorn ${isClosed ? "text-gray-500 dark:text-gray-400" : "text-gray-500 dark:text-gray-400"} w-5 text-center mt-1"></i>
                      <div class="text-sm flex-1">
                          <strong class="block text-gray-500 uppercase text-xs dark:text-gray-400">Deskripsi Kebutuhan</strong>
                          <span class="font-medium ${isClosed ? "text-gray-700 dark:text-gray-400" : "text-gray-700 dark:text-gray-300"} tracking-wide text-justify">${kebutuhanHtml}</span>
                      </div>
                  </div>
              </div>

              <p class="text-center text-xs font-semibold ${mapTextColor}">
                  <i class="fas fa-map-marked-alt mr-1"></i> Klik untuk melihat area yang diinginkan.
              </p>

              ${whatsappButtonHtml}
          `;

        // Logika GeoJSON Klik hanya jika TIDAK SUDAH DAPAT
        if (!isClosed) {
          listItem.addEventListener("click", (e) => {
            // Mencegah klik saat tombol kontak/excel diklik
            if (e.target.closest(".contact-btn") || e.target.closest(".toExcel-btn")) {
              return;
            }

            try {
              // 3. VALIDASI DATA
              const geoJsonString = req.lokasi_geojson;
              if (!geoJsonString || geoJsonString.trim() === "") {
                Swal.fire({
                  title: "Error!",
                  text: `Gagal memuat peta untuk ${req.no_data}. Data Lokasi Kosong.`,
                  icon: "error",
                  confirmButtonText: "OK",
                });
                // Perbarui status tombol jika diperlukan (misalnya, menonaktifkan tombol simpan)
                updateButtonState(); // Panggil ini jika Anda memiliki tombol yang perlu di-update
                return;
              }

              // ==========================================================
              // ‚≠êÔ∏è 1. LOGIKA PENGECEKAN DUPLIKAT TAMBAHAN (DENGAN no_data) ‚≠êÔ∏è
              // ==========================================================

              // Cek apakah layer dengan no_data yang sama sudah ada di peta
              const isAlreadyDrawn = allDrawnPolygons.some((layer) => layer._uniqueId === req.no_data);

              if (isAlreadyDrawn) {
                // Opsional: Langsung fokus ke bounds layer yang sudah ada
                const existingLayer = allDrawnPolygons.find((layer) => layer._uniqueId === req.no_data);
                if (existingLayer && existingLayer.getBounds().isValid()) {
                  map.flyToBounds(existingLayer.getBounds(), { padding: [20, 20] });
                }

                // Perbarui status tombol/UI yang bergantung pada allDrawnPolygons
                updateButtonState();

                // Pindah ke tampilan peta
                document.getElementById("map").classList.remove("hidden");
                document.getElementById("list-data-container").classList.add("hidden");
                document.getElementById("sidebar-menu-button-tampilkan-map").classList.add("hidden");
                document.getElementById("sidebar-menu-button-tampilkan-list-data").classList.remove("hidden");
                map.invalidateSize();

                return; // Hentikan eksekusi
              } else {
                // 4. PARSING DAN MEMBUAT LAYER GEOJSON
                const geoJsonData = JSON.parse(geoJsonString);

                // Membuat layer GeoJSON
                const geoJsonLayer = L.geoJSON(geoJsonData, {
                  style: {
                    // Menggunakan gaya yang berbeda agar terlihat jelas bahwa ini adalah data yang dimuat
                    color: polygonColor, // Warna yang berbeda
                    weight: 3,
                    opacity: 1,
                    fillColor: polygonFillColor, // Warna yang berbeda
                    fillOpacity: 0.15,
                  },
                  onEachFeature: function (feature, layer) {
                    // Hanya tambahkan popup untuk tipe geometri yang sesuai
                    if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
                      // Catatan: Pastikan Anda masih memiliki variabel headerTextColor yang ditentukan di luar blok ini
                      // (berasal dari logika DIBUTUHKAN CEPAT/DICARI/dll.)

                      var popupContent = `
                      <div class="p-4 rounded-lg bg-white dark:bg-gray-800">
                        <div class="pl-0 space-y-3">
                            <div class="flex justify-between items-start pb-2 border-b border-dashed ${dividerClass}">
                                <h4 class="text-lg font-bold ${headerTextColor}">#${req.no_data}</h4>
                            </div>

                            <div class="flex">
                                <div class="text-sm font-medium">
                                    ${priorityBadgeHtml}
                                </div>
                            </div>

                            <div class="flex items-center space-x-3">
                                <i class="fas fa-calendar-alt text-gray-500 dark:text-gray-400 w-5 text-center"></i>
                                <div class="text-sm">
                                    <strong class="block text-gray-500 uppercase text-xs dark:text-gray-400">Tanggal Publikasi</strong>
                                    <span class="font-semibold text-gray-800 dark:text-gray-300">${formattedDate}</span>
                                </div>
                            </div>

                            <div class="flex items-center space-x-3">
                                <i class="fas fa-city text-gray-500 dark:text-gray-400 w-5 text-center"></i>
                                <div class="text-sm">
                                    <strong class="block text-gray-500 uppercase text-xs dark:text-gray-400">Kota</strong>
                                    <span class="font-semibold text-gray-800 dark:text-gray-300">${req.kota}</span>
                                </div>
                            </div>

                            <div class="flex items-start space-x-3">
                                <i class="fas fa-bullhorn text-gray-500 dark:text-gray-400 w-5 text-center mt-1"></i>
                                <div class="text-sm flex-1">
                                    <strong class="block text-gray-500 uppercase text-xs dark:text-gray-400">Deskripsi Kebutuhan</strong>
                                    <span 
                                      id="deskripsi-kebutuhan-${req.no_data}"
                                      class="font-medium text-gray-700 dark:text-gray-300 tracking-wide text-justify">
                                      ${kebutuhanHtml}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <button 
                            onclick="window.copyRequirementDescriptionPolygonPermintaan('deskripsi-kebutuhan-${req.no_data}')" 
                            class="w-full text-sm font-semibold py-2 px-3 rounded-md mt-4
                                  bg-blue-500 hover:bg-blue-600 text-white 
                                  transition duration-150 ease-in-out"> 
                            Salin Deskripsi
                        </button>
                        
                        <button 
                            onclick="window.removeSpecificPolygonPermintaan(this.layerRef)" 
                            class="w-full text-sm font-semibold py-2 px-3 rounded-md mt-2
                                  bg-red-500 hover:bg-red-600 text-white 
                                  transition duration-150 ease-in-out">
                            Hapus Seleksi Ini
                        </button>
                      </div>
                  `;

                      // Bind popup dan BUKAN openPopup, ini dilakukan nanti
                      layer.bindPopup(popupContent, {
                        // Opsi Leaflet untuk popup
                        minWidth: 200,
                        className: "custom-popup-wilayah-seleksi",
                      });

                      // **2. Kunci Layer Ref ke tombol:**
                      // Setelah layer terikat, kita bisa mengakses elemen popup.
                      layer.on("popupopen", function (e) {
                        // Cari tombol "Hapus Seleksi Ini" di dalam popup yang baru terbuka
                        const buttonRemove = e.popup.getElement().querySelector('button[onclick*="removeSpecificPolygonPermintaan"]');
                        if (buttonRemove) {
                          // Simpan referensi layer Leaflet ke properti DOM kustom pada tombol
                          buttonRemove.layerRef = geoJsonLayer;
                        }
                      });

                      // Buka Popup secara otomatis
                      layer.openPopup();
                    }
                  },
                }).addTo(map);

                // ==========================================================
                // ‚≠êÔ∏è 2. PENYIMPANAN ID UNIK DI LAYER ‚≠êÔ∏è
                // ==========================================================
                // Tambahkan properti unik ke layer untuk identifikasi
                geoJsonLayer._uniqueId = req.no_data;

                // 5. UPDATE allDrawnPolygons dan UI
                // Tambahkan layer GeoJSON ke array allDrawnPolygons
                allDrawnPolygons.push(geoJsonLayer); // <-- BAGIAN UTAMA YANG DI-UPDATE

                // Perbarui status tombol/UI yang bergantung pada allDrawnPolygons
                updateButtonState();

                // 6. ZOOM PETA
                document.getElementById("map").classList.remove("hidden");
                document.getElementById("list-data-container").classList.add("hidden");
                document.getElementById("sidebar-menu-button-tampilkan-map").classList.add("hidden");
                document.getElementById("sidebar-menu-button-tampilkan-list-data").classList.remove("hidden");
                map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran

                const bounds = geoJsonLayer.getBounds();
                if (bounds.isValid()) {
                  map.flyToBounds(bounds, { padding: [20, 20] });
                } else {
                  // Koordinat default jika bounds tidak valid
                  map.setView([-6.2, 106.8], 13);
                }
              }
            } catch (error) {
              Swal.fire({
                title: "Error!",
                text: `Kesalahan Parsing GeoJSON untuk data ${req.no_data}: ${error}`,
                icon: "error",
                confirmButtonText: "OK",
              });
              updateButtonState(); // Panggil ini juga jika terjadi error
            }
          });

          listItem.addEventListener("dblclick", function (e) {
            if (e.target.closest(".toExcel-btn")) {
              window.open(`https://docs.google.com/spreadsheets/d/1lB8i6Zy7kEke6-pHkbf8AbChocyl4a6j-jTbnmSRqE8/edit?gid=0#gid=0&range=${ubahFormatDataToAngkaReal(req.no_data) + 1}:${ubahFormatDataToAngkaReal(req.no_data) + 1}`, "_blank");
            }
          });
        }

        listContainer.appendChild(listItem);
      });
    }

    function add() {
      seconds++;
      if (seconds >= 60) {
        seconds = 0;
        minutes++;
        if (minutes >= 60) {
          minutes = 0;
          hours++;
        }
      }

      document.getElementById("stopwatch").textContent = (hours ? (hours > 9 ? hours : "0" + hours) : "00") + ":" + (minutes ? (minutes > 9 ? minutes : "0" + minutes) : "00") + ":" + (seconds > 9 ? seconds : "0" + seconds);

      timer();
    }

    function timer() {
      t = setTimeout(add, 1000);
    }

    // Start the stopwatch when the page loads
    document.addEventListener("DOMContentLoaded", timer);

    const map = L.map("map", {
      attributionControl: false, // Matikan attribution bawaan Leaflet
      zoomControl: false,
    }).setView([-7.9519144, 112.6136692], 15);
    const markers = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      spiderfyDistanceMultiplier: 6,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
    });

    let popupOpen = false;

    // Daftar tile layer dengan urutan prioritas
    var tileLayers = [
      {
        name: "cartocdn dark API",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.cartocdn.com/">cartocdn</a>, &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/home">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: true,
      },
      {
        name: "Thunderforest",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.thunderforest.com/">Thunderforest1</a>, &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/home">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=6e5478c8a4f54c779f85573c0e399391", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: false,
      },
      {
        name: "Thunderforest",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.thunderforest.com/">Thunderforest2</a>, &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/home">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=bef62649ec0a47d7bc71106f7d10e991", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: false,
      },
      {
        name: "OpenStreetMap Standard",
        attribution: '<a href="https://leafletjs.com/">Leaflet</a> | &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://www.kontrakyuk.github.io/home">KontrakYuk</a>',
        layer: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
        }),
        fallback: false,
        isDark: false,
      },
    ];

    const themeToggleBtn = document.getElementById("theme-toggle");
    const themeToggleText = document.getElementById("theme-toggle-text");
    const themeToggleLightIcon = document.getElementById("theme-toggle-light-icon");
    const themeToggleDarkIcon = document.getElementById("theme-toggle-dark-icon");

    // Check for saved user preference or use system preference
    if (localStorage.getItem("color-theme") === "dark") {
      document.documentElement.classList.add("dark");
      themeToggleLightIcon.classList.add("hidden");
      themeToggleDarkIcon.classList.remove("hidden");
      themeToggleText.innerHTML = "Mode Gelap";
    } else {
      document.documentElement.classList.remove("dark");
      themeToggleLightIcon.classList.remove("hidden");
      themeToggleDarkIcon.classList.add("hidden");
      themeToggleText.innerHTML = "Mode Terang";
    }

    // Toggle between light and dark mode
    themeToggleBtn.addEventListener("click", function () {
      // Toggle icons
      themeToggleLightIcon.classList.toggle("hidden");
      themeToggleDarkIcon.classList.toggle("hidden");

      // Toggle theme
      if (document.documentElement.classList.contains("dark")) {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("color-theme", "light");
        themeToggleText.innerHTML = "Mode Terang";
      } else {
        document.documentElement.classList.add("dark");
        localStorage.setItem("color-theme", "dark");
        themeToggleText.innerHTML = "Mode Gelap";
      }
    });

    // Buat custom attribution control
    var attributionControl = L.control
      .attribution({
        position: "bottomright",
        prefix: false,
      })
      .addTo(map);

    // Fungsi untuk memilih layer berdasarkan preferensi warna
    function selectInitialLayer() {
      // Cek dark mode dari class 'dark' pada html element (umumnya digunakan oleh framework seperti Tailwind)
      const htmlElement = document.documentElement;
      const classDarkMode = htmlElement.classList.contains("dark");

      // Jika salah satu kondisi dark mode terpenuhi
      if (classDarkMode) {
        // Gunakan layer dark (indeks 0)
        return tileLayers[0];
      } else {
        // Gunakan layer pertama yang bukan dark (lewatkan indeks 0)
        for (let i = 1; i < tileLayers.length; i++) {
          if (!tileLayers[i].isDark) {
            return tileLayers[i];
          }
        }
        // Fallback ke layer terakhir jika tidak ada yang cocok
        return tileLayers[tileLayers.length - 1];
      }
    }

    // Fungsi untuk memantau perubahan class 'dark' pada html element
    function observeDarkClassChange() {
      const htmlElement = document.documentElement;

      // Buat observer untuk memantau perubahan class
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.attributeName === "class") {
            switchLayerBasedOnColorScheme();
          }
        });
      });

      // Mulai mengamati perubahan atribut class
      observer.observe(htmlElement, {
        attributes: true,
        attributeFilter: ["class"],
      });
    }

    // Panggil fungsi observer saat inisialisasi
    observeDarkClassChange();

    // Fungsi untuk mengganti layer berdasarkan preferensi warna
    function switchLayerBasedOnColorScheme() {
      // Dapatkan layer aktif saat ini
      var currentLayer = tileLayers.find((layer) => map.hasLayer(layer.layer));

      // Cek kedua kondisi dark mode
      const classDarkMode = document.documentElement.classList.contains("dark");
      const isDarkMode = classDarkMode;

      // Pilih layer baru berdasarkan preferensi warna
      var newLayer;
      if (isDarkMode) {
        // Cari layer dark pertama yang tersedia
        newLayer = tileLayers.find((layer) => layer.isDark);
      } else {
        // Cari layer non-dark pertama yang tersedia (lewatkan indeks 0)
        for (let i = 1; i < tileLayers.length; i++) {
          if (!tileLayers[i].isDark) {
            newLayer = tileLayers[i];
            break;
          }
        }
      }

      // Jika tidak ada layer yang sesuai, gunakan layer terakhir
      if (!newLayer) {
        newLayer = tileLayers[tileLayers.length - 1];
      }

      // Jika layer baru berbeda dengan layer saat ini
      if (!currentLayer || newLayer.name !== currentLayer.name) {
        // Hapus semua layer dari peta
        tileLayers.forEach((layer) => {
          if (map.hasLayer(layer.layer)) {
            map.removeLayer(layer.layer);
          }
        });

        // Tambahkan layer baru
        newLayer.layer.addTo(map);
        updateAttribution(newLayer.attribution);

        // Reset status fallback untuk semua layer
        tileLayers.forEach((layer) => {
          layer.fallback = false;
        });
      }
    }

    // Pilih dan tambahkan layer awal
    var initialLayer = selectInitialLayer();
    initialLayer.layer.addTo(map);
    attributionControl.addAttribution(initialLayer.attribution);

    // Variabel untuk menyimpan marker hasil pencarian
    var activeSearchMarker = {};

    // --- FUNGSI UNTUK MENGHAPUS MARKER ---
    window.removeSpecificSearchMarker = function (markerId) {
      if (activeSearchMarker[markerId]) {
        // Hapus Marker dari peta
        map.removeLayer(activeSearchMarker[markerId].marker);

        // Hapus Lingkaran dari peta
        map.removeLayer(activeSearchMarker[markerId].circle);

        // Hapus dari object penyimpanan
        delete activeSearchMarker[markerId];
      }
    };

    // --- FUNGSI UNTUK Menyalin teks dari elemen HTML berdasarkan ID-nya ke clipboard ---
    window.copyRequirementDescriptionPolygonPermintaan = function (elementId) {
      const textElement = document.getElementById(elementId);

      // Konfigurasi SweetAlert2 Toast
      const Toast = Swal.mixin({
        toast: true,
        position: "top-end", // Tampilkan di pojok kanan atas
        showConfirmButton: false, // Tidak ada tombol konfirmasi
        timer: 3000, // Hilang setelah 3 detik
        timerProgressBar: true, // Tampilkan progress bar
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      if (textElement) {
        const textToCopy = textElement.innerText || textElement.textContent;

        if (navigator.clipboard) {
          navigator.clipboard
            .writeText(textToCopy)
            .then(() => {
              // Tampilkan notifikasi SUKSES dengan Swal Toast
              Toast.fire({
                icon: "success",
                title: "Deskripsi berhasil disalin!",
              });
            })
            .catch((err) => {
              // Tampilkan notifikasi GAGAL dengan Swal Toast
              console.error("Gagal menyalin deskripsi:", err);
              Toast.fire({
                icon: "error",
                title: "Gagal menyalin teks.",
              });
            });
        } else {
          // Fallback untuk browser lama
          try {
            const tempInput = document.createElement("textarea");
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);

            // Tampilkan notifikasi SUKSES dengan Swal Toast
            Toast.fire({
              icon: "success",
              title: "Deskripsi berhasil disalin (Fallback)!",
            });
          } catch (err) {
            // Tampilkan notifikasi GAGAL dengan Swal Toast
            console.error("Gagal menyalin deskripsi (fallback):", err);
            Toast.fire({
              icon: "error",
              title: "Gagal menyalin. Browser lama tidak mendukung API clipboard.",
            });
          }
        }
      } else {
        // Tampilkan notifikasi GAGAL jika elemen tidak ditemukan
        Toast.fire({
          icon: "error",
          title: "Gagal: Elemen deskripsi tidak ditemukan.",
        });
      }
    };

    // --- FUNGSI UNTUK MENGHAPUS POLYGON PERMINTAAN DENGAN KONFIRMASI SWAL ---
    window.removeSpecificPolygonPermintaan = function (layer) {
      if (!layer) {
        return;
      }

      // 1. Tampilkan Swal Konfirmasi
      Swal.fire({
        title: "Anda Yakin?",
        text: "Anda tidak akan bisa mengembalikan seleksi ini!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33", // Merah untuk Hapus
        cancelButtonColor: "#3085d6", // Biru untuk Batal
        confirmButtonText: "Ya, Hapus!",
        cancelButtonText: "Batal",
      }).then((result) => {
        // Lanjutkan hanya jika pengguna menekan tombol "Ya, Hapus Saja!"
        if (result.isConfirmed) {
          performRemoval(layer);
        }
      });
    };

    /**
     * Fungsi internal untuk menjalankan proses penghapusan poligon yang sebenarnya.
     * Dipanggil hanya setelah konfirmasi dari Swal.
     * @param {L.Layer} layer - Layer Leaflet yang akan dihapus.
     */
    function performRemoval(layer) {
      try {
        // PENTING: Tutup popup sebelum dihapus agar tidak ada referensi yang menggantung
        layer.closePopup();

        // 1. Hapus Layer dari Peta Leaflet
        // Asumsi 'map' adalah variabel global yang menyimpan instance peta Leaflet
        if (window.map && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }

        // 2. Hapus Layer dari Array Pelacakan Global (allDrawnPolygons)
        // Asumsi 'allDrawnPolygons' adalah array global yang melacak semua poligon
        if (allDrawnPolygons.length > 0) {
          const index = allDrawnPolygons.indexOf(layer);

          if (index > -1) {
            allDrawnPolygons.splice(index, 1);
          }
        }

        // 3. Perbarui Status UI (jika ada)
        // Asumsi 'updateButtonState' adalah fungsi yang Anda miliki
        if (typeof window.updateButtonState === "function") {
          updateButtonState();
        }

        // 4. Tampilkan Swal Sukses (Toast di Pojok Atas)
        Swal.mixin({
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true,
        }).fire({
          icon: "success",
          title: "Seleksi berhasil dihapus!",
          // --- PENAMBAHAN CUSTOM CLASS DI SINI ---
          customClass: {
            popup: "swal2-remove-polygon-done-dark-mode-popup",
          },
        });
      } catch (error) {
        console.error("Gagal menghapus poligon:", error);
        // Tampilkan Swal Error jika proses penghapusan gagal
        Swal.fire("Gagal!", "Terjadi kesalahan saat mencoba menghapus seleksi.", "error");
      }
    }

    // --- FUNGSI UNTUK MENGHAPUS POLYGON MANUAL DENGAN KONFIRMASI SWAL ---
    window.removeSpecificPolygonManual = function (layer) {
      if (!layer) {
        return;
      }

      // 1. Tampilkan Swal Konfirmasi
      Swal.fire({
        title: "Konfirmasi Penghapusan",
        text: "Anda akan menghapus seleksi manual yang ini. Lanjutkan?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33", // Merah untuk Hapus
        cancelButtonColor: "#3085d6", // Biru untuk Batal
        confirmButtonText: "Ya, Hapus!",
        cancelButtonText: "Batal",
      }).then((result) => {
        // Lanjutkan hanya jika pengguna menekan tombol "Ya, Hapus Sekarang!"
        if (result.isConfirmed) {
          performManualRemoval(layer);
        }
      });
    };

    /**
     * Fungsi internal untuk menjalankan proses penghapusan poligon manual yang sebenarnya.
     * Dipanggil hanya setelah konfirmasi dari Swal.
     * @param {L.Layer} layer - Layer Leaflet yang akan dihapus.
     */
    function performManualRemoval(layer) {
      try {
        // 1. Hapus poligon dari peta
        // Asumsi 'map' adalah variabel global
        if (window.map && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }

        // 2. Hapus poligon dari array allDrawnPolygons
        // Asumsi 'allDrawnPolygons' adalah variabel global
        if (allDrawnPolygons.length > 0) {
          const index = allDrawnPolygons.indexOf(layer);
          if (index > -1) {
            allDrawnPolygons.splice(index, 1);
          }
        }

        // 3. Perbarui tampilan (jika ada tombol atau status lain)
        // Asumsi 'updateButtonState' adalah fungsi yang Anda miliki
        if (typeof window.updateButtonState === "function") {
          updateButtonState();
        }

        // 4. Tampilkan Swal Sukses (Toast di Pojok Atas)
        Swal.mixin({
          toast: true,
          position: "top-end", // Tampilkan di pojok kanan atas
          showConfirmButton: false, // Tidak ada tombol konfirmasi
          timer: 3000, // Hilang setelah 3 detik
          timerProgressBar: true,
        }).fire({
          icon: "success",
          title: "Seleksi berhasil dihapus!",
        });
      } catch (error) {
        console.error("Gagal menghapus poligon manual:", error);
        // Tampilkan Swal Error jika proses penghapusan gagal
        Swal.fire("Gagal!", "Terjadi kesalahan saat mencoba menghapus poligon secara manual.", "error");
      }
    }

    // --- FUNGSI UTAMA PENCARIAN ---
    L.Control.geocoder({
      defaultMarkGeocode: false,
      placeholder: "Cari alamat atau lokasi...",
    })
      .on("markgeocode", function (e) {
        var markerId = "marker-" + Date.now() + Math.floor(Math.random() * 1000);
        var center = e.geocode.center;
        var bounds = e.geocode.bbox;
        var locationName = e.geocode.name;

        // üéØ KONTEN POPUP DENGAN TAILWIND CSS
        var popupContent = `
            <div class="p-4 bg-white shadow-xl rounded-lg dark:bg-gray-800">
                <div class="text-sm font-semibold text-gray-800 mb-2 dark:text-white">
                    Lokasi Ditemukan
                </div>
                <div class="text-sm text-gray-600 mb-3 leading-tight dark:text-gray-300">
                    ${locationName}
                </div>
                <button 
                    onclick="window.removeSpecificSearchMarker('${markerId}')" 
                    class="w-full text-sm font-semibold py-2 px-3 rounded-md 
                           bg-red-500 hover:bg-red-600 text-white 
                           transition duration-150 ease-in-out">
                    Hapus Tanda
                </button>
            </div>
        `;

        // A. Buat Lingkaran (Circle)
        var newCircle = L.circle(center, {
          color: "red", // Warna garis lingkaran
          fillColor: "#f03", // Warna isi lingkaran (merah muda)
          fillOpacity: 0.2, // Opasitas isi
          radius: 300, // Jari-jari lingkaran dalam meter (misal: 300 meter)
        }).addTo(map);

        // B. Buat Marker
        searchMarker = L.marker(center)
          .addTo(map)
          .bindPopup(popupContent, {
            // Opsi Leaflet untuk popup
            closeButton: false, // Menghilangkan tombol close X default Leaflet
            minWidth: 200, // Lebar minimum popup
            className: "custom-popup-wilayah-seleksi", // Kelas khusus jika Anda perlu styling tambahan
          })
          .openPopup();

        // C. Simpan Marker dan Lingkaran ke activeLayers
        activeSearchMarker[markerId] = {
          marker: searchMarker,
          circle: newCircle,
        };

        // Sesuaikan peta ke area yang ditemukan (fitBounds)
        if (bounds && bounds.length === 4) {
          var southWest = L.latLng(bounds[0], bounds[2]);
          var northEast = L.latLng(bounds[1], bounds[3]);
          var validBounds = L.latLngBounds(southWest, northEast);

          if (validBounds.isValid()) {
            map.fitBounds(validBounds, { padding: [50, 50] });
          } else {
            map.setView(center, 16);
          }
        } else {
          map.setView(center, 16);
        }
      })
      .addTo(map);

    // VARIABEL GLOBAL PENTING
    let locationGroup = new L.FeatureGroup().addTo(map);
    let watchId = null;
    const locateButtonId = "locate-btn";
    const stopButtonId = "stop-btn";
    let isFollowing = false;

    // --- FUNGSI UTILITY CUSTOM MARKER ---

    const pulseIcon = L.divIcon({
      html: `
            <div class="location-marker-pulse"></div>
            <div class="location-marker-core"></div> 
        `,
      className: "location-marker-container",
      iconSize: [64, 64],
      iconAnchor: [0, 0],
    });

    // --- FUNGSI GEOLOCATION ---

    function onLocationFound(position) {
      const latlng = [position.coords.latitude, position.coords.longitude];

      // 1. Update Marker (Hapus yang lama, tambahkan yang baru)
      locationGroup.clearLayers();

      var popupLocationContent = `
                      <div class="p-2 text-center rounded-lg bg-white dark:bg-gray-800">
                        <h4 class="text-gray-800 dark:text-gray-300">Posisi Anda saat ini.</h4>
                      </div>
                  `;

      // 2. Tambahkan Animasi Pulse (DivIcon kustom) DENGAN Z-INDEX TERTINGGI
      L.marker(latlng, {
        icon: pulseIcon,
        zIndexOffset: 9000, // zIndexOffset yang sangat tinggi
      })
        .addTo(locationGroup)
        .bindPopup(popupLocationContent, {
          // Opsi Leaflet untuk popup
          closeButton: false,
          className: "custom-popup-wilayah-seleksi",
        });

      // Panggil bringToFront() pada L.FeatureGroup yang sekarang sudah valid
      locationGroup.bringToFront();

      // 3. Kontrol Fitur Mengikuti Peta
      if (isFollowing) {
        map.setView(latlng, map.getZoom());
      }
    }

    function onLocationError(error) {
      alert("Gagal melacak lokasi: " + error.message + "\n\nPelacakan dihentikan.");
      stopRealtimeTrackingHard();
      Swal.fire({
        title: "Error!",
        text: `Error Geolocation: ${error.message}`,
        icon: "error",
        confirmButtonText: "OK",
      });
    }

    // --- PENDENGAR EVENT PETA ---

    map.on("dragstart", function () {
      if (isFollowing) {
        isFollowing = false;

        document.getElementById(locateButtonId).classList.remove("active-tracking");
      }
    });

    // --- FUNGSI KONTROL PELACAKAN ---

    /**
     * Fungsi untuk memulai pelacakan (tracking) dan mengikuti (following)
     */
    function startRealtimeTracking() {
      if ("geolocation" in navigator) {
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
        }

        watchId = navigator.geolocation.watchPosition(onLocationFound, onLocationError, { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });

        isFollowing = true;

        // Perbarui UI
        const locateBtn = document.getElementById(locateButtonId);
        const stopBtn = document.getElementById(stopButtonId);
        locateBtn.classList.add("active-tracking");
        stopBtn.style.display = "flex"; // Tampilkan tombol STOP
      } else {
        Swal.fire({
          title: "Error!",
          text: `Browser Anda tidak mendukung Geolocation API.`,
          icon: "error",
          confirmButtonText: "OK",
        });
      }
    }

    /**
     * Fungsi untuk MENGHENTIKAN pelacakan sepenuhnya (CLEAR WATCH)
     */
    function stopRealtimeTrackingHard() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;

        isFollowing = false;

        locationGroup.clearLayers();

        // Perbarui UI
        const locateBtn = document.getElementById(locateButtonId);
        const stopBtn = document.getElementById(stopButtonId);

        locateBtn.classList.remove("active-tracking");
        stopBtn.style.display = "none"; // Sembunyikan tombol STOP
      }
    }

    /**
     * Fungsi untuk MENGHIDUPKAN/MEMATIKAN mode mengikuti (isFollowing)
     */
    function toggleFollowing() {
      if (watchId === null) {
        startRealtimeTracking(); // Mulai tracking dan mengikuti
      } else {
        // Jika pelacakan sudah berjalan, hanya ubah status isFollowing
        if (isFollowing) {
          // Jika sedang mengikuti, nonaktifkan (tombol menjadi tidak biru)
          isFollowing = false;
          document.getElementById(locateButtonId).classList.remove("active-tracking");
        } else {
          // Jika pelacakan berjalan tapi tidak mengikuti, aktifkan kembali
          isFollowing = true;
          document.getElementById(locateButtonId).classList.add("active-tracking");
          // Paksa centering ke posisi terakhir yang diketahui
          if (locationGroup.getLayers().length > 0) {
            map.setView(locationGroup.getLayers()[0].getLatLng(), map.getZoom());
          }
        }
      }
    }

    // --- KONTROL KUSTOM LEAFLET ---

    const LocateControl = L.Control.extend({
      options: { position: "topright" },
      onAdd: function (map) {
        // Gunakan 'leaflet-bar' untuk wadah utama agar mendapatkan styling shadow Leaflet
        const container = L.DomUtil.create("div", "leaflet-bar leaflet-control-locate-group");

        // 1. Tombol Toggle Following
        const locateBtn = L.DomUtil.create("a", "leaflet-control-btn", container);
        locateBtn.id = locateButtonId;
        locateBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i>';
        locateBtn.href = "#"; // Gunakan <a> untuk mimic Leaflet Control
        locateBtn.title = "Mulai Pelacakan/Aktifkan Mengikuti Peta";

        // 2. Tombol STOP
        const stopBtn = L.DomUtil.create("a", "leaflet-control-btn", container);
        stopBtn.id = stopButtonId;
        stopBtn.innerHTML = '<i class="fas fa-times"></i>';
        stopBtn.href = "#"; // Gunakan <a> untuk mimic Leaflet Control
        stopBtn.title = "Hentikan Pelacakan Lokasi Sepenuhnya";

        // Pastikan tombol STOP disembunyikan saat inisialisasi
        stopBtn.style.display = "none";

        // Hubungkan Event
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(locateBtn, "click", L.DomEvent.stop); // Mencegah scrolling
        L.DomEvent.on(locateBtn, "click", toggleFollowing);

        L.DomEvent.on(stopBtn, "click", L.DomEvent.stop);
        L.DomEvent.on(stopBtn, "click", stopRealtimeTrackingHard);

        return container;
      },
      onRemove: function (map) {
        // Pastikan event dihapus
      },
    });

    // Tambahkan Kontrol ke Peta
    map.addControl(new LocateControl());

    // Fungsi untuk update attribution
    function updateAttribution(attributionText) {
      attributionControl._container.innerHTML = attributionText;
    }

    // Fungsi untuk memeriksa apakah tile gagal dimuat
    function checkTileError(e) {
      var coords = e.coords;

      // Cari layer aktif yang belum dicoba fallback
      var currentActiveIndex = tileLayers.findIndex((layer) => map.hasLayer(layer.layer) && layer.fallback === false);

      if (currentActiveIndex >= 0 && currentActiveIndex < tileLayers.length - 1) {
        // Tandai layer saat ini sudah dicoba
        tileLayers[currentActiveIndex].fallback = true;

        // Hapus layer yang gagal
        map.removeLayer(tileLayers[currentActiveIndex].layer);

        // Cari layer berikutnya yang sesuai dengan preferensi warna
        var nextLayer;
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          // Cari layer dark berikutnya
          for (let i = currentActiveIndex + 1; i < tileLayers.length; i++) {
            if (tileLayers[i].isDark) {
              nextLayer = tileLayers[i];
              break;
            }
          }
        } else {
          // Cari layer non-dark berikutnya
          for (let i = currentActiveIndex + 1; i < tileLayers.length; i++) {
            if (!tileLayers[i].isDark) {
              nextLayer = tileLayers[i];
              break;
            }
          }
        }

        // Jika tidak ada layer yang sesuai, gunakan layer terakhir
        if (!nextLayer) {
          nextLayer = tileLayers[tileLayers.length - 1];
        }

        // Tambahkan layer fallback berikutnya
        nextLayer.layer.addTo(map);

        // Update attribution
        updateAttribution(nextLayer.attribution);
      }
    }

    // Tambahkan event listener untuk error tile ke semua layer
    tileLayers.forEach((layer) => {
      layer.layer.on("tileerror", checkTileError);
    });

    let geminiAPIKey;

    fetch("https://script.google.com/macros/s/AKfycbzgylpg6HtLVER9aoA-idP0a2OCVACBI-NOIaxjOdlEXMaqR6gx71U70gAgmvcAFNf3/exec?mode=test-ping")
      .then((response) => response.text())
      .then((text) => {
        geminiAPIKey = text;
      })
      .catch((error) => {
        Swal.fire({
          title: "Error!",
          text: `Terjadi kesalahan saat test koneksi.`,
          icon: "error",
          confirmButtonText: "OK",
        });
      });

    // Fungsi untuk menentukan gaya marker lokasi penting
    function styleMarkerLokasiPenting(nama_singkatan_tempat, nama_lengkap_tempat, logo) {
      return L.divIcon({
        className: "leaflet-marker-hover-lokasi-penting",
        html: `
            <div class="w-[150px] flex flex-col items-center bg-white rounded-xl shadow-md border border-solid border-gray-200 p-2 overflow-hidden">
              <img src="${logo}" alt="STAN" class="h-16 mb-3" />
              <h2 class="text-lg font-semibold text-gray-800">${nama_singkatan_tempat}</h2>
              <p class="text-sm text-center text-gray-500">${nama_lengkap_tempat}</p>
            </div>`,
        iconAnchor: [80, 0],
      });
    }

    fetch("https://script.google.com/macros/s/AKfycbzIepwRrU8NJMnG0Uh-jIyrUManWerLCGWrI1j7s--DsuYE6u6l0yp8c9I84eHUBEXDLA/exec")
      .then((response) => response.text())
      .then((base64Data) => {
        try {
          // Mendekode data Base64 dengan dukungan UTF-8 untuk emoji
          const decodedData = decodeURIComponent(escape(atob(base64Data)));

          // Jika data asli Anda adalah JSON langsung setelah di-Base64,
          // maka Anda bisa langsung mem-parsing-nya.
          const markersLokasiPenting = JSON.parse(decodedData);

          // Menambahkan marker lokasi penting ke peta
          markersLokasiPenting["data_lokasi_penting"].forEach((markerLokasiPenting) => {
            L.marker([markerLokasiPenting.latitude, markerLokasiPenting.longitude], { icon: styleMarkerLokasiPenting(markerLokasiPenting.nama_singkatan_tempat, markerLokasiPenting.nama_lengkap_tempat, markerLokasiPenting.logo) }).addTo(map);
          });
        } catch (e) {
          Swal.fire({
            title: "Error!",
            text: `Terjadi Error: ${e}`,
            icon: "error",
            confirmButtonText: "OK",
          });
        }
      })
      .catch((error) => {
        Swal.fire({
          title: "Error!",
          text: `Terjadi kesalahan saat membaca file: ${error}`,
          icon: "error",
          confirmButtonText: "OK",
        });
      });

    // Fungsi untuk menentukan gaya marker lokasi properti
    function styleMarker(jenis_properti, ketersediaan, harga, deskripsi_spesifikasi_kontrakan, jumlah_peminat) {
      // ambil jumlah kamar tidur
      const regexKamarTidur = /(\d+)\s*kamar\s*tid[au]r/i;
      const hasilKamarTidur = deskripsi_spesifikasi_kontrakan.match(regexKamarTidur);

      if (ketersediaan == "Tersedia") {
        // Teks detail di bawah harga
        const detailText = hasilKamarTidur ? hasilKamarTidur[1] + " Kamar Tidur" : jenis_properti;

        // Lencana Peminat (Badge)
        const interestBadge =
          jumlah_peminat > 0
            ? `
            <div class="absolute top-[-15px] flex items-center bg-blue-500 dark:bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md z-10 transition duration-300 ease-in-out hover:bg-blue-600 dark:hover:bg-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                </svg>
                <span>${jumlah_peminat}</span>
            </div>
          `
            : "";

        return L.divIcon({
          className: "leaflet-marker-hover-lokasi-properti",
          html: `
            <div class="relative">
                <div class="flex items-center justify-center min-w-[120px] max-w-fit h-auto p-0 bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-xl transition duration-300 ease-in-out border-2 border-blue-500 dark:border-blue-400">
                    ${interestBadge}
                    <div class="flex flex-col text-center p-3">
                        <span class="font-extrabold text-[1.2rem] text-blue-600 dark:text-blue-400 tracking-wide leading-none">
                            ${harga}
                        </span>
                        <span class="text-gray-800 dark:text-gray-300 text-[0.8rem] font-medium mt-1">
                            ${detailText}
                        </span>
                    </div>
                </div>
            </div>
        `,
          iconAnchor: [48, 35],
        });
      }

      if (ketersediaan != "Tersedia") {
        // Teks detail di bawah harga
        const detailText = hasilKamarTidur ? hasilKamarTidur[1] + " Kamar Tidur" : jumlah_peminat + " peminat";

        // Lencana Peminat (Badge)
        const interestBadge =
          jumlah_peminat > 0
            ? `
            <div class="absolute top-[-15px] flex items-center bg-red-500 dark:bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md z-10 transition duration-300 ease-in-out hover:bg-red-600 dark:hover:bg-red-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                </svg>
                <span>${jumlah_peminat}</span>
            </div>
          `
            : "";

        return L.divIcon({
          className: "leaflet-marker-hover-lokasi-properti",
          html: `
            <div class="relative">
                <div class="flex items-center justify-center min-w-[120px] max-w-fit h-auto p-0 bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-xl transition duration-300 ease-in-out border-2 border-red-500 dark:border-red-400">
                    ${interestBadge}
                    <div class="flex flex-col text-center p-3">
                        <span class="font-extrabold text-[1.2rem] text-red-600 dark:text-red-400 tracking-wide leading-none">
                            ${harga}
                        </span>
                        <span class="text-gray-800 dark:text-gray-300 text-[0.8rem] font-medium mt-1">
                            ${detailText}
                        </span>
                    </div>
                </div>
            </div>
        `,
          iconAnchor: [48, 35],
        });
      }
    }

    var markersProperti;

    /**
     * Mengambil data Base64 dari URL Google Apps Script,
     * mendekode Base64 menjadi JSON string, dan menguraikannya menjadi objek JavaScript.
     */
    async function fetchAndProcessDataKontrakan() {
      await fetch("https://script.google.com/macros/s/AKfycbzgylpg6HtLVER9aoA-idP0a2OCVACBI-NOIaxjOdlEXMaqR6gx71U70gAgmvcAFNf3/exec")
        .then((response) => response.text())
        .then((base64Data) => {
          try {
            // Mendekode data Base64 dengan dukungan UTF-8 untuk emoji
            const decodedData = decodeURIComponent(escape(atob(base64Data)));

            // Jika data asli Anda adalah JSON langsung setelah di-Base64,
            // maka Anda bisa langsung mem-parsing-nya.
            markersProperti = JSON.parse(decodedData);

            const dataLoadingDiv = document.getElementById("data-loading-spinner");
            dataLoadingDiv.style.display = "none";

            const jumlahKontrakanTersedia = markersProperti["data_kontrakan"].filter((item) => {
              return item.ketersediaan.toLowerCase() == "tersedia";
            });

            const jumlahKontrakanTidakTersedia = markersProperti["data_kontrakan"].filter((item) => {
              return item.ketersediaan.toLowerCase() != "tersedia";
            });

            document.getElementById("info-ringkasan-ketersediaan").classList.remove("hidden");
            document.getElementById("select-urutan-data-ditampilkan").classList.remove("hidden");

            document.getElementById("text-jumlah-kontrakan-tersedia").innerHTML = jumlahKontrakanTersedia.length;
            document.getElementById("text-jumlah-kontrakan-tidak-tersedia").innerHTML = jumlahKontrakanTidakTersedia.length;

            DisplayNewMarkers();

            // Ambil semua nama kota ke dalam array
            allCities = markersProperti["data_kontrakan"].map((item) => item.kota);

            // Gunakan Set untuk mendapatkan nilai unik, lalu ubah kembali ke array
            uniqueCities = [...new Set(allCities)];

            // Ambil elemen select
            const citySelect = document.getElementById("filter-kota");
            // Loop untuk menambahkan opsi ke dalam select
            uniqueCities.forEach((city) => {
              const option = document.createElement("option");
              option.value = city.toLowerCase(); // Nilai option biasanya lowercase
              option.textContent = city.charAt(0).toUpperCase() + city.slice(1); // Teks tampilannya diatur menjadi "Malang", "Surabaya", dsb.
              citySelect.appendChild(option);
            });

            // Ambil semua nama kota ke dalam array
            allJenisProperti = markersProperti["data_kontrakan"].map((item) => item.jenis_properti);

            // Gunakan Set untuk mendapatkan nilai unik, lalu ubah kembali ke array
            uniqueJenisProperti = [...new Set(allJenisProperti)];

            // Ambil elemen select
            const jenisPropertiSelect = document.getElementById("jenis-properti");
            // Loop untuk menambahkan opsi ke dalam select
            uniqueJenisProperti.forEach((jenisProperti) => {
              const option = document.createElement("option");
              option.value = jenisProperti.toLowerCase(); // Nilai option biasanya lowercase
              option.textContent = jenisProperti.charAt(0).toUpperCase() + jenisProperti.slice(1); // Teks tampilannya diatur menjadi "Malang", "Surabaya", dsb.
              jenisPropertiSelect.appendChild(option);
            });

            // Ambil parameter dari URL
            const params = new URLSearchParams(window.location.search);
            const koderumah = params.get("koderumah"); // Ambil nilai dari koderumah

            if (koderumah) {
              const dataDitemukan = markersProperti.data_kontrakan.find((item) => item.nomer == koderumah);
              map.setView([dataDitemukan.latitude, dataDitemukan.longitude], 19);
              document.getElementById("map").classList.remove("hidden");
              document.getElementById("list-data-container").classList.add("hidden");
              document.getElementById("sidebar-menu-button-tampilkan-map").classList.add("hidden");
              document.getElementById("sidebar-menu-button-tampilkan-list-data").classList.remove("hidden");
              map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran
            }

            clearTimeout(t);

            seconds = 0;
            minutes = 0;
            hours = 0;
          } catch (e) {
            Swal.fire({
              title: "Error!",
              text: `Terjadi Error: ${e}`,
              icon: "error",
              confirmButtonText: "OK",
            });
          }
        })
        .catch((error) => {
          Swal.fire({
            title: "Error!",
            text: `Terjadi kesalahan saat membaca file: ${error}`,
            icon: "error",
            confirmButtonText: "OK",
          });
        });
    }

    function formatDate(dateString) {
      const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
      const date = new Date(dateString);
      return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    let displayedDataCount = 0; // A counter to track how many items have been displayed.
    const itemsPerLoad = 10; // The number of items to load at a time.
    let filteredProperties = []; // An array to store the filtered properties before rendering.

    async function DisplayNewMarkers(filterPermintaanUser, jenisProperti, jumlahKamarTidurMinimal, jumlahKamarTidurMaksimal, jumlahKamarMandiMinimal, jumlahKamarMandiMaksimal, minPrice, maxPrice, statusKetersediaan, filterJumlahPeminat) {
      // Clear the existing content and markers.
      document.getElementById("list-data-content-section").innerHTML = "";
      markers.clearLayers();

      // Reset the counters for a new search.
      displayedDataCount = 0;
      filteredProperties = [];

      // Filter the properties first and store them in the `filteredProperties` array.
      markersProperti["data_kontrakan"].forEach((markerData) => {
        // If a marker passes all filters, add it to the `filteredProperties` array.
        filteredProperties.push(markerData);

        // Also, create and add the marker to the map immediately.
        const marker = L.marker([markerData.latitude, markerData.longitude], { kode_properti: markerData.nomer, icon: styleMarker(markerData.jenis_properti, markerData.ketersediaan, markerData.label_harga_sewa, markerData.deskripsi_spesifikasi_kontrakan, markerData.jumlah_peminat) });

        // (The rest of your marker event handlers go here)
        createClickEventMarker(marker, markerData);

        marker._propertyData = markerData;
        markers.addLayer(marker);
      });

      map.addLayer(markers);

      document.getElementById("list-data-jumlah-data").innerHTML = filteredProperties.length;
      // Now, render the initial set of data.
      filteredProperties = await sortKontrakan("terbaru");
      renderMoreData();

      // Attach the scroll listener to handle loading more data.
      const listDataContent = document.getElementById("list-data-container");
      listDataContent.addEventListener("scroll", handleScroll);
    }

    function isKontrakanYgDicari(datadeskripsi, pesanUser) {
      const konsepMapping = {
        akses_jalan_utama: ["pinggir jalan", "tepi jalan", "jalan raya", "akses mobil", "jalan utama", "depan jalan", "aspal", "jalur angkot", "nol jalan", "0 jalan", "masuk mobil", "bisa mobil", "sampai truk", "papasan mobil"],
        fasilitas: {
          ac: ["ac", "air conditioner", "pendingin"],
          kasur: ["kasur", "bed", "springbed", "tempat tidur"],
          kulkas: ["kulkas", "lemari es", "chiller"],
          wifi: ["wifi", "internet", "indihome", "biznet"],
          lemari: ["lemari", "wardrobe", "bufet"],
          parkir: ["garasi", "carport", "parkir mobil", "tempat parkir", "halaman luas", "parkiran"],
        },
      };

      const clean = (str) => {
        return str
          .toLowerCase()
          .replace(/\b(kt|kmr tidur|kamar)\b/g, "kamar tidur")
          .replace(/\b(km|kmr mandi|mandi)\b/g, "kamar mandi")
          .replace(/furnis|furnish|furniture/g, "furnished")
          .trim();
      };

      const data = clean(datadeskripsi);
      const rawData = datadeskripsi.toLowerCase();
      const kriteriaUser = pesanUser.split(",").map((s) => s.trim());

      let totalKriteria = 0;
      let kriteriaTerpenuhi = 0;
      let bonusSkor = 0;

      const logs = [];
      const missingLogs = [];
      const bonusLogs = [];

      const hasNegation = (text, keyword, userMintaMobil = false) => {
        const basicNegation = new RegExp(`(?:tidak|tanpa|bukan|non|no|ga|gak|blm|belum)\\s*(?:bisa|ada|tersedia|masuk)?\\s*${keyword}`, "i");
        if (userMintaMobil) {
          const isMotorOnly = /\b(hanya motor|khusus motor|masuk motor|akses motor)\b/i.test(text);
          const containsMobil = /\b(mobil|carport|garasi|parkir mobil)\b/i.test(text);
          return basicNegation.test(text) || (isMotorOnly && !containsMobil);
        }
        return basicNegation.test(text);
      };

      const extractNum = (str, keyword) => {
        const regex = new RegExp(`(\\d+)\\s*${keyword}|${keyword}\\s*(\\d+)`);
        const match = str.match(regex);
        return match ? parseInt(match[1] || match[2]) : 0;
      };

      kriteriaUser.forEach((segmenAsli) => {
        if (!segmenAsli || segmenAsli.length < 2) return;
        const segmenClean = clean(segmenAsli);
        let teridentifikasi = false;

        // 1. Kamar (Wajib)
        const specs = [
          { key: "kamar tidur", label: "Kamar Tidur" },
          { key: "kamar mandi", label: "Kamar Mandi" },
        ];
        specs.forEach((s) => {
          const num = extractNum(segmenClean, s.key);
          if (num > 0) {
            teridentifikasi = true;
            totalKriteria++;
            const dataHave = extractNum(data, s.key);
            if (dataHave >= num) {
              kriteriaTerpenuhi++;
              logs.push(`${dataHave} ${s.label}`);
            } else {
              missingLogs.push(`${s.label} (Hanya ada ${dataHave})`);
            }
          }
        });

        // 2. Akses Jalan & Parkir
        const isMobilRequest = /\b(mobil|truk|roda 4|carport|garasi|parkir|parkiran)\b/i.test(segmenClean);
        const mintaJalan = konsepMapping.akses_jalan_utama.some((kw) => segmenClean.includes(kw));

        if ((mintaJalan || isMobilRequest) && !teridentifikasi) {
          teridentifikasi = true;
          totalKriteria++;
          const isMobilBisa = /\b(masuk mobil|bisa mobil|papasan mobil|akses mobil|jalan lebar|truk|jalan raya|parkir[:\s]+mobil|parkiran mobil)\b/.test(data);
          if (isMobilBisa && !hasNegation(rawData, "mobil", true)) {
            kriteriaTerpenuhi++;
            logs.push(isMobilRequest ? "Parkir/Akses Mobil" : "Akses Mobil");
          } else {
            missingLogs.push(isMobilRequest ? "Parkir/Akses Mobil" : "Akses Mobil");
          }
        }

        // 3. Fasilitas
        Object.keys(konsepMapping.fasilitas).forEach((f) => {
          if (konsepMapping.fasilitas[f].some((s) => segmenClean.includes(s)) && !teridentifikasi) {
            teridentifikasi = true;
            const isMandatory = /\b(harus|wajib|mesti|kudu)\b/i.test(segmenClean);
            const adaDiData = konsepMapping.fasilitas[f].some((s) => data.includes(s)) && !hasNegation(rawData, f, f === "parkir");

            if (isMandatory) {
              totalKriteria++;
              if (adaDiData) {
                kriteriaTerpenuhi++;
                logs.push(f.toUpperCase());
              } else {
                missingLogs.push(f.toUpperCase());
              }
            } else {
              if (adaDiData) {
                bonusSkor += 5; // Poin bonus per item
                bonusLogs.push(segmenAsli.trim());
              }
            }
          }
        });

        // 4. Logika Bonus Lainnya (kata kunci bebas)
        if (!teridentifikasi) {
          const cleanBonus = segmenAsli.replace(/\b(cari|info|dibutuhkan|secepatnya)\b/gi, "").trim();
          if (cleanBonus.length > 2) {
            if (data.includes(cleanBonus.toLowerCase()) && !hasNegation(rawData, cleanBonus)) {
              bonusSkor += 5;
              bonusLogs.push(cleanBonus);
            }
          }
        }
      });

      // --- PERBAIKAN LOGIKA SKORING ---
      const dasarSkor = totalKriteria > 0 ? (kriteriaTerpenuhi / totalKriteria) * 100 : 100;

      // Skor Akhir = Dasar + Bonus (Kita batasi atau biarkan melampaui 100 sebagai indikator "Best Match")
      const skorAkhir = Math.round(dasarSkor + bonusSkor);

      // Penentuan Status berdasarkan Skor Utama (Kelolosan tetap berdasarkan kriteria wajib)
      const statusIcon = dasarSkor === 100 ? "‚úÖ" : dasarSkor >= 60 ? "‚ö†Ô∏è" : "‚ùå";
      const statusText = dasarSkor === 100 ? (bonusSkor > 0 ? "SANGAT COCOK (EXTRA)" : "SANGAT COCOK") : dasarSkor >= 60 ? "CUKUP SESUAI" : "KURANG COCOK";

      let alasanRapi = `${statusIcon} **${statusText} (${skorAkhir}%)**\n`;
      alasanRapi += logs.length > 0 ? `\n‚úîÔ∏è **Ditemukan:**\n${logs.join(", ")}\n` : "";
      alasanRapi += missingLogs.length > 0 ? `\n‚ùå **Tidak Ada:**\n${missingLogs.join(", ")}\n` : "";
      alasanRapi += bonusLogs.length > 0 ? `\n‚ú® **Nilai Tambah:**\n${bonusLogs.join(", ")}\n` : "";

      return {
        lolos: dasarSkor >= 60,
        skor: skorAkhir,
        alasan: alasanRapi.trim(),
      };
    }

    async function filterAndDisplayMarkers(filterPermintaanUser, jenisProperti, jumlahKamarTidurMinimal, jumlahKamarTidurMaksimal, jumlahKamarMandiMinimal, jumlahKamarMandiMaksimal, minPrice, maxPrice, statusKetersediaan, filterJumlahPeminat) {
      // Clear the existing content and markers.
      document.getElementById("list-data-content-section").innerHTML = "";

      // Reset the counters for a new search.
      displayedDataCount = 0;
      filteredProperties = [];
      const filteredMarkers = [];

      // Filter the properties first and store them in the `filteredProperties` array.
      markers.getLayers().forEach((markerData) => {
        // Jika ada input filter dari user
        if (filterPermintaanUser) {
          const hasilFilter = isKontrakanYgDicari(markerData._propertyData.deskripsi_spesifikasi_kontrakan, filterPermintaanUser);

          if (!hasilFilter.lolos) {
            // Jika tidak lolos, sembunyikan marker (contoh: hapus dari map atau set opacity)
            return;
          }

          // JIKA LOLOS: Tambahkan alasan ke dalam properti marker
          // Ini nanti bisa Anda panggil saat menampilkan Popup atau Label
          markerData._propertyData.alasan_rekomendasi_filter = hasilFilter.alasan;
          markerData._propertyData.skor = hasilFilter.skor;
        }

        if (jenisProperti && jenisProperti.toLowerCase() != markerData._propertyData.jenis_properti.toLowerCase()) {
          return;
        }

        // cek jumlah kamar tidur
        if (jumlahKamarTidurMinimal && jumlahKamarTidurMaksimal) {
          const matchKamarTidur = markerData._propertyData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*tidur/i);
          const jumlahKamarTidur = matchKamarTidur ? parseInt(matchKamarTidur[1], 10) : null;
          const apakahJumlahKamarTidurSesuai = jumlahKamarTidur >= jumlahKamarTidurMinimal && jumlahKamarTidur <= jumlahKamarTidurMaksimal;
          if (!apakahJumlahKamarTidurSesuai || !matchKamarTidur) {
            return;
          }
        } else if (jumlahKamarTidurMinimal) {
          const matchKamarTidur = markerData._propertyData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*tidur/i);
          const jumlahKamarTidur = matchKamarTidur ? parseInt(matchKamarTidur[1], 10) : null;
          const apakahJumlahKamarTidurSesuai = jumlahKamarTidur >= jumlahKamarTidurMinimal;
          if (!apakahJumlahKamarTidurSesuai || !matchKamarTidur) {
            return;
          }
        } else if (jumlahKamarTidurMaksimal) {
          const matchKamarTidur = markerData._propertyData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*tidur/i);
          const jumlahKamarTidur = matchKamarTidur ? parseInt(matchKamarTidur[1], 10) : null;
          const apakahJumlahKamarTidurSesuai = jumlahKamarTidur <= jumlahKamarTidurMaksimal;
          if (!apakahJumlahKamarTidurSesuai || !matchKamarTidur) {
            return;
          }
        }

        // cek jumlah kamar mandi
        if (jumlahKamarMandiMinimal && jumlahKamarMandiMaksimal) {
          const matchKamarMandi = markerData._propertyData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*mandi/i);
          const jumlahKamarMandi = matchKamarMandi ? parseInt(matchKamarMandi[1], 10) : null;
          const apakahJumlahKamarMandiSesuai = jumlahKamarMandi >= jumlahKamarMandiMinimal && jumlahKamarMandi <= jumlahKamarMandiMaksimal;
          if (!apakahJumlahKamarMandiSesuai || !matchKamarMandi) {
            return;
          }
        } else if (jumlahKamarMandiMinimal) {
          const matchKamarMandi = markerData._propertyData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*mandi/i);
          const jumlahKamarMandi = matchKamarMandi ? parseInt(matchKamarMandi[1], 10) : null;
          const apakahJumlahKamarMandiSesuai = jumlahKamarMandi >= jumlahKamarMandiMinimal;
          if (!apakahJumlahKamarMandiSesuai || !matchKamarMandi) {
            return;
          }
        } else if (jumlahKamarMandiMaksimal) {
          const matchKamarMandi = markerData._propertyData.deskripsi_spesifikasi_kontrakan.match(/(\d+)\s*kamar\s*mandi/i);
          const jumlahKamarMandi = matchKamarMandi ? parseInt(matchKamarMandi[1], 10) : null;
          const apakahJumlahKamarMandiSesuai = jumlahKamarMandi <= jumlahKamarMandiMaksimal;
          if (!apakahJumlahKamarMandiSesuai || !matchKamarMandi) {
            return;
          }
        }

        if (minPrice && markerData._propertyData.harga_sewa < minPrice) {
          return;
        }

        if (maxPrice && markerData._propertyData.harga_sewa > maxPrice) {
          return;
        }

        if (statusKetersediaan == "available" && markerData._propertyData.ketersediaan != "Tersedia") {
          return;
        }

        if (statusKetersediaan == "unavailable" && markerData._propertyData.ketersediaan == "Tersedia") {
          return;
        }

        if (filterJumlahPeminat > markerData._propertyData.jumlah_peminat) {
          return;
        }

        // If a marker passes all filters, add it to the `filteredProperties` array.
        filteredProperties.push(markerData._propertyData);
        filteredMarkers.push(markerData);
        // (The rest of your marker event handlers go here)
        createClickEventMarker(markerData, markerData._propertyData);
      });

      markers.clearLayers();

      markers.addLayers(filteredMarkers);

      document.getElementById("list-data-jumlah-data").innerHTML = filteredProperties.length;
      // Now, render the initial set of data.
      if (filterPermintaanUser) {
        filteredProperties = await sortKontrakan("skor_tertinggi");
      } else {
        filteredProperties = await sortKontrakan("terbaru");
      }
      renderMoreData();

      // Attach the scroll listener to handle loading more data.
      const listDataContent = document.getElementById("list-data-container");
      listDataContent.addEventListener("scroll", handleScroll);
    }

    function sortKontrakan(sortBy) {
      return new Promise((resolve) => {
        // Buat salinan data agar data asli tidak berubah
        const sortedData = [...filteredProperties];

        sortedData.sort((a, b) => {
          // 1. PRIORITAS PERTAMA: Ketersediaan (Tersedia selalu di atas)
          const statusA = a.ketersediaan.toLowerCase();
          const statusB = b.ketersediaan.toLowerCase();

          if (statusA === "tersedia" && statusB !== "tersedia") return -1;
          if (statusA !== "tersedia" && statusB === "tersedia") return 1;

          // 2. PRIORITAS KEDUA: Berdasarkan sortBy
          switch (sortBy) {
            case "skor_tertinggi":
              // Mengurutkan dari skor terbesar ke terkecil
              // Pastikan properti 'skor' sudah ada (default 0 jika tidak ada)
              return (Number(b.skor) || 0) - (Number(a.skor) || 0);

            case "harga_termurah":
              return Number(a.harga_sewa) - Number(b.harga_sewa);

            case "harga_termahal":
              return Number(b.harga_sewa) - Number(a.harga_sewa);

            case "terbaru":
              return Number(b.nomer) - Number(a.nomer);

            case "terlama":
              return Number(a.nomer) - Number(b.nomer);

            case "banyak_dilihat":
              return Number(b.jumlah_peminat) - Number(a.jumlah_peminat);

            default:
              return 0;
          }
        });

        resolve(sortedData);
      });
    }

    // Dapatkan elemen select
    const sortSelect = document.getElementById("sort-data-by");

    // Tambahkan event listener untuk mendeteksi perubahan
    sortSelect.addEventListener("change", async (event) => {
      // Reset the counters for a new search.
      displayedDataCount = 0;

      // Hapus konten lama di halaman
      document.getElementById("list-data-content-section").innerHTML = "";

      const selectedValue = event.target.value;

      // Tunggu hingga proses sorting selesai
      filteredProperties = await sortKontrakan(selectedValue);

      // Setelah data diurutkan, panggil renderMoreData()
      renderMoreData();
    });

    // Fungsi khusus untuk menampilkan data berdasarkan array nomer.
    function displayMarkersByArrayObject(markerArrayObject) {
      if (markerArrayObject && Array.isArray(markerArrayObject) && markerArrayObject.length > 0) {
        // Clear the existing content and markers.
        document.getElementById("list-data-content-section").innerHTML = "";
        markers.clearLayers();

        // Reset the counters for a new search.
        displayedDataCount = 0;
        filteredProperties = [];

        markerArrayObject.forEach((markerData) => {
          // If a marker passes all filters, add it to the `filteredProperties` array.
          filteredProperties.push(markerData);

          // Also, create and add the marker to the map immediately.
          const marker = L.marker([markerData.latitude, markerData.longitude], { kode_properti: markerData.nomer, icon: styleMarker(markerData.jenis_properti, markerData.ketersediaan, markerData.label_harga_sewa, markerData.deskripsi_spesifikasi_kontrakan, markerData.jumlah_peminat) });

          // (The rest of your marker event handlers go here)
          createClickEventMarker(marker, markerData);

          marker._propertyData = markerData;
          markers.addLayer(marker);
        });
        map.addLayer(markers);

        document.getElementById("list-data-jumlah-data").innerHTML = filteredProperties.length;

        // Now, render the initial set of data.
        renderMoreData();

        // Attach the scroll listener to handle loading more data.
        const listDataContent = document.getElementById("list-data-container");
        listDataContent.addEventListener("scroll", handleScroll);
      }
    }

    function renderMoreData() {
      const listDataContent = document.getElementById("list-data-content-section");
      const endIndex = Math.min(displayedDataCount + itemsPerLoad, filteredProperties.length);

      // Loop through the next `itemsPerLoad` properties.
      for (let i = displayedDataCount; i < endIndex; i++) {
        const markerData = filteredProperties[i];
        const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;

        // Append the HTML for the current property.
        listDataContent.innerHTML += `
          <div class="flex w-full flex-col justify-between rounded-lg bg-white p-4 shadow-md dark:bg-gray-700">
            <div class="cursor-pointer">
              <div class="w-full overflow-hidden rounded-l-lg md:h-auto">
                <img data-src="asset/photos/${markerData.foto_kontrakan}" id="${imageId}" alt="Foto tidak bisa ditampilkan" class="w-full h-auto min-h-48 rounded-md bg-gray-100 dark:bg-gray-600 dark:text-gray-200 text-xs object-cover text-center ${markerData.ketersediaan.toLowerCase() != "tersedia" ? "opacity-30" : ""}" onclick="window.open('${markerData.google_drive_foto_kontrakan}', '_blank')" />
              </div>
              <div class="mt-4 mb-2 ${markerData.alasan_rekomendasi == null ? "hidden" : ""}">
                <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-600">
                  <div class="mb-3 flex items-start gap-3">
                    <svg class="w-5 fill-blue-500 dark:fill-blue-300" fill-rule="evenodd" style="flex: none; line-height: 1" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
                      <title>Gemini</title>
                      <path d="M20.616 10.835a14.147 14.147 0 01-4.45-3.001 14.111 14.111 0 01-3.678-6.452.503.503 0 00-.975 0 14.134 14.134 0 01-3.679 6.452 14.155 14.155 0 01-4.45 3.001c-.65.28-1.318.505-2.002.678a.502.502 0 000 .975c.684.172 1.35.397 2.002.677a14.147 14.147 0 014.45 3.001 14.112 14.112 0 013.679 6.453.502.502 0 00.975 0c.172-.685.397-1.351.677-2.003a14.145 14.145 0 013.001-4.45 14.113 14.113 0 016.453-3.678.503.503 0 000-.975 13.245 13.245 0 01-2.003-.678z"></path>
                    </svg>
                    <div>
                        <p class="text-sm text-gray-700 dark:text-gray-200">Dihasilkan oleh Asisten AI, Maya.</p>
                    </div>
                  </div>
                  <div id="result-display" class="text-justify leading-relaxed text-blue-800 dark:text-blue-200">${markerData.alasan_rekomendasi == null ? "" : marked.parse(markerData.alasan_rekomendasi)}</div>
                </div>
              </div>
              <div class="mt-4 mb-2 ${markerData.alasan_rekomendasi_filter == null ? "hidden" : ""}">
                <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-600">
                  <div class="flex items-start gap-3">
                    <div>
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-200">Alasan Rekomendasi</p>
                    </div>
                  </div>
                  <div id="result-display" class="text-justify leading-relaxed text-blue-800 dark:text-blue-200">${markerData.alasan_rekomendasi_filter == null ? "" : marked.parse(markerData.alasan_rekomendasi_filter)}</div>
                </div>
              </div>
              <div class="text-md flex w-full flex-col justify-between">
                <div>
                  <div class="my-4 grid grid-cols-2 gap-4">
                    <div class="overflow-x-scroll rounded-lg bg-gray-200 p-3 dark:bg-gray-600">
                      <p class="text-sm text-gray-500 dark:text-gray-200">Harga</p>
                      <p class="text-lg font-bold text-gray-800 dark:text-gray-200">${formatRupiahText(markerData.harga_sewa)}</p>
                    </div>
                    <div class="overflow-x-scroll rounded-lg bg-gray-200 p-3 dark:bg-gray-600">
                      <p class="text-sm text-gray-500 dark:text-gray-200">Ketersediaan</p>
                      <p class="text-lg font-bold ${markerData.ketersediaan.toLowerCase() == "tersedia" ? "text-blue-600 dark:text-blue-400" : "text-red-600 dark:text-red-400"} ">${markerData.ketersediaan.toLowerCase() == "tersedia" ? "Tersedia" : "Tidak Tersedia"}</p>
                    </div>
                    <div class="overflow-x-scroll rounded-lg bg-gray-200 p-3 dark:bg-gray-600">
                      <p class="text-sm text-gray-500 dark:text-gray-200">Jumlah Peminat</p>
                      <p class="text-lg font-bold text-gray-600 dark:text-gray-200">${markerData.jumlah_peminat} peminat</p>
                    </div>
                    <div id="info_nomer_data" class="cursor-pointer overflow-x-scroll rounded-lg bg-gray-200 p-3 dark:bg-gray-600" ondblclick="window.open('https://docs.google.com/spreadsheets/d/10T-cbh9g9Al3G-1fNc0h6cro4ZwhTY6QqLQeXltHF2I/edit?gid=0#gid=0&range=${markerData.nomer}:${markerData.nomer}', '_blank')">
                      <p class="text-sm text-gray-500 dark:text-gray-200">Nomer Data</p>
                      <p class="text-lg font-bold text-gray-600 dark:text-gray-200">No. ${markerData.nomer}</p>
                    </div>
                  </div>
                  <div class="mt-4">
                    <div class="rounded-lg bg-gray-200 p-3 dark:bg-gray-600">
                      <div id="text-info-kontrakan-swal" class="text-md [&amp;::-webkit-scrollbar]:hidden max-h-64 overflow-scroll text-gray-600 [-ms-overflow-style:none] [scrollbar-width:none] dark:text-gray-200">
                        ${marked.parse(
                          markerData.deskripsi_spesifikasi_kontrakan
                            .replace(/((https?:\/\/|www\.)?[^\s]+\.[a-z]{2,6}[^\s]*)/gi, (match) => {
                              let url = match;
                              // Add https://www. if the URL doesn't have http:// or https://
                              if (!/^https?:\/\//i.test(url)) {
                                if (url.startsWith("www.")) {
                                  url = "https://" + url;
                                } else {
                                  url = "https://www." + url.replace(/^www\./, "");
                                }
                              }

                              if (url.startsWith("https://www.wa.me") || url.startsWith("https://www.t.me")) {
                                return `<a href="${url}%20-%20[${markerData.nomer}]" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}%20-%20[${markerData.nomer}]</a>`;
                              }
                              return `<a href="${url}" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}</a>`;
                            })
                            .replace(/^(?!\|)([^\n]+)\n(?!(\||-))/gm, "$1  \n"),
                        )}
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-col gap-2 pt-4 pb-2">
                    <button nomer-data="${markerData.nomer}" data-action="tampilkan-map" class="tampilkan-map-button w-full cursor-pointer flex items-center justify-center gap-2 py-2 text-md font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800 transition-colors">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12.0036 14.0035C14.4889 14.0035 16.5036 11.9887 16.5036 9.50347C16.5036 7.01819 14.4889 5.00347 12.0036 5.00347C9.51831 5.00347 7.50359 7.01819 7.50359 9.50347C7.50359 11.9887 9.51831 14.0035 12.0036 14.0035ZM12.0036 12.0071C10.6209 12.0071 9.5 10.8862 9.5 9.50347C9.5 8.12077 10.6209 6.99988 12.0036 6.99988C13.3863 6.99988 14.5072 8.12077 14.5072 9.50347C14.5072 10.8862 13.3863 12.0071 12.0036 12.0071Z" />
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M21.272 11.5818C22.5649 5.78816 18.0052 0.00354004 12 0.00354004C5.99649 0.00354004 1.43639 5.7961 2.72816 11.5825C3.72523 16.2821 7.7572 20.8465 10.1636 23.2269C11.1942 24.2463 12.8058 24.2463 13.8364 23.2269C16.2429 20.8464 20.2752 16.2816 21.272 11.5818ZM12 2.00354C16.7124 2.00354 20.3368 6.58981 19.32 11.1462C18.8316 13.3355 17.7359 15.3015 16.4501 17.119C15.1064 19.0184 13.5829 20.6644 12.4299 21.805C12.1786 22.0536 11.8214 22.0536 11.5701 21.805C10.4171 20.6645 8.89379 19.0186 7.55009 17.1193C6.26419 15.3017 5.16886 13.3361 4.68011 11.1467C3.66438 6.59682 7.29012 2.00354 12 2.00354Z" />
                      </svg>
                      <span>Tampilkan di Map</span>
                    </button>

                    <div class="flex gap-2">
                      <button nomer-data="${markerData.nomer}" data-action="bagikan" class="copy-kode-button flex-1 cursor-pointer flex items-center justify-center gap-2 py-2 text-md font-medium text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 active:bg-blue-100 dark:text-blue-300 dark:border-blue-300 dark:hover:bg-gray-800 transition-colors">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.03-.47-.09-.7l7.06-4.11A2.99 2.99 0 0 0 18 7.92c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L7.96 9.81A2.99 2.99 0 0 0 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.66 0 1.27-.22 1.77-.59l7.12 4.14c-.06.24-.09.47-.09.72 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path>
                        </svg>
                        <span>Bagikan</span>
                      </button>

                      <button nomer-data="${markerData.nomer}" data-action="buka-gmaps" class="open-gmaps-button flex-1 cursor-pointer flex items-center justify-center gap-2 py-2 text-md font-medium text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 active:bg-blue-100 dark:text-blue-300 dark:border-blue-300 dark:hover:bg-gray-800 transition-colors">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M6 12C6 15.3137 8.68629 18 12 18C14.6124 18 16.8349 16.3304 17.6586 14H12V10H21.8047V14H21.8C20.8734 18.5645 16.8379 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C15.445 2 18.4831 3.742 20.2815 6.39318L17.0039 8.68815C15.9296 7.06812 14.0895 6 12 6C8.68629 6 6 8.68629 6 12Z" />
                        </svg>
                        <span>Maps</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
      }

      // Update the counter.
      displayedDataCount = endIndex;

      // Re-run the lazy load observer for the newly added images.
      const listDataContentImages = listDataContent.querySelectorAll("img[data-src]");
      const listDataContentObserver = new IntersectionObserver((entries, obs) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const listDataContentImg = entry.target;
            listDataContentImg.src = listDataContentImg.dataset.src;
            listDataContentImg.removeAttribute("data-src");
            obs.unobserve(listDataContentImg);
          }
        });
      });
      listDataContentImages.forEach((listDataContentImg) => listDataContentObserver.observe(listDataContentImg));
    }

    // Dapatkan elemen induk (kontainer) dari semua div
    const containerListData = document.querySelector(".container-list-data");

    // Tambahkan event listener tunggal pada elemen induk
    containerListData.addEventListener("click", (event) => {
      const button = event.target.closest("button[data-action]");

      if (!button) return; // Bukan tombol yang kita cari, keluar

      const action = button.getAttribute("data-action");
      const nomerData = button.getAttribute("nomer-data");

      // Cari data kartu berdasarkan nomer-data
      const dataDitemukan = markersProperti.data_kontrakan.find((item) => item.nomer == nomerData);
      if (!dataDitemukan) {
        Swal.fire({
          title: "Error!",
          text: `Data dengan nomer ${nomerData} tidak ditemukan.`,
          icon: "error",
          confirmButtonText: "OK",
        });
        return;
      }

      // Cek apakah elemen yang diklik adalah tombol yang kita inginkan
      if (action === "bagikan") {
        const url = new URL(window.location.href);

        url.searchParams.set("koderumah", nomerData); // Bisa diganti sesuai data rumah

        // Buat elemen textarea untuk menyalin teks
        const textarea = document.createElement("textarea");
        textarea.value = url.toString();
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        // Beri umpan balik ke pengguna
        button.innerHTML = "Berhasil disalin!";

        // Kembalikan teks tombol setelah 2 detik
        setTimeout(() => {
          button.innerHTML = "Bagikan";
        }, 2000);
      }

      if (action === "buka-gmaps") {
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${dataDitemukan.latitude},${dataDitemukan.longitude}`;

        // 5. Buka URL di tab baru
        window.open(mapsUrl, "_blank");
      }

      if (action === "tampilkan-map") {
        map.setView([dataDitemukan.latitude, dataDitemukan.longitude], 19);
        document.getElementById("map").classList.remove("hidden");
        document.getElementById("list-data-container").classList.add("hidden");
        document.getElementById("sidebar-menu-button-tampilkan-map").classList.add("hidden");
        document.getElementById("sidebar-menu-button-tampilkan-list-data").classList.remove("hidden");
        map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran
      }
    });

    const resetButtonElements = document.querySelectorAll(".reset-data-filter-button");

    resetButtonElements.forEach((button) => {
      button.addEventListener("click", (event) => {
        // Ambil target filter dari atribut data-target
        const target = event.currentTarget.dataset.target;

        if (target === "reset-permintaan-user") {
          // Reset Kamar Tidur ke nilai default (1 dan 10)
          document.getElementById("filter_permintaan_user").value = "";
        } else if (target === "reset-kamar-tidur") {
          // Reset Kamar Tidur ke nilai default (1 dan 10)
          document.getElementById("filter_jumlah_kamar_tidur_minimal").value = "";
          document.getElementById("filter_jumlah_kamar_tidur_maksimal").value = "";
        } else if (target === "reset-kamar-mandi") {
          // Reset Kamar Mandi ke nilai default (1 dan 2)
          document.getElementById("filter_jumlah_kamar_mandi_minimal").value = "";
          document.getElementById("filter_jumlah_kamar_mandi_maksimal").value = "";
        } else if (target === "reset-input-harga") {
          // Reset Harga dengan mengosongkan input
          document.getElementById("filter_harga_min_properti").value = "";
          document.getElementById("filter_harga_max_properti").value = "";
        }
      });
    });

    function handleScroll() {
      const listDataContent = document.getElementById("list-data-container");

      // Check if the user has scrolled to the bottom.
      if (listDataContent.scrollTop + listDataContent.clientHeight >= listDataContent.scrollHeight) {
        // If there are more items to display, load them.
        if (displayedDataCount < filteredProperties.length) {
          renderMoreData();
        }
      }
    }

    function createClickEventMarker(marker, markerData) {
      marker.on("click", function () {
        Swal.fire({
          title: "Detail Kontrakan",
          html: `
              <div class="bg-white overflow-x-scroll min-w-[400px] w-full text-left dark:bg-gray-900">
                <div class="w-full overflow-hidden rounded-l-lg py-2 md:h-auto">
                  <img id="foto_rumah_on_popup" alt="Foto tidak bisa ditampilkan" class="w-full h-auto min-h-48 rounded-md bg-gray-100 dark:bg-gray-800 dark:text-gray-200 text-xs object-cover text-center cursor-pointer" />
                </div>
                <div class="mt-4 mb-2 ${markerData.alasan_rekomendasi == null ? "hidden" : ""}">
                  <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-600">
                    <div class="mb-2 flex items-center gap-1 text-gray-700 dark:text-gray-200">
                      <svg class="w-5 fill-blue-500 dark:fill-gray-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12ZM12 17.75C12.4142 17.75 12.75 17.4142 12.75 17V11C12.75 10.5858 12.4142 10.25 12 10.25C11.5858 10.25 11.25 10.5858 11.25 11V17C11.25 17.4142 11.5858 17.75 12 17.75ZM12 7C12.5523 7 13 7.44772 13 8C13 8.55228 12.5523 9 12 9C11.4477 9 11 8.55228 11 8C11 7.44772 11.4477 7 12 7Z"></path>
                      </svg>
                      <div>
                        <span class="font-semibold">Catatan:</span>
                        Informasi ini dihasilkan oleh model AI.
                      </div>
                    </div>
                    <div id="result-display" class="text-justify leading-relaxed text-blue-800 dark:text-blue-200">${markerData.alasan_rekomendasi == null ? "" : marked.parse(markerData.alasan_rekomendasi)}</div>
                  </div>
                </div>
                <div class="mt-4 mb-2 ${markerData.alasan_rekomendasi_filter == null ? "hidden" : ""}">
                  <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-800">
                    <div class="flex items-start gap-3">
                      <div>
                          <p class="text-sm font-semibold text-gray-700 dark:text-gray-200">Alasan Rekomendasi</p>
                      </div>
                    </div>
                    <div id="result-display" class="text-justify leading-relaxed text-blue-800 dark:text-blue-200">${markerData.alasan_rekomendasi_filter == null ? "" : marked.parse(markerData.alasan_rekomendasi_filter)}</div>
                  </div>
                </div>
                <div class="text-md flex w-full flex-col justify-between">
                  <div>
                    <div class="grid grid-cols-2 gap-4 my-4">
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-800">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Harga</p>
                          <p class="font-bold text-gray-800 dark:text-gray-200">${formatRupiahText(markerData.harga_sewa)}</p>
                      </div>
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-800">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Ketersediaan</p>
                          <p class="font-semibold ${markerData.ketersediaan.toLowerCase() == "tersedia" ? "text-blue-600 dark:text-blue-400" : "text-red-600 dark:text-red-400"}">${markerData.ketersediaan.toLowerCase() == "tersedia" ? "Tersedia" : "Disewa"}</p>
                      </div>
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-800">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Jumlah Peminat</p>
                          <p class="font-semibold text-gray-600 dark:text-gray-200">${markerData.jumlah_peminat} peminat</p>
                      </div>
                      <div id="info_nomer_data_on_popup" class="bg-gray-100 p-3 rounded-lg cursor-pointer dark:bg-gray-800">
                          <p class="text-gray-500 text-sm dark:text-gray-200">Nomer Data</p>
                          <p class="font-semibold text-gray-600 dark:text-gray-200">No. ${markerData.nomer}</p>
                      </div>
                    </div>

                    <div class="mt-4">
                      <div class="bg-gray-100 p-3 rounded-lg dark:bg-gray-800">
                        <div id="text-info-kontrakan-swal" class="text-gray-600 text-md max-h-64 overflow-x-clip overflow-y-scroll [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden dark:text-gray-200">
                          ${marked.parse(
                            markerData.deskripsi_spesifikasi_kontrakan
                              .replace(/((https?:\/\/|www\.)?[^\s]+\.[a-z]{2,6}[^\s]*)/gi, (match) => {
                                let url = match;
                                // Add https://www. if the URL doesn't have http:// or https://
                                if (!/^https?:\/\//i.test(url)) {
                                  if (url.startsWith("www.")) {
                                    url = "https://" + url;
                                  } else {
                                    url = "https://www." + url.replace(/^www\./, "");
                                  }
                                }

                                if (url.startsWith("https://www.wa.me") || url.startsWith("https://www.t.me")) {
                                  return `<a href="${url}%20-%20[${markerData.nomer}]" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}%20-%20[${markerData.nomer}]</a>`;
                                }
                                return `<a href="${url}" target="_blank" class="text-blue-700 underline dark:text-blue-400">${match}</a>`;
                              })
                              .replace(/^(?!\|)([^\n]+)\n(?!(\||-))/gm, "$1  \n"),
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-2 pt-4">
                  <button id="copyKodeRumah" class="flex-1 cursor-pointer flex items-center justify-center gap-2 py-2 px-3 text-md font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring focus:ring-blue-300 transition-colors dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800">
                    <svg class="w-4 h-4 shrink-0" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.03-.47-.09-.7l7.06-4.11A2.99 2.99 0 0 0 18 7.92c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L7.96 9.81A2.99 2.99 0 0 0 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.66 0 1.27-.22 1.77-.59l7.12 4.14c-.06.24-.09.47-.09.72 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path>
                    </svg>
                    <span id="copyKodeRumahTeks" class="truncate">Bagikan</span>
                  </button>

                  <button id="bukaGoogleMaps" class="flex-1 cursor-pointer flex items-center justify-center gap-2 py-2 px-3 text-md font-medium text-blue-600 bg-blue-50 border border-blue-600 rounded-lg hover:bg-blue-100 active:bg-blue-200 focus:outline-none focus:ring focus:ring-blue-300 transition-colors dark:bg-transparent dark:text-blue-400 dark:border-blue-400 dark:hover:bg-blue-900/20">
                    <svg class="w-4 h-4 shrink-0" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M6 12C6 15.3137 8.68629 18 12 18C14.6124 18 16.8349 16.3304 17.6586 14H12V10H21.8047V14H21.8C20.8734 18.5645 16.8379 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C15.445 2 18.4831 3.742 20.2815 6.39318L17.0039 8.68815C15.9296 7.06812 14.0895 6 12 6C8.68629 6 6 8.68629 6 12Z" />
                    </svg>
                    <span id="bukaGoogleMapsTeks" class="truncate">Maps</span>
                  </button>
                </div>
              </div>
                        `,
          width: "50em",
          background: document.documentElement.classList.contains("dark") ? "#101828" : "", // bg-gray-800
          color: document.documentElement.classList.contains("dark") ? "#f3f4f6" : "", // text-gray-200
          showCloseButton: true,
          showConfirmButton: false,
          customClass: {
            closeButton: "focus:shadow-none",
          },
          buttonsStyling: false,
          didOpen: () => {
            // Set gambar setelah swal terbuka
            const fotoRumah = document.getElementById("foto_rumah_on_popup");
            const infoNomerData = document.getElementById("info_nomer_data_on_popup");
            const cariRumahSepertiIniButton = document.getElementById("cariRumahSepertiIni");
            const shareButton = document.getElementById("copyKodeRumah");
            const shareButtonTeks = document.getElementById("copyKodeRumahTeks");
            const openGoogleMapsButton = document.getElementById("bukaGoogleMaps");

            fotoRumah.src = `asset/photos/${markerData.foto_kontrakan}`;

            fotoRumah.addEventListener("click", function () {
              // Mendapatkan URL dari atribut 'data-url' pada elemen gambar
              const urlTujuan = markerData.google_drive_foto_kontrakan;

              // Memastikan URL tersedia
              if (urlTujuan) {
                // Membuka URL di tab/jendela baru
                // '_blank' adalah parameter yang menentukan tab baru
                window.open(urlTujuan, "_blank");
              } else {
                Swal.fire({
                  title: "Error!",
                  text: `URL tujuan tidak ditemukan pada atribut data-url.`,
                  icon: "error",
                  confirmButtonText: "OK",
                });
              }
            });

            infoNomerData.addEventListener("dblclick", () => {
              // Ganti URL ini dengan URL Google Spreadsheet Anda yang sebenarnya
              const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/10T-cbh9g9Al3G-1fNc0h6cro4ZwhTY6QqLQeXltHF2I/edit?gid=0#gid=0&range=${markerData.nomer}:${markerData.nomer}`;

              // Membuka URL di tab baru
              window.open(spreadsheetUrl, "_blank");
            });

            openGoogleMapsButton.addEventListener("click", () => {
              const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${markerData.latitude},${markerData.longitude}`;

              window.open(mapsUrl, "_blank");
            });

            shareButton.addEventListener("click", () => {
              const url = new URL(window.location.href);
              url.searchParams.set("koderumah", markerData.nomer); // Bisa diganti sesuai data rumah

              // Buat elemen textarea untuk menyalin teks
              const textarea = document.createElement("textarea");
              textarea.value = url.toString();
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand("copy");
              document.body.removeChild(textarea);

              // Beri umpan balik ke pengguna
              shareButtonTeks.innerHTML = "Berhasil disalin!";

              // Kembalikan teks tombol setelah 2 detik
              setTimeout(() => {
                shareButtonTeks.innerHTML = "Bagikan";
              }, 2000);
            });

            history.pushState({ popup: true }, "");
            popupOpen = true;
          },
          willClose: () => {
            popupOpen = false;
            // Kembalikan ke state sebelumnya agar tidak stuck di riwayat
            if (history.state && history.state.popup) {
              history.back();
            }
          },
        });
      });

      marker.on("mouseover", function () {
        this.setZIndexOffset(1000);
      });

      marker.on("mouseout", function () {
        this.setZIndexOffset(0);
      });
    }

    const userTextArea = document.getElementById("user-chat-textarea");
    userTextArea.addEventListener("input", () => {
      autoExpandTextarea(userTextArea);
    });

    function autoExpandTextarea(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";

      // Limit max height
      const maxHeight = parseInt(textarea.style.maxHeight);
      if (textarea.scrollHeight > maxHeight) {
        textarea.style.overflowY = "auto";
      } else {
        textarea.style.overflowY = "hidden";
      }
    }

    function formatRupiah(input) {
      let value = input.value.replace(/[^0-9]/g, "");
      if (value) {
        input.value = "Rp" + parseInt(value, 10).toLocaleString("id-ID");
      } else {
        input.value = "";
      }
    }

    function formatRupiahText(input) {
      let value = String(input).replace(/[^0-9]/g, "");
      if (value) {
        return "Rp" + parseInt(value, 10).toLocaleString("id-ID");
      } else {
        return "";
      }
    }

    function parseRupiah(value) {
      return parseInt(value.replace(/[^0-9]/g, ""), 10) || 0;
    }

    // Tangani tombol back
    window.addEventListener("popstate", function (event) {
      if (popupOpen) {
        Swal.close();
      }
    });

    // Fungsi untuk toggle sidebar (semua konten bisa toggle)
    function toggleSidebar(activeContentId) {
      const contents = ["sidebar-content-about-us", "sidebar-content-permintaan-kontrakan", "sidebar-content-filter-data", "sidebar-content-asisten-AI"];
      const isDesktop = window.matchMedia("(min-width: 768px)").matches;
      const activeContent = document.getElementById(activeContentId);

      // Toggle konten yang aktif
      activeContent.classList.toggle("hidden");

      // Sembunyikan semua konten lainnya
      contents.forEach((id) => {
        if (id !== activeContentId) {
          document.getElementById(id).classList.add("hidden");
        }
      });
    }

    // --- Fungsionalitas Menutup Sidebar dengan Tombol ESC ---

    function hideAllSidebars() {
      const contents = ["sidebar-content-about-us", "sidebar-content-permintaan-kontrakan", "sidebar-content-filter-data", "sidebar-content-asisten-AI"];

      // Iterasi melalui semua ID konten sidebar dan tambahkan kelas 'hidden'
      contents.forEach((id) => {
        const sidebar = document.getElementById(id);
        if (sidebar && !sidebar.classList.contains("hidden")) {
          sidebar.classList.add("hidden");
        }
      });
    }

    // Tambahkan event listener ke dokumen
    document.addEventListener("keydown", (event) => {
      // Periksa apakah tombol yang ditekan adalah 'Escape'
      if (event.key === "Escape") {
        hideAllSidebars();
      }
    });

    // Kumpulan fungsi draw map
    // Kumpulan fungsi draw map

    function createAnalysisWave(latlng) {
      const point = map.latLngToContainerPoint(latlng);

      const wave = document.createElement("div");
      wave.className = "analysis-wave";
      wave.style.left = `${point.x}px`;
      wave.style.top = `${point.y}px`;

      document.getElementById("map").appendChild(wave);

      wave.addEventListener("animationend", () => {
        wave.remove();
      });
    }

    function createAnalysisWaveReverse(latlng) {
      const point = map.latLngToContainerPoint(latlng);

      const wave = document.createElement("div");
      wave.className = "analysis-wave-reverse";
      wave.style.left = `${point.x}px`;
      wave.style.top = `${point.y}px`;

      document.getElementById("map").appendChild(wave);

      wave.addEventListener("animationend", () => {
        wave.remove();
      });
    }

    function isMarkerInsidePolygon(markerLatLng, polygonLatLngs) {
      let x = markerLatLng.lng,
        y = markerLatLng.lat;
      let inside = false;
      let coords = polygonLatLngs[0] && Array.isArray(polygonLatLngs[0]) ? polygonLatLngs[0] : polygonLatLngs;

      for (let i = 0, j = coords.length - 1; i < coords.length; j = i++) {
        let xi = coords[i].lng,
          yi = coords[i].lat;
        let xj = coords[j].lng,
          yj = coords[j].lat;
        let intersect = yi > y != yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function updateButtonState() {
      // üìå PERUBAHAN: Perbarui tampilan ikon tombol toggle gambar
      if (isDrawingModeToggle) {
        document.getElementById("sidebar-menu-button-pilih-wilayah").classList.add("hidden");
        document.getElementById("sidebar-menu-button-mode-cursor").classList.remove("hidden");
      } else {
        document.getElementById("sidebar-menu-button-pilih-wilayah").classList.remove("hidden");
        document.getElementById("sidebar-menu-button-mode-cursor").classList.add("hidden");
      }
      hideAllSidebars();
    }

    // --- Drawing Logic (Native DOM Events) ---

    function getNativeEventCoordinates(e) {
      const point = e.touches && e.touches.length > 0 ? { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY } : e;
      const rect = document.getElementById("map").getBoundingClientRect();
      const containerX = point.clientX - rect.left;
      const containerY = point.clientY - rect.top;
      // Pastikan hanya sentuhan pertama yang digunakan jika ada lebih dari satu sentuhan.
      return map.containerPointToLatLng(L.point(containerX, containerY));
    }

    function handleNativeDrawStart(e) {
      // Abaikan jika lebih dari 1 jari (pinch-to-zoom)
      if (e.touches && e.touches.length > 1) return;

      if (!isDrawingModeToggle || isDrawing || (e.type === "mousedown" && e.button !== 0)) {
        return;
      }

      // Panggil preventDefault() untuk touchstart agar Leaflet drag peta dinonaktifkan
      if (e.type === "touchstart") {
        e.preventDefault();
      }
      e.stopPropagation();

      isDrawing = true;

      const latlng = getNativeEventCoordinates(e);
      drawnLatLngs = [latlng];

      // Gunakan `document` untuk event `mouseup`/`touchend`
      document.getElementById("map").addEventListener("mousemove", handleNativeDrawMove);
      document.getElementById("map").addEventListener("mouseup", handleNativeDrawEnd);
      document.getElementById("map").addEventListener("touchmove", handleNativeDrawMove, { passive: false });
      document.getElementById("map").addEventListener("touchend", handleNativeDrawEnd);

      if (currentDrawnLayer) map.removeLayer(currentDrawnLayer);
      currentDrawnLayer = L.polyline(drawnLatLngs, {
        color: "#FF5733",
        dashArray: "5, 5",
      }).addTo(map);
    }

    function handleNativeDrawMove(e) {
      if (!isDrawing) return;

      e.stopPropagation();

      const latlng = getNativeEventCoordinates(e);
      if (drawnLatLngs.length === 0 || map.distance(latlng, drawnLatLngs[drawnLatLngs.length - 1]) > 5) {
        drawnLatLngs.push(latlng);
        currentDrawnLayer.setLatLngs(drawnLatLngs);
      }
    }

    function handleNativeDrawEnd(e) {
      if (!isDrawing) return;

      // Hapus listener dari `document`
      document.getElementById("map").removeEventListener("mousemove", handleNativeDrawMove);
      document.getElementById("map").removeEventListener("mouseup", handleNativeDrawEnd);
      document.getElementById("map").removeEventListener("touchmove", handleNativeDrawMove);
      document.getElementById("map").removeEventListener("touchend", handleNativeDrawEnd);

      isDrawing = false;

      if (currentDrawnLayer) {
        map.removeLayer(currentDrawnLayer);
      }

      if (drawnLatLngs.length > 2) {
        const customPopupContent = `
          <div class="p-4 shadow-xl rounded-lg bg-white dark:bg-gray-800">
              <div class="text-sm font-semibold text-gray-800 mb-2 dark:text-white">
                  <span>Batas seleksi wilayah No. ${allDrawnPolygons.length + 1}</span>
              </div>
      
              ${/* Informasi Fungsi Poligon */ ""}
              <div class="text-sm text-gray-600 mb-3 leading-tight mb-3 dark:text-gray-300">
                 Berikut adalah <b>batas wilayah atau area seleksi</b> yang telah Anda tentukan. Semua data yang diproses atau ditampilkan akan merujuk pada area di dalam batas ini.
              </div>

              <div class="text-sm text-gray-600 mb-3 leading-tight mb-3 dark:text-gray-300">
                  Silahkan lakukan <b>Filter Data</b> untuk mendapatkan data yang diinginkan.
              </div>

              <button 
                  onclick="window.removeSpecificPolygonManual(this.layerRef)" 
                  class="w-full text-sm font-semibold py-2 px-3 rounded-md 
                        bg-red-500 hover:bg-red-600 text-white 
                        transition duration-150 ease-in-out">
                  Hapus Seleksi Ini
              </button>
          </div>
        `;

        const polygon = L.polygon(drawnLatLngs, {
          color: "#FF5733",
          fillOpacity: 0.3,
          fillColor: "#FF5733",
        })
          .addTo(map)
          .bindPopup(customPopupContent, {
            // Opsi Leaflet untuk popup
            minWidth: 200,
            className: "custom-popup-wilayah-seleksi",
          }); // <-- Baris kunci untuk menambahkan popup

        // **2. Kunci Layer Ref ke tombol:**
        // Setelah layer terikat, kita bisa mengakses elemen popup.
        polygon.on("popupopen", function (e) {
          // Cari tombol "Hapus Seleksi Ini" di dalam popup yang baru terbuka
          const button = e.popup.getElement().querySelector('button[onclick*="removeSpecificPolygonManual"]');
          if (button) {
            // Simpan referensi layer Leaflet ke properti DOM kustom pada tombol
            button.layerRef = polygon;
          }
        });

        allDrawnPolygons.push(polygon);
        updateButtonState();
      }

      drawnLatLngs = [];
    }

    // Gunakan L.Browser.mobile untuk mencegah preventDefault
    // hanya pada perangkat mobile saat drawing mode aktif
    function preventDefaultScroll(e) {
      if (isDrawingModeToggle && L.Browser.mobile) {
        e.preventDefault();
      }
    }

    // Lepaskan event listener preventDefaultScroll saat keluar mode
    function toggleDrawingMode(e) {
      if (e && e.originalEvent) {
        L.DomEvent.preventDefault(e.originalEvent);
      }

      if (currentDrawnLayer) {
        map.removeLayer(currentDrawnLayer);
        currentDrawnLayer = null;
      }

      isDrawingModeToggle = !isDrawingModeToggle;

      if (isDrawingModeToggle) {
        // ENTER DRAWING MODE
        if (e && e.latlng) {
          createAnalysisWave(e.latlng);
        } else {
          createAnalysisWave(map.getCenter());
        }
        document.getElementById("map").classList.add("map-zoom-effect");

        document.getElementById("map").classList.add("drawing-active");
        // KUNCI PERBAIKAN: Nonaktifkan dragging dan tap
        map.dragging.disable();
        if (map.tap && map.tap.disable) map.tap.disable();

        // Tambahkan listener `touchmove` untuk mencegah scrolling/dragging
        document.getElementById("map").addEventListener("touchmove", preventDefaultScroll, { passive: false });

        setTimeout(() => {
          if (isDrawingModeToggle) {
            document.getElementById("map").classList.add("drawing-active-grid");
          }
          document.getElementById("map").classList.remove("map-zoom-effect");
        }, 300);
      } else {
        if (e && e.latlng) {
          createAnalysisWaveReverse(e.latlng);
        } else {
          createAnalysisWaveReverse(map.getCenter());
        }
        document.getElementById("map").classList.add("map-zoom-effect");

        setTimeout(() => {
          document.getElementById("map").classList.remove("drawing-active");
          document.getElementById("map").classList.remove("drawing-active-grid");

          document.getElementById("map").classList.remove("map-zoom-effect");
        }, 300);

        // KUNCI PERBAIKAN: Hapus listener `touchmove`
        document.getElementById("map").removeEventListener("touchmove", preventDefaultScroll);

        // KUNCI PERBAIKAN: Aktifkan kembali dragging dan tap
        map.dragging.enable();
        if (map.tap && map.tap.enable) map.tap.enable();
      }

      // Panggil updateButtonState untuk memperbarui tombol toggle
      updateButtonState();
    }

    // Event listeners

    // 2. Memulai/Mengakhiri Mode Gambar melalui tombol baru (Icon)
    document.getElementById("sidebar-menu-button-pilih-wilayah").addEventListener("click", toggleDrawingMode);
    document.getElementById("sidebar-menu-button-mode-cursor").addEventListener("click", toggleDrawingMode);

    // 3. Memulai Gambar menggunakan Native DOM Events
    document.getElementById("map").addEventListener("mousedown", handleNativeDrawStart);
    document.getElementById("map").addEventListener("touchstart", handleNativeDrawStart, { passive: false });

    // fungsi sidebar
    // fungsi sidebar

    document.getElementById("open-sidebar-menu-button").addEventListener("click", () => {
      document.getElementById("sidebar-menu").classList.remove("hidden");
      document.getElementById("sidebar-menu").classList.add("flex");
      document.getElementById("sidebar-menu").classList.add("md:flex");
    });

    document.getElementById("hide-sidebar-button").addEventListener("click", () => {
      document.getElementById("sidebar-menu").classList.add("hidden");
      document.getElementById("sidebar-menu").classList.remove("flex");
      document.getElementById("sidebar-menu").classList.remove("md:flex");
    });

    document.getElementById("sidebar-menu-button-open-about-us").addEventListener("click", () => {
      toggleSidebar("sidebar-content-about-us");
    });

    document.getElementById("sidebar-menu-button-permintaan-kontrakan").addEventListener("click", async () => {
      toggleSidebar("sidebar-content-permintaan-kontrakan");

      if (dataPermintaan.length <= 0) {
        // Panggil fungsi fetch data terlebih dahulu
        await fetchAndProcessDataPermintaan();

        // BARU: Isi dropdown filter kota setelah data dimuat
        populateCityFilter();

        // Setelah dataPermintaan terisi, inisialisasi filter dan dashboard
        filterAndSort();
      }
    });

    document.getElementById("sidebar-menu-button-filter-data").addEventListener("click", () => {
      toggleSidebar("sidebar-content-filter-data");
    });

    document.getElementById("sidebar-menu-button-tampilkan-map").addEventListener("click", () => {
      document.getElementById("map").classList.remove("hidden");
      document.getElementById("list-data-container").classList.add("hidden");
      document.getElementById("sidebar-menu-button-tampilkan-map").classList.add("hidden");
      document.getElementById("sidebar-menu-button-tampilkan-list-data").classList.remove("hidden");
      updateButtonState();
      map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran
      map.fitBounds(markers.getBounds());
    });

    document.getElementById("sidebar-menu-button-tampilkan-list-data").addEventListener("click", () => {
      hideAllSidebars();

      document.getElementById("map").classList.add("hidden");
      document.getElementById("list-data-container").classList.remove("hidden");
      document.getElementById("sidebar-menu-button-tampilkan-map").classList.remove("hidden");
      document.getElementById("sidebar-menu-button-tampilkan-list-data").classList.add("hidden");

      document.getElementById("sidebar-menu-button-pilih-wilayah").classList.add("hidden");
      document.getElementById("sidebar-menu-button-mode-cursor").classList.add("hidden");
    });

    document.getElementById("sidebar-menu-button-open-hasil-AI").addEventListener("click", () => {
      document.getElementById("sidebar-menu-button-open-hasil-AI-indicator").classList.add("hidden");
      toggleSidebar("sidebar-content-asisten-AI");
    });

    document.getElementById("close-button-sidebar-content-about-us").addEventListener("click", function () {
      const leftSidebarContentAboutUs = document.getElementById("sidebar-content-about-us");

      leftSidebarContentAboutUs.classList.add("hidden");
    });

    document.getElementById("close-button-sidebar-content-filter-data").addEventListener("click", function () {
      const leftSidebarContentHasilPindai = document.getElementById("sidebar-content-filter-data");

      leftSidebarContentHasilPindai.classList.add("hidden");
    });

    document.getElementById("clear-Chat-Button").addEventListener("click", function () {
      chatHistory = []; // Clear history for a new request
      document.getElementById("chat-messages").innerHTML = "";
    });

    document.getElementById("close-button-sidebar-content-asisten-AI").addEventListener("click", function () {
      const leftSidebarContentHasilAI = document.getElementById("sidebar-content-asisten-AI");

      leftSidebarContentHasilAI.classList.add("hidden");
    });

    document.getElementById("close-button-sidebar-content-permintaan-kontrakan").addEventListener("click", function () {
      document.getElementById("sidebar-content-permintaan-kontrakan").classList.add("hidden");
    });

    document.getElementById("fullscreen-button").addEventListener("click", function () {
      toggleFullscreen();
    });

    document.getElementById("applyFilterData").addEventListener("click", async (e) => {
      document.getElementById("sidebar-menu-button-filter-indicator").classList.remove("hidden");

      await applyFilter("filter data");

      if (e && e.originalEvent) {
        L.DomEvent.preventDefault(e.originalEvent);
      }

      if (currentDrawnLayer) {
        map.removeLayer(currentDrawnLayer);
        currentDrawnLayer = null;
      }

      if (isDrawingModeToggle) {
        isDrawingModeToggle = false;
        document.getElementById("map").classList.remove("drawing-active");
        document.getElementById("map").classList.remove("drawing-active-grid");

        document.getElementById("map").classList.remove("map-zoom-effect");

        // KUNCI PERBAIKAN: Hapus listener `touchmove`
        document.getElementById("map").removeEventListener("touchmove", preventDefaultScroll);

        // KUNCI PERBAIKAN: Aktifkan kembali dragging dan tap
        map.dragging.enable();
        if (map.tap && map.tap.enable) map.tap.enable();

        // Panggil updateButtonState untuk memperbarui tombol toggle
        updateButtonState();
      }
    });

    document.getElementById("resetFilterData").addEventListener("click", () => {
      document.getElementById("sidebar-menu-button-filter-indicator").classList.add("hidden");
      hideAllSidebars();

      inputIds.forEach((id) => {
        document.getElementById(id).value = "";
        localStorage.removeItem(id);
      });
      DisplayNewMarkers();
    });

    document.getElementById("filter_harga_min_properti").addEventListener("input", function () {
      formatRupiah(this);
    });

    document.getElementById("filter_harga_max_properti").addEventListener("input", function () {
      formatRupiah(this);
    });

    document.getElementById("send-button").addEventListener("click", sendMessage);

    document.getElementById("search-input").addEventListener("keyup", function () {
      // Panggil fungsi yang sebelumnya ada di onkeyup
      filterAndSort();
    });

    document.getElementById("city-select").addEventListener("change", function () {
      // Panggil fungsi yang sebelumnya ada di onkeyup
      filterAndSort();
    });

    document.getElementById("sort-select").addEventListener("change", function () {
      // Panggil fungsi yang sebelumnya ada di onkeyup
      filterAndSort();
    });

    // --- Fungsi Bantuan untuk Menangani Klik ---
    /**
     * Menangani klik tombol refresh, memanggil fungsi fetch, dan mengelola ikon loading.
     * @param {string} dataType - Deskripsi data (misalnya: 'Permintaan' atau 'Ketersediaan').
     * @param {HTMLElement} button - Elemen tombol yang diklik.
     */
    async function handleRefreshClick(dataType, button) {
      const icon = button.querySelector("i");

      icon.classList.add("fa-spin");

      button.disabled = true; // Nonaktifkan tombol selama proses

      try {
        // Logika spesifik untuk mengolah data di UI
        if (dataType === "Permintaan") {
          // TODO: Panggil fungsi untuk menampilkan data permintaan ke list (misalnya: updatePermintaanList(data))
          await fetchAndProcessDataPermintaan();
          // BARU: Isi dropdown filter kota setelah data dimuat
          populateCityFilter();

          // Setelah dataPermintaan terisi, inisialisasi filter dan dashboard
          filterAndSort();
        } else if (dataType === "Ketersediaan") {
          // TODO: Panggil fungsi untuk memperbarui ringkasan ketersediaan (misalnya: updateKetersediaanSummary(data))
          document.getElementById("stopwatch").textContent = "00:00:00";

          document.getElementById("data-loading-spinner").style.display = "block";
          document.getElementById("list-data-content-section").style.display = "none";

          timer();

          await fetchAndProcessDataKontrakan();
        }
      } catch (error) {
        console.error(`Gagal memuat ulang data ${dataType}.`, error);
      } finally {
        // 3. Sembunyikan indikator loading dan aktifkan kembali tombol
        icon.classList.remove("fa-spin");
        button.disabled = false;

        if (dataType === "Ketersediaan") {
          // TODO: Panggil fungsi untuk memperbarui ringkasan ketersediaan (misalnya: updateKetersediaanSummary(data))
          document.getElementById("data-loading-spinner").style.display = "none";
          document.getElementById("list-data-content-section").style.display = "block";

          clearTimeout(t);

          seconds = 0;
          minutes = 0;
          hours = 0;
        }
      }
    }

    // --- 2. Tambahkan Event Listener ke Tombol Permintaan ---
    document.getElementById("refresh-data-permintaan-button").addEventListener("click", function () {
      handleRefreshClick("Permintaan", document.getElementById("refresh-data-permintaan-button"));
    });

    // --- 3. Tambahkan Event Listener ke Tombol Ketersediaan ---
    document.getElementById("refresh-data-kontrakan-button").addEventListener("click", function () {
      handleRefreshClick("Ketersediaan", document.getElementById("refresh-data-kontrakan-button"));
    });

    function getCombinedBounds() {
      // Inisialisasi featureGroup
      const featureGroup = L.featureGroup();

      // Iterasi seluruh item di allDrawnPolygons
      for (const layer of allDrawnPolygons) {
        // Cek apakah layer adalah L.GeoJSON (layer grup)
        if (layer instanceof L.GeoJSON) {
          // Jika GeoJSON, tambahkan SEMUA sub-layer-nya ke featureGroup
          layer.eachLayer(function (subLayer) {
            featureGroup.addLayer(subLayer);
          });
        } else if (layer instanceof L.Polygon) {
          // Jika L.Polygon (dari gambar manual), tambahkan langsung
          featureGroup.addLayer(layer);
        }
        // Abaikan layer lain yang mungkin tidak memiliki bounds (misalnya L.Marker)
      }

      // Periksa apakah ada layer yang berhasil ditambahkan
      if (featureGroup.getLayers().length === 0) {
        // Jika kosong, kembalikan bounds yang tidak valid atau null
        return null;
      }

      // Dapatkan bounds gabungan dari featureGroup
      const combinedBounds = featureGroup.getBounds();

      // Cek apakah bounds valid
      if (combinedBounds.isValid()) {
        return combinedBounds;
      } else {
        return null;
      }
    }

    async function applyFilter(tipe) {
      const filteredMarkers = [];

      if (tipe == "filter data") {
        DisplayNewMarkers();
        await applyFilter("filter wilayah");
        const filterPermintaanUser = document.getElementById("filter_permintaan_user").value;
        const jenisProperti = document.getElementById("jenis-properti").value;
        const jumlahKamarTidurMinimal = document.getElementById("filter_jumlah_kamar_tidur_minimal").value;
        const jumlahKamarTidurMaksimal = document.getElementById("filter_jumlah_kamar_tidur_maksimal").value;
        const jumlahKamarMandiMinimal = document.getElementById("filter_jumlah_kamar_mandi_minimal").value;
        const jumlahKamarMandiMaksimal = document.getElementById("filter_jumlah_kamar_mandi_maksimal").value;
        const minPrice = parseRupiah(document.getElementById("filter_harga_min_properti").value);
        const maxPrice = parseRupiah(document.getElementById("filter_harga_max_properti").value);
        const statusKetersediaan = document.getElementById("status-ketersediaan").value;
        const filterJumlahPeminat = document.getElementById("cari_jumlah_peminat").value;

        await filterAndDisplayMarkers(filterPermintaanUser, jenisProperti, jumlahKamarTidurMinimal, jumlahKamarTidurMaksimal, jumlahKamarMandiMinimal, jumlahKamarMandiMaksimal, minPrice ? parseInt(minPrice) : null, maxPrice ? parseInt(maxPrice) : null, statusKetersediaan, filterJumlahPeminat);

        document.getElementById("sidebar-content-filter-data").classList.add("hidden");
        map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran
        map.fitBounds(markers.getBounds());
      }

      if (tipe == "filter wilayah") {
        // Clear the existing content and markers.
        document.getElementById("list-data-content-section").innerHTML = "";

        // Reset the counters for a new search.
        displayedDataCount = 0;
        filteredProperties = [];

        if (allDrawnPolygons.length > 0) {
          for (const marker of markers.getLayers()) {
            const markerLatLng = marker._latlng;
            let isInsideAnyPolygon = false;

            // Lokasi error: Saat mengiterasi allDrawnPolygons
            for (const layer of allDrawnPolygons) {
              // Cek apakah layer adalah L.GeoJSON (layer yang Anda tambahkan dari req.lokasi_geojson)
              if (layer instanceof L.GeoJSON) {
                // Jika itu L.GeoJSON, kita perlu mengiterasi setiap sub-layer/fitur di dalamnya
                layer.eachLayer(function (polygonFeature) {
                  // Pastikan sub-layer ini adalah Poligon (atau MultiPolygon)
                  if (polygonFeature instanceof L.Polygon) {
                    const polygonLatLngs = polygonFeature.getLatLngs();
                    if (isMarkerInsidePolygon(markerLatLng, polygonLatLngs)) {
                      isInsideAnyPolygon = true;
                      return; // Keluar dari eachLayer
                    }
                  }
                });
              } else if (layer instanceof L.Polygon) {
                // Jika layer adalah L.Polygon biasa (dari gambar manual), gunakan kode lama
                const polygonLatLngs = layer.getLatLngs();
                if (isMarkerInsidePolygon(markerLatLng, polygonLatLngs)) {
                  isInsideAnyPolygon = true;
                }
              }

              if (isInsideAnyPolygon) {
                break; // Keluar dari loop for (const layer of allDrawnPolygons)
              }
            }

            if (isInsideAnyPolygon) {
              filteredProperties.push(marker._propertyData);
              filteredMarkers.push(marker);
              createClickEventMarker(marker, marker._propertyData);
            }
          }

          markers.clearLayers();

          if (filteredMarkers.length > 0) {
            markers.addLayers(filteredMarkers);
          }

          document.getElementById("list-data-jumlah-data").innerHTML = filteredProperties.length;
          // Now, render the initial set of data.
          filteredProperties = await sortKontrakan("terbaru");
          renderMoreData();

          // Attach the scroll listener to handle loading more data.
          const listDataContent = document.getElementById("list-data-container");
          listDataContent.addEventListener("scroll", handleScroll);

          document.getElementById("sidebar-content-filter-data").classList.add("hidden");
          map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran

          // Cara Penggunaan:
          const combinedBounds = getCombinedBounds();

          if (combinedBounds) {
            // Lakukan flyTo/fitBounds ke batas gabungan
            map.flyToBounds(combinedBounds, { padding: [20, 20] });
          } else {
            Swal.fire({
              title: "Error!",
              text: "Tidak ada poligon yang valid untuk menentukan batas.",
              icon: "error",
              confirmButtonText: "OK",
            });
            // map.setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);
          }
        }
      }
    }

    function startStopwatchDisplay() {
      // Dapatkan referensi ke elemen stopwatch setelah ditambahkan ke DOM
      const stopwatchDisplay = document.getElementById("ai-processing-stopwatch");
      // Catat waktu mulai pemrosesan
      startTime = Date.now();
      // Mulai stopwatch
      stopwatchInterval = setInterval(() => {
        if (stopwatchDisplay && startTime) {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          stopwatchDisplay.textContent = `(${elapsed}s)`;
        }
      }, 100); // Perbarui setiap 100 milidetik (0.1 detik)
    }

    function stopStopwatchDisplay() {
      // Hentikan stopwatch
      clearInterval(stopwatchInterval);
      stopwatchInterval = null; // Reset interval ID
      startTime = null; // Reset startTime
    }

    function pushLoadingMessage() {
      const chatMessagesContainer = document.getElementById("chat-messages");
      const aiResponseDiv = document.createElement("div");
      aiResponseDiv.className = "temp-loading-message flex justify-start";
      aiResponseDiv.innerHTML = `
                <div class="max-w-[80%] rounded-xl bg-gray-200 p-3 text-gray-800 shadow-sm dark:bg-gray-700 dark:text-gray-100">
                  <!-- Alternatif dengan animasi dots yang lebih halus -->
                  <div class="flex w-full items-center">
                    <div class="typing-dots mr-2 flex space-x-1">
                      <div class="dot-1 h-2 w-2 rounded-full bg-gray-500"></div>
                      <div class="dot-2 h-2 w-2 rounded-full bg-gray-500"></div>
                      <div class="dot-3 h-2 w-2 rounded-full bg-gray-500"></div>
                    </div>
                    <span>Memproses permintaan Anda...</span>
                  </div>
                  <span id="ai-processing-stopwatch" class="stopwatch-display text-sm"></span>
                </div>
            `;
      chatMessagesContainer.appendChild(aiResponseDiv);
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    }

    function popLoadingMessage() {
      document.getElementById("chat-messages").querySelector(".temp-loading-message").remove();
    }

    function disabledSendButton() {
      document.getElementById("send-button").disabled = true;
      document.getElementById("send-button").classList.remove("bg-blue-500", "hover:bg-blue-600");
      document.getElementById("send-button").classList.add("bg-gray-200");
    }

    function enabledSendButton() {
      document.getElementById("send-button").disabled = false;
      document.getElementById("send-button").classList.add("bg-blue-500", "hover:bg-blue-600");
      document.getElementById("send-button").classList.remove("bg-gray-200");
    }

    async function sendMessage() {
      const message = document.getElementById("user-chat-textarea").value.trim();
      // Kosongkan input setelah pesan terkirim
      document.getElementById("user-chat-textarea").value = "";

      if (message) {
        const chatMessagesContainer = document.getElementById("chat-messages");

        // Tampilkan pesan pengguna
        const userMessageDiv = document.createElement("div");
        userMessageDiv.className = "flex justify-end";
        userMessageDiv.innerHTML = `
            <div class="rounded-xl bg-blue-100 p-3 text-black shadow-sm dark:bg-blue-800 dark:text-white">
                ${message}
            </div>
        `;
        chatMessagesContainer.appendChild(userMessageDiv);
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

        pushLoadingMessage();
        startStopwatchDisplay();
        disabledSendButton();

        // Tunggu (await) respons dari AI
        try {
          // Pastikan fungsi getPropertyRecommendationsFromAI adalah async
          const pesanAI = await getPropertyRecommendationsFromAI(message);

          popLoadingMessage();
          stopStopwatchDisplay();
          enabledSendButton();

          // Tampilkan respons AI setelah Promise selesai
          const aiResponseDiv = document.createElement("div");
          aiResponseDiv.className = "flex justify-start";
          aiResponseDiv.innerHTML = `
                <div class="ai-icon">
                  <svg class="w-5 fill-blue-500 pt-[2px] dark:fill-blue-300" fill-rule="evenodd" style="flex: none; line-height: 1" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
                    <title>Gemini</title>
                    <path d="M20.616 10.835a14.147 14.147 0 01-4.45-3.001 14.111 14.111 0 01-3.678-6.452.503.503 0 00-.975 0 14.134 14.134 0 01-3.679 6.452 14.155 14.155 0 01-4.45 3.001c-.65.28-1.318.505-2.002.678a.502.502 0 000 .975c.684.172 1.35.397 2.002.677a14.147 14.147 0 014.45 3.001 14.112 14.112 0 013.679 6.453.502.502 0 00.975 0c.172-.685.397-1.351.677-2.003a14.145 14.145 0 013.001-4.45 14.113 14.113 0 016.453-3.678.503.503 0 000-.975 13.245 13.245 0 01-2.003-.678z"></path>
                  </svg>
                </div>

                <div class="ml-3">
                  <div class="rounded-xl bg-white p-3 text-gray-800 shadow-sm dark:bg-gray-700 dark:text-gray-100">
                    ${marked.parse(pesanAI)}
                  </div>
                </div> 
            `;
          chatMessagesContainer.appendChild(aiResponseDiv);
          chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

          document.getElementById("sidebar-menu-button-open-hasil-AI-indicator").classList.remove("hidden");
        } catch (error) {
          // Tangani jika terjadi error saat memanggil API
          const errorDiv = document.createElement("div");
          errorDiv.className = "flex justify-start";
          errorDiv.innerHTML = `
                <div class="bg-red-100 text-red-800 p-3 rounded-xl rounded-bl-none shadow-sm max-w-[80%]">
                    Maaf, terjadi kesalahan saat memuat respons. Error fetching AI response: ${error}
                </div>
            `;
          chatMessagesContainer.appendChild(errorDiv);
          chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
      }
    }
    // Daftar ID elemen input yang ingin disimpan
    const inputIds = ["filter_permintaan_user", "filter_jumlah_kamar_tidur_minimal", "filter_jumlah_kamar_tidur_maksimal", "filter_jumlah_kamar_mandi_minimal", "filter_jumlah_kamar_mandi_maksimal", "filter_harga_min_properti", "filter_harga_max_properti", "cari_jumlah_peminat"];

    // Simpan input teks ke localStorage saat berubah
    inputIds.forEach((id) => {
      const input = document.getElementById(id);
      if (input) {
        // Ambil dari localStorage saat halaman dimuat
        input.value = localStorage.getItem(id) || "";

        // Simpan ke localStorage saat ada perubahan
        input.addEventListener("input", () => {
          localStorage.setItem(id, input.value);
        });
      }
    });

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        // Masuk ke mode fullscreen
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen();
        } else if (document.documentElement.webkitRequestFullscreen) {
          /* Safari */
          document.documentElement.webkitRequestFullscreen();
        } else if (document.documentElement.msRequestFullscreen) {
          /* IE11 */
          document.documentElement.msRequestFullscreen();
        }
      } else {
        // Keluar dari mode fullscreen
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          /* Safari */
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          /* IE11 */
          document.msExitFullscreen();
        }
      }
    }

    function encodeToBase64(textString) {
      try {
        return btoa(
          encodeURIComponent(textString).replace(/%([0-9A-F]{2})/g, function toSolidBytes(match, p1) {
            return String.fromCharCode("0x" + p1);
          }),
        );
      } catch (e) {
        Swal.fire({
          title: "Error!",
          text: `Terjadi kesalahan saat membaca file: ${e}`,
          icon: "error",
          confirmButtonText: "OK",
        });
        return "Error during Base64 encoding.";
      }
    }

    /**
     * Ekstrak format dan data base64 murni dari string base64 dengan header
     * @param {string} base64WithHeader - String base64 dengan header (contoh: "data:image/jpeg;base64,/9j/4AA...")
     * @returns {object} - Objek berisi format dan data base64 tanpa header
     */
    function extractBase64ImageData(base64WithHeader) {
      // Validasi input
      if (typeof base64WithHeader !== "string" || !base64WithHeader.startsWith("data:image")) {
        throw new Error("Format base64 tidak valid");
      }

      // Pisahkan header dan data
      const [header, base64Data] = base64WithHeader.split(",");

      // Ekstrak format gambar
      const formatMatch = header.match(/data:image\/(\w+);/);
      if (!formatMatch) {
        throw new Error("Format gambar tidak dikenali");
      }

      const format = `image/${formatMatch[1]}`;

      return {
        format: format, // 'image/jpeg' atau 'image/png'
        base64: base64Data, // Data base64 tanpa header
      };
    }

    // Initial chat history for context
    let chatHistory = [];

    /**
     * Initializes the chat history with a greeting and property data.
     * @returns {void}
     */
    function initializeChatHistory(sumberData, fotoRumahData) {
      const csvString = convertToCSV(sumberData);
      const base64EncodedCsv = encodeToBase64(csvString);

      if (fotoRumahData != null && fotoRumahData != "") {
        try {
          const fotoRumahDataExtract = extractBase64ImageData(fotoRumahData);

          chatHistory.push({
            role: "user",
            parts: [
              {
                inlineData: {
                  mimeType: fotoRumahDataExtract.format,
                  data: fotoRumahDataExtract.base64,
                },
              },
            ],
          });
        } catch (error) {
          Swal.fire({
            title: "Error!",
            text: `Terjadi Error: ${error.message}`,
            icon: "error",
            confirmButtonText: "OK",
          });
        }
      }

      chatHistory.push({
        role: "user",
        parts: [
          {
            text: "--- Gunakan Data CSV Terbaru di bawah ini ---",
          },
        ],
      });

      chatHistory.push({
        role: "user",
        parts: [
          {
            inlineData: {
              mimeType: "text/csv",
              data: base64EncodedCsv,
            },
          },
        ],
      });
    }

    /**
     * Sends a prompt to the Gemini API and handles the response.
     * @param {string} userPrompt - The user's input prompt for property recommendations.
     * @returns {Promise<void>}
     */
    async function getPropertyRecommendationsFromAI(permintaanAI) {
      initializeChatHistory(filteredProperties, null); // Re-initialize with current property data

      chatHistory.push({
        role: "user",
        parts: [
          {
            text: `Anda adalah **Maya, Asisten Pencari Kontrakan** yang bertindak sebagai mesin query untuk data kontrakan yang disediakan dalam format CSV. Tugas utama Anda adalah menyaring atau menilai data secara cepat berdasarkan permintaan pengguna. Gunakan kata ganti **"Kamu"** sehingga lebih kasual dan hangat tetapi tetap profesional saat berinteraksi dengan pengguna.

**SUMBER DATA UTAMA (Data CSV):**
* Gunakan hanya kolom **"deskripsi_spesifikasi_kontrakan"** dan **"deskripsi_visual_kontrakan"** untuk pencarian/penilaian.
* **Abaikan sepenuhnya** kolom: "ketersediaan", "foto_kontrakan", "jumlah_peminat", "latitude", dan "longitude".

***

### üéØ TUJUAN RESPON & LOGIKA

**A. TUJUAN 1: PENCARIAN & REKOMENDASI (Jika permintaan = Kriteria Pencarian Umum)**
* **Contoh Permintaan:** "kamar 3 full AC", "cari kontrakan dengan dapur luas".
* **LOGIKA:** Lakukan penyaringan data kontrakan yang sesuai dengan kriteria spesifikasi dan/atau visual yang diminta.
    * Jika kriteria bersifat visual, wajib gunakan data **"deskripsi_visual_kontrakan"**.
    * Jika pengguna melampirkan foto, lakukan **penilaian perbandingan visual** antara foto tersebut dengan **"deskripsi_visual_kontrakan"** dari kontrakan yang direkomendasikan. Penilaian ini harus disertakan dalam \`alasan_rekomendasi\`.
* **OUTPUT:** Berikan respons dalam format JSON **TUJUAN 1**.

**B. TUJUAN 2: PENILAIAN SPESIFIK (Jika permintaan = Menilai Nomor Kontrakan Tertentu)**
* **Contoh Permintaan:** "bagaimana kondisi rumah kontrakan 205", "nilai visual kontrakan nomor 11".
* **LOGIKA:** Identifikasi nomor kontrakan yang diminta dan berikan penilaian objektif berdasarkan **"deskripsi_spesifikasi_kontrakan"** dan **"deskripsi_visual_kontrakan"** (jika tersedia) dari data tersebut.
* **OUTPUT:** Berikan respons dalam format JSON **TUJUAN 2**.

***

### üìù FORMAT RESPON JSON (Wajib Ditaati)

**1. FORMAT JSON TUJUAN 1 (Pencarian/Rekomendasi):**
* **Selalu berikan respons dalam array JSON dengan format berikut.**
* **Element 'pesan'** wajib berisi:
    * Instruksi untuk melihat hasil di fitur map/daftar pada website ini (jika ada rekomendasi).
    * Permohonan maaf (jika tidak ditemukan rekomendasi).

\`\`\`json
[
  {
    "pesan": "Di sini terdapat instruksi untuk melihat hasil di map atau daftar di website. (Jika tidak ada rekomendasi, sampaikan permohonan maaf)."
  },
  {
    "nomer": "[NOMER DATA]",
    "alasan_rekomendasi": "[Mengapa data ini direkomendasikan dan penilaian perbandingan visual (jika ada foto terlampir)]."
  },
  {
    "nomer": "[NOMER DATA N]",
    "alasan_rekomendasi": "[Alasan...]"
  }
]
\`\`\`

**2. FORMAT JSON TUJUAN 2 (Penilaian Spesifik):**
* **Selalu berikan respons dalam array JSON dengan satu objek 'pesan' saja.**

\`\`\`json
[
  {
    "pesan": "Sampaikan hasil penilaian objektif untuk kontrakan yang diminta di sini."
  }
]
\`\`\`

***

**INSTRUKSIN PENTING:**
* **JANGAN** pernah memberikan teks atau penjelasan tambahan di luar struktur JSON di atas.
* **JANGAN** pernah menyertakan penjelasan tentang logika kerja Anda.
* Gunakan format teks markdown atau HTML untuk element "pesan" di dalam respon format respon JSON supaya teksnya lebih bagus, lebih rapi, mudah dibaca, lebih profesional dan lebih mudah dipahami pengguna.

**Permintaan atau kebutuhan saya:**
${permintaanAI}
`,
          },
        ],
      });

      try {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiAPIKey}`;

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: chatHistory,
            generationConfig: {
              responseMimeType: "text/plain",
              thinkingConfig: {
                thinkingBudget: 0,
              },
            },
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API error: ${response.status} - ${errorData.error.message || "Unknown error"}`);
        }

        const result = await response.json();
        const aiResponseText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (aiResponseText) {
          const jsonResponse = parseJsonResponse(aiResponseText);
          const dataResponse = processData(jsonResponse, markersProperti);
          const pesanAI = dataResponse.pesan;

          if (dataResponse.markers.length > 0) {
            displayMarkersByArrayObject(dataResponse.markers);
            map.invalidateSize(); // Ini penting agar leaflet menyesuaikan ukuran
            map.fitBounds(markers.getBounds());
          }

          chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
          return pesanAI;
        } else {
          return "AI Model: Could not generate a response or unexpected API response structure.\nUnexpected API response structure:", result;
        }
      } catch (error) {
        return `Error calling Gemini API: ${error.message}`;
      } finally {
      }
    }

    /**
     * Extracts and parses a JSON object from a given text string.
     * It looks for a JSON block enclosed in ```json\n...\n```.
     * @param {string} text - The input text potentially containing a JSON block.
     * @returns {Array<Object>|null} The parsed JSON object, or null if no valid JSON block is found or parsing fails.
     */
    function parseJsonResponse(text) {
      const jsonBlockRegex = /```json\n((?:.|\n)*?)\n```/;
      const match = text.match(jsonBlockRegex);

      if (match && match[1]) {
        try {
          return JSON.parse(match[1]);
        } catch (error) {
          Swal.fire({
            title: "Error!",
            text: `Error parsing JSON from AI response: ${error.message}`,
            icon: "error",
            confirmButtonText: "OK",
          });
          return null;
        }
      } else {
        Swal.fire({
          title: "Error!",
          text: `No valid JSON block found in the AI response text.`,
          icon: "error",
          confirmButtonText: "OK",
        });
        return null;
      }
    }

    function processData(responseData, markersProperti) {
      // Pastikan responseData adalah array dan memiliki setidaknya satu elemen
      if (!Array.isArray(responseData) || responseData.length === 0) {
        Swal.fire({
          title: "Error!",
          text: `Data response tidak valid atau kosong.`,
          icon: "error",
          confirmButtonText: "OK",
        });
        return { pesan: null, rekomendasi: [], markers: [] };
      }

      // Pisahkan pesan (elemen pertama) dan data rekomendasi (sisa elemen)
      const pesan = responseData[0].pesan.replace(/"/g, "&quot;").replace(/'/g, "&#39;").replace(/`/g, " ");
      const dataRekomendasi = responseData.slice(1);

      // Array untuk menyimpan marker yang cocok
      const markersRekomendasi = [];

      // Cocokkan data rekomendasi dengan data marker
      dataRekomendasi.forEach((rekomendasi) => {
        // Cari marker yang "nomer"-nya cocok dengan "nomer" dari rekomendasi
        const markerCocok = markersProperti.data_kontrakan.find((marker) => marker.nomer == rekomendasi.nomer);

        // Jika marker ditemukan, tambahkan informasi rekomendasi ke marker
        if (markerCocok) {
          // Duplikasi objek marker agar tidak memodifikasi data asli
          const markerDenganRekomendasi = { ...markerCocok, alasan_rekomendasi: rekomendasi.alasan_rekomendasi.replace(/"/g, "&quot;").replace(/'/g, "&#39;").replace(/`/g, " ") };
          markersRekomendasi.push(markerDenganRekomendasi);
        }
      });

      return {
        pesan: pesan,
        rekomendasi: dataRekomendasi,
        markers: markersRekomendasi,
      };
    }

    /**
     * Converts an array of objects into a CSV string.
     * @param {Array<Object>} data - The array of data to convert.
     * @returns {string} The CSV formatted string.
     */
    function convertToCSV(data) {
      if (!data || data.length === 0) {
        return "";
      }

      const headers = Object.keys(data[0]);
      const csvRows = [
        headers.join(","), // CSV Header
        ...data.map((row) =>
          headers
            .map((fieldName) => {
              const value = row[fieldName];
              // Handle values that might contain commas or newlines by enclosing them in double quotes
              if (value === null || value === undefined) {
                return "";
              }
              const stringValue = String(value);
              if (stringValue.includes(",") || stringValue.includes("\n") || stringValue.includes('"')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
              }
              return stringValue;
            })
            .join(","),
        ),
      ];

      return csvRows.join("\n");
    }

    /**
     * Encodes a string to Base64.
     * @param {string} str - The string to encode.
     * @returns {string} The Base64 encoded string.
     */
    function encodeToBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    fetchAndProcessDataKontrakan();
  </script>
</html>
